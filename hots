#!/bin/bash

# Heroes of Time - Script de contr√¥le principal
# Usage: ./hots [start|stop|status|restart|test|help]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICES_SCRIPT="$SCRIPT_DIR/scripts/actifs/start-services-background.sh"
STOP_SCRIPT="$SCRIPT_DIR/scripts/actifs/stop-all-services.sh"

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${CYAN}üéÆ Heroes of Time - Contr√¥le des services${NC}"
    echo -e "${CYAN}=========================================${NC}"
    echo ""
    echo -e "${GREEN}Usage:${NC} ./hots [commande] [options]"
    echo ""
    echo -e "${YELLOW}Commandes disponibles:${NC}"
    echo -e "  ${GREEN}start${NC}       D√©marre tous les services en arri√®re-plan"
    echo -e "  ${GREEN}start essential${NC} üéØ D√©marre services essentiels seulement (Backend + Frontend + Dashboard)"
    echo -e "  ${GREEN}stop${NC}        Arr√™te tous les services"
    echo -e "  ${GREEN}restart${NC}     Red√©marre tous les services"
    echo -e "  ${GREEN}status${NC}      Affiche le statut des services"
    echo -e "  ${GREEN}test${NC}        Lance les tests (voir options ci-dessous)"
    echo -e "  ${GREEN}generate${NC}    üß† G√©n√®re la documentation MD depuis JSON (Memento)"
    echo -e "  ${GREEN}map${NC}         üó∫Ô∏è  Gestion des maps et terrains"
    echo -e "  ${GREEN}replay${NC}      üìπ Syst√®me de replay des parties"
    echo -e "  ${GREEN}editor${NC}      üé® √âditeur visuel script spatio-temporel"
    echo -e "  ${GREEN}admin${NC}       üéÆ Interface d'administration multijoueur"
    echo -e "  ${GREEN}test-uis${NC}    üß™ Test complet de toutes les UIs"
    echo -e "  ${GREEN}debug${NC}       üêõ Mode debug complet (compilation + logs)"
    echo -e "  ${GREEN}compile${NC}     üîß Compilation backend avec debug info"
    echo -e "  ${GREEN}logs${NC}        üìã Affiche les logs en temps r√©el"
    echo -e "  ${GREEN}scenario${NC}    üé¨ Lance un sc√©nario HEP (Heroes Epic Play)"
    echo -e "  ${GREEN}vince${NC}       üî´ Vince Process Annihilator - Nettoie les process avec style!"
    echo -e "  ${GREEN}walter${NC}      üé≥ Walter Anti-Vince Protocol - Protection backend"
    echo -e "  ${GREEN}help${NC}        Affiche cette aide"
    echo ""
    echo -e "${YELLOW}Options de test:${NC}"
    echo -e "  ${GREEN}./hots test${NC}              Tests complets (d√©faut)"
    echo -e "  ${GREEN}./hots test quick${NC}        Tests rapides (1-2 min)"
    echo -e "  ${GREEN}./hots test ui${NC}           Tests interfaces utilisateur"
    echo -e "  ${GREEN}./hots test backend${NC}      Tests backend uniquement"
    echo -e "  ${GREEN}./hots test maven${NC}        Tests Maven compilation/build"
    echo -e "  ${GREEN}./hots test demo${NC}         D√©monstrations interactives"
    echo -e "  ${GREEN}./hots test bataille${NC}     Tests bataille temporelle"
    echo -e "  ${GREEN}./hots test quantum${NC}      Tests quantum/visualiseurs"
    echo -e "  ${GREEN}./hots test scenarios${NC}    Tests sc√©narios HOTS complets"
    echo -e "  ${GREEN}./hots test json${NC}         üöÄ Tests nouveaux scripts JSON (HSP)"
    echo -e "  ${GREEN}./hots test jean-gros${NC}    üé≥ Tests Jean-Gros v2/v3 complets"
    echo -e "  ${GREEN}./hots test decay${NC}        üåÄ Tests syst√®me DK20 Temporal Decay (Anna)"
    echo -e "  ${GREEN}./hots test hybrid${NC}       üé≥ Tests syst√®me Hybrid Decay (The Dude)"
    echo -e "  ${GREEN}./hots test missing${NC}      üéØ Tests sc√©narios manquants et cr√©atures"
    echo -e "  ${GREEN}./hots test creatures${NC}    üêâ Tests sp√©cifiques des cr√©atures quantiques"
    echo -e "  ${GREEN}./hots test performance${NC}  Tests de performance"
    echo -e "  ${GREEN}./hots test integration${NC}  Tests d'int√©gration compl√®te"
    echo -e "  ${GREEN}./hots test report${NC}       Rapport complet des tests"
    echo -e "  ${GREEN}./hots test final${NC}        üèÜ TOUS LES TESTS (complet)"
    echo -e "  ${GREEN}./hots test list${NC}         Liste tous les tests disponibles"
    echo ""
    echo -e "${YELLOW}Exemples:${NC}"
    echo -e "  ${CYAN}./hots start${NC}             # D√©marre tout"
    echo -e "  ${CYAN}./hots status${NC}            # V√©rifie l'√©tat"
    echo -e "  ${CYAN}./hots test quick${NC}        # Tests rapides"
    echo -e "  ${CYAN}./hots test maven${NC}        # Test compilation backend"
    echo -e "  ${CYAN}./hots test final${NC}        # üèÜ TEST COMPLET FINAL"
    echo -e "  ${CYAN}./hots test report${NC}       # Rapport d√©taill√©"
    echo -e "  ${CYAN}./hots debug${NC}             # üêõ Mode debug complet"
    echo -e "  ${CYAN}./hots compile${NC}           # üîß Compilation avec debug"
    echo -e "  ${CYAN}./hots logs${NC}              # üìã Logs en temps r√©el"
    echo -e "  ${CYAN}./hots generate${NC}          # üß† G√©n√®re tous les MD depuis JSON"
    echo -e "  ${CYAN}./hots map list${NC}          # üó∫Ô∏è  Liste les maps disponibles"
    echo -e "  ${CYAN}./hots replay center${NC}     # üé¨ Centre de Replay complet"
    echo -e "  ${CYAN}./hots scenario list${NC}     # üé¨ Liste les sc√©narios HEP disponibles"
    echo -e "  ${CYAN}./hots scenario bataille${NC} # üé¨ Lance bataille temporelle HOTS"
    echo -e "  ${CYAN}./hots scenario anthor${NC}   # üé¨ Lance duel Anthor vs Grofi"
    echo -e "  ${CYAN}./hots editor${NC}            # üé® Lance l'√©diteur visuel"
    echo -e "  ${CYAN}./hots vince${NC}             # üî´ Nettoie les process lents (animation ROFL)"
    echo -e "  ${CYAN}./hots walter${NC}            # üé≥ Protection backend Anti-Vince"
    echo ""
    echo -e "${PURPLE}üíæ Commandes de Persistence:${NC}"
    echo -e "  ${GREEN}save${NC} <nom> [game_id] [player]  Sauvegarder la partie"
    echo -e "  ${GREEN}load${NC} <id> [player]            Charger une sauvegarde"
    echo -e "  ${GREEN}list-saves${NC} [player]           Lister les sauvegardes"
    echo ""
    echo -e "${YELLOW}Exemples persistence:${NC}"
    echo -e "  ${CYAN}./hots save ma-partie${NC}        # Sauvegarder la partie courante"
    echo -e "  ${CYAN}./hots load 1${NC}                # Charger la sauvegarde ID 1"
    echo -e "  ${CYAN}./hots list-saves${NC}            # Voir toutes les sauvegardes"
}

check_services() {
    local services_found=0
    
    # V√©rifier chaque port
    if lsof -i :9000 >/dev/null 2>&1; then
        echo -e "  ‚úÖ Dashboard (9000) - ACTIF"
        ((services_found++))
    else
        echo -e "  ‚ùå Dashboard (9000) - ARR√äT√â"
    fi
    
    if lsof -i :8000 >/dev/null 2>&1; then
        echo -e "  ‚úÖ Frontend (8000) - ACTIF"
        ((services_found++))
    else
        echo -e "  ‚ùå Frontend (8000) - ARR√äT√â"
    fi
    
    if lsof -i :8080 >/dev/null 2>&1; then
        echo -e "  ‚úÖ Backend API (8080) - ACTIF"
        ((services_found++))
    else
        echo -e "  ‚ùå Backend API (8080) - ARR√äT√â"
    fi
    
    if lsof -i :5174 >/dev/null 2>&1; then
        echo -e "  ‚úÖ Temporal (5174) - ACTIF"
        ((services_found++))
    else
        echo -e "  ‚ùå Temporal (5174) - ARR√äT√â"
    fi
    
    if lsof -i :8001 >/dev/null 2>&1; then
        echo -e "  ‚úÖ Quantum (8001) - ACTIF"
        ((services_found++))
    else
        echo -e "  ‚ùå Quantum (8001) - ARR√äT√â"
    fi
    
    if lsof -i :5175 >/dev/null 2>&1; then
        echo -e "  ‚úÖ Visualizer (5175) - ACTIF"
        ((services_found++))
    else
        echo -e "  ‚ùå Visualizer (5175) - ARR√äT√â"
    fi
    
    if lsof -i :8888 >/dev/null 2>&1; then
        echo -e "  ‚úÖ Test Runner (8888) - ACTIF"
        ((services_found++))
    else
        echo -e "  ‚ùå Test Runner (8888) - ARR√äT√â"
    fi
    
    return $services_found
}

show_status() {
    echo -e "${BLUE}üîç Statut des services Heroes of Time${NC}"
    echo "===================================="
    check_services
    local active_services=$?
    
    echo ""
    echo "URLs d'acc√®s:"
    echo -e "  üéØ Dashboard + üé¨ Replay: ${CYAN}http://localhost:9000/dashboard.html${NC}"
    echo -e "  üìä Frontend Principal: ${CYAN}http://localhost:8000${NC}"
    echo -e "  ‚öôÔ∏è Backend API: ${CYAN}http://localhost:8080/api/health${NC}"
    echo -e "  ‚öîÔ∏è Interface Temporelle: ${CYAN}http://localhost:5174${NC}"
    echo -e "  üåå Quantum Visualizer: ${CYAN}http://localhost:8001${NC}"
    echo -e "  üîÆ Collection & Grammar: ${CYAN}http://localhost:5175${NC}"
    echo -e "  üß™ Test Runner: ${CYAN}http://localhost:8888${NC}"
    echo ""
    echo -e "  ${YELLOW}üí° Centre de Replay:${NC} ${CYAN}./hots replay center${NC} ou clic sur üé¨ dans Dashboard"
    
    echo ""
    # üé≥ WALTER'S ANTI-SCHR√ñDINGER FIX - LOGIC BINAIRE PURE !
    if [ $active_services -eq 7 ]; then
        echo -e "${GREEN}üé≥ WALTER: TOUS LES SERVICES SONT VRAIMENT ACTIFS ! ($active_services/7)${NC}"
    elif [ $active_services -gt 4 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  WALTER: SERVICES PARTIELLEMENT ACTIFS ($active_services/7) - ACCEPTABLE${NC}"
    else
        echo -e "${RED}üö® WALTER: SERVICES EN PANNE ! ($active_services/7) - INACCEPTABLE !${NC}"
    fi
}

start_services() {
    echo -e "${BLUE}üöÄ D√©marrage des services Heroes of Time${NC}"
    echo "========================================"
    
    if [ -f "$SERVICES_SCRIPT" ]; then
        bash "$SERVICES_SCRIPT"
        echo ""
        echo -e "${GREEN}‚úÖ Services lanc√©s en arri√®re-plan${NC}"
        echo -e "${YELLOW}üí° Utilisez './hots status' pour v√©rifier l'√©tat${NC}"
    else
        echo -e "${RED}‚ùå Script de d√©marrage non trouv√©: $SERVICES_SCRIPT${NC}"
        return 1
    fi
}

start_essential_services() {
    echo -e "${BLUE}üéØ D√©marrage des services essentiels Heroes of Time${NC}"
    echo "=================================================="
    echo -e "${YELLOW}Services essentiels : Backend + Frontend + Dashboard${NC}"
    echo ""
    
    # D√©marrer le backend
    echo -e "${CYAN}‚öôÔ∏è  D√©marrage du Backend (port 8080)...${NC}"
    if [ -d "backend" ]; then
        cd backend
        if mvn spring-boot:run -q > backend.log 2>&1 &
        then
            echo -e "${GREEN}‚úÖ Backend d√©marr√©${NC}"
            cd ..
        else
            echo -e "${RED}‚ùå Erreur d√©marrage backend${NC}"
            cd ..
            return 1
        fi
    else
        echo -e "${RED}‚ùå Dossier backend non trouv√©${NC}"
        return 1
    fi
    
    # Attendre que le backend soit pr√™t
    echo -e "${YELLOW}‚è≥ Attente du d√©marrage backend...${NC}"
    sleep 10
    
    # D√©marrer le frontend
    echo -e "${CYAN}üéÆ D√©marrage du Frontend (port 8000)...${NC}"
    if [ -d "frontend" ]; then
        cd frontend
        if python3 -m http.server 8000 > frontend.log 2>&1 &
        then
            echo -e "${GREEN}‚úÖ Frontend d√©marr√©${NC}"
            cd ..
        else
            echo -e "${RED}‚ùå Erreur d√©marrage frontend${NC}"
            cd ..
            return 1
        fi
    else
        echo -e "${RED}‚ùå Dossier frontend non trouv√©${NC}"
        return 1
    fi
    
    # D√©marrer le dashboard
    echo -e "${CYAN}üéØ D√©marrage du Dashboard (port 9000)...${NC}"
    if [ -f "dashboard.html" ]; then
        if python3 -m http.server 9000 > dashboard.log 2>&1 &
        then
            echo -e "${GREEN}‚úÖ Dashboard d√©marr√©${NC}"
        else
            echo -e "${RED}‚ùå Erreur d√©marrage dashboard${NC}"
            return 1
        fi
    else
        echo -e "${RED}‚ùå Fichier dashboard.html non trouv√©${NC}"
        return 1
    fi
    
    echo ""
    echo -e "${GREEN}‚úÖ Services essentiels d√©marr√©s !${NC}"
    echo -e "${YELLOW}üåê URLs d'acc√®s :${NC}"
    echo -e "  üéØ Dashboard : ${CYAN}http://localhost:9000/dashboard.html${NC}"
    echo -e "  üéÆ Frontend : ${CYAN}http://localhost:8000${NC}"
    echo -e "  ‚öôÔ∏è  Backend API : ${CYAN}http://localhost:8080/api/health${NC}"
    echo ""
    echo -e "${YELLOW}üí° Pour d√©marrer tous les services : ${CYAN}./hots start${NC}"
    echo -e "${YELLOW}üí° Pour v√©rifier l'√©tat : ${CYAN}./hots status${NC}"
}

stop_services() {
    echo -e "${BLUE}üõë Arr√™t des services Heroes of Time${NC}"
    echo "====================================="
    
    if [ -f "$STOP_SCRIPT" ]; then
        bash "$STOP_SCRIPT"
        echo ""
        echo -e "${GREEN}‚úÖ Services arr√™t√©s${NC}"
    else
        echo -e "${RED}‚ùå Script d'arr√™t non trouv√©: $STOP_SCRIPT${NC}"
        return 1
    fi
}

restart_services() {
    echo -e "${BLUE}üîÑ Red√©marrage des services Heroes of Time${NC}"
    echo "=========================================="
    stop_services
    sleep 2
    start_services
}

# Nouvelles fonctions de test
list_available_tests() {
    echo -e "${CYAN}üìã Tests disponibles dans Heroes of Time${NC}"
    echo -e "${CYAN}=======================================${NC}"
    echo ""
    echo -e "${YELLOW}üîß Tests de base:${NC}"
    echo -e "  ${GREEN}quick${NC}         - Tests rapides (1-2 min)"
    echo -e "  ${GREEN}ui${NC}            - Tests interfaces utilisateur"
    echo -e "  ${GREEN}backend${NC}       - Tests backend uniquement"
    echo -e "  ${GREEN}maven${NC}         - Tests Maven compilation/build"
    echo ""
    echo -e "${YELLOW}üéÆ Tests sp√©cialis√©s:${NC}"
    echo -e "  ${GREEN}demo${NC}          - D√©monstrations interactives"
    echo -e "  ${GREEN}bataille${NC}      - Tests bataille temporelle"
    echo -e "  ${GREEN}quantum${NC}       - Tests quantum/visualiseurs"
    echo -e "  ${GREEN}scenarios${NC}     - Tests sc√©narios HOTS complets"
    echo -e "  ${GREEN}json${NC}          - Tests nouveaux scripts JSON (architecture HSP)"
    echo -e "  ${GREEN}jean-gros${NC}     - Tests Jean-Gros v2/v3 complets"
    echo -e "  ${GREEN}decay${NC}         - Tests syst√®me DK20 Temporal Decay (Anna the Martopicker)"
    echo -e "  ${GREEN}hybrid${NC}        - Tests syst√®me Hybrid Decay (The Dude's fusion)"
    echo -e "  ${GREEN}performance${NC}   - Tests de performance et optimisation"
    echo -e "  ${GREEN}integration${NC}   - Tests d'int√©gration compl√®te"
    echo ""
    echo -e "${YELLOW}üìä Rapports et analyse:${NC}"
    echo -e "  ${GREEN}report${NC}        - Rapport complet des tests"
    echo -e "  ${GREEN}final${NC}         - Test final complet (tous les tests)"
    echo -e "  ${GREEN}list${NC}          - Cette liste"
    echo ""
    echo -e "${YELLOW}üìÅ Scripts de test disponibles:${NC}"
    
    # Lister les scripts de test disponibles
    if [ -d "scripts/test" ]; then
        find scripts/test -name "*.sh" | sort | while read script; do
            echo -e "  üìÑ ${BLUE}$script${NC}"
        done
    fi
    
    if [ -d "scripts/demo" ]; then
        echo ""
        echo -e "${YELLOW}üé¨ Scripts de d√©mo disponibles:${NC}"
        find scripts/demo -name "*.sh" | sort | while read script; do
            echo -e "  üé≠ ${PURPLE}$script${NC}"
        done
    fi
}

run_test_suite() {
    local test_type="${1:-complete}"
    
    echo -e "${CYAN}üß™ Lancement des tests Heroes of Time${NC}"
    echo -e "${CYAN}====================================${NC}"
    echo -e "${YELLOW}Type de test: ${test_type}${NC}"
    echo ""
    
    case "$test_type" in
        "quick")
            echo -e "${GREEN}üöÄ Tests rapides en cours...${NC}"
            if [ -f "scripts/test/test-ui-quick.sh" ]; then
                bash scripts/test/test-ui-quick.sh
            elif [ -f "scripts/actifs/test-ui-quick.sh" ]; then
                bash scripts/actifs/test-ui-quick.sh
            else
                echo -e "${RED}‚ùå Script de test rapide non trouv√©${NC}"
                return 1
            fi
            ;;
        "ui")
            echo -e "${GREEN}üñ•Ô∏è  Tests d'interface utilisateur...${NC}"
            if [ -f "scripts/test/test-scenarios-ui.sh" ]; then
                bash scripts/test/test-scenarios-ui.sh
            else
                echo -e "${RED}‚ùå Script de test UI non trouv√©${NC}"
                return 1
            fi
            ;;
        "backend")
            echo -e "${GREEN}‚öôÔ∏è  Tests backend...${NC}"
            if [ -f "scripts/test/test-backend-conformity.sh" ]; then
                bash scripts/test/test-backend-conformity.sh
            else
                echo -e "${RED}‚ùå Script de test backend non trouv√©${NC}"
                return 1
            fi
            ;;
        "maven")
            echo -e "${GREEN}‚òï Tests Maven compilation...${NC}"
            echo -e "${YELLOW}üîß Test compilation backend Maven...${NC}"
            if [ -d "backend" ]; then
                cd backend
                echo "üìã Tentative de compilation Maven..."
                if mvn clean compile -q; then
                    echo -e "${GREEN}‚úÖ Compilation Maven r√©ussie${NC}"
                else
                    echo -e "${RED}‚ùå Erreur de compilation Maven${NC}"
                    echo -e "${YELLOW}üí° Probl√®mes connus: executeFormula manquante, JPA entities${NC}"
                fi
                cd ..
            else
                echo -e "${RED}‚ùå Dossier backend non trouv√©${NC}"
                return 1
            fi
            ;;
        "demo")
            echo -e "${GREEN}üé¨ D√©monstrations interactives...${NC}"
            if [ -f "scripts/demo/demo-quantum-final.sh" ]; then
                bash scripts/demo/demo-quantum-final.sh
            else
                echo -e "${RED}‚ùå Script de d√©mo non trouv√©${NC}"
                return 1
            fi
            ;;
        "bataille")
            echo -e "${GREEN}‚öîÔ∏è  Tests bataille temporelle...${NC}"
            if [ -f "scripts/test/test-complete-bataille-temporelle.sh" ]; then
                bash scripts/test/test-complete-bataille-temporelle.sh
            else
                echo -e "${RED}‚ùå Script de test bataille non trouv√©${NC}"
                return 1
            fi
            ;;
        "quantum")
            echo -e "${GREEN}üåÄ Tests quantum et visualiseurs...${NC}"
            if [ -f "tester-quantum-ui.sh" ]; then
                bash tester-quantum-ui.sh
            else
                echo -e "${RED}‚ùå Script de test quantum non trouv√©${NC}"
                return 1
            fi
            ;;
        "scenarios")
            echo -e "${GREEN}üé≠ Tests sc√©narios HOTS...${NC}"
            if [ -f "scripts/test/run-all-hots-scenarios.sh" ]; then
                bash scripts/test/run-all-hots-scenarios.sh
            else
                echo -e "${RED}‚ùå Script de test sc√©narios non trouv√©${NC}"
                return 1
            fi
            ;;
        "json")
            echo -e "${GREEN}üöÄ Tests nouveaux scripts JSON (architecture HSP)...${NC}"
            echo -e "${YELLOW}üîç Test script panopticon JSON...${NC}"
            if [ -f "scripts/test-panopticon-json-scenario.sh" ]; then
                bash scripts/test-panopticon-json-scenario.sh
            else
                echo -e "${RED}‚ùå Script panopticon JSON non trouv√©${NC}"
            fi
            
            echo -e "${YELLOW}‚öîÔ∏è Test script duel collapse JSON...${NC}"
            if [ -f "scripts/test-duel-collapse-json.sh" ]; then
                bash scripts/test-duel-collapse-json.sh
            else
                echo -e "${RED}‚ùå Script duel collapse JSON non trouv√©${NC}"
            fi
            
            echo -e "${YELLOW}üéÆ Test runner g√©n√©rique JSON...${NC}"
            if [ -f "scripts/test-json-scenario-runner.sh" ]; then
                echo "Testing with GROFI_QUICK_TEST scenario..."
                bash scripts/test-json-scenario-runner.sh GROFI_QUICK_TEST
            else
                echo -e "${RED}‚ùå Script runner JSON non trouv√©${NC}"
            fi
            ;;
        "jean-gros")
            echo -e "${GREEN}üé≥ Tests Jean-Gros complets...${NC}"
            echo -e "${YELLOW}üîß Lancement Jean-Gros v2 FIXED...${NC}"
            if [ -f "scripts/test-jean-gros-v2-FIXED.sh" ]; then
                bash scripts/test-jean-gros-v2-FIXED.sh
            else
                echo -e "${RED}‚ùå Script Jean-Gros v2 non trouv√©${NC}"
            fi
            
            echo -e "${YELLOW}üöÄ Lancement Jean-Gros v3 WITH JSON...${NC}"
            if [ -f "scripts/test-jean-gros-v3-with-json.sh" ]; then
                bash scripts/test-jean-gros-v3-with-json.sh
            else
                echo -e "${RED}‚ùå Script Jean-Gros v3 non trouv√©${NC}"
            fi
            ;;
        "decay")
            echo -e "${GREEN}üåÄ Tests syst√®me DK20 Temporal Decay...${NC}"
            echo -e "${PURPLE}üí´ Testing Anna the Martopicker's temporal mechanics${NC}"
            if [ -f "scripts/test-temporal-decay-dk20.sh" ]; then
                bash scripts/test-temporal-decay-dk20.sh
            else
                echo -e "${RED}‚ùå Script DK20 Temporal Decay non trouv√©${NC}"
                return 1
            fi
            ;;
        "hybrid")
            echo -e "${GREEN}üé≥ Tests syst√®me Hybrid Decay...${NC}"
            echo -e "${PURPLE}üí´ Testing The Dude's unified temporal decay system${NC}"
            if [ -f "scripts/test-temporal-decay-hybrid-dude.sh" ]; then
                bash scripts/test-temporal-decay-hybrid-dude.sh
            else
                echo -e "${RED}‚ùå Script Hybrid Decay non trouv√©${NC}"
                return 1
            fi
            ;;
        "performance")
            echo -e "${GREEN}‚ö° Tests de performance...${NC}"
            if [ -f "scripts/test/test-optimizations-performance.sh" ]; then
                bash scripts/test/test-optimizations-performance.sh
            elif [ -f "scripts/test/benchmark-native-vs-script.sh" ]; then
                bash scripts/test/benchmark-native-vs-script.sh
            else
                echo -e "${RED}‚ùå Script de test performance non trouv√©${NC}"
                return 1
            fi
            ;;
        "integration")
            echo -e "${GREEN}üîó Tests d'int√©gration...${NC}"
            if [ -f "scripts/test/test-integration-complete.sh" ]; then
                bash scripts/test/test-integration-complete.sh
            else
                echo -e "${RED}‚ùå Script de test int√©gration non trouv√©${NC}"
                return 1
            fi
            ;;
        "missing")
            echo -e "${GREEN}üéØ Tests sc√©narios manquants et cr√©atures...${NC}"
            if [ -f "scripts/test-all-missing-scenarios.sh" ]; then
                chmod +x scripts/test-all-missing-scenarios.sh
                bash scripts/test-all-missing-scenarios.sh
            else
                echo -e "${RED}‚ùå Script de test sc√©narios manquants non trouv√©${NC}"
                return 1
            fi
            ;;
        "creatures")
            echo -e "${GREEN}üêâ Tests sp√©cifiques des cr√©atures quantiques...${NC}"
            if [ -f "scripts/test-all-missing-scenarios.sh" ]; then
                chmod +x scripts/test-all-missing-scenarios.sh
                bash scripts/test-all-missing-scenarios.sh | grep -E "(CR√âATURE|üêâ|creature|Luciole|Dragon|Liche|Ph√©nix)"
            else
                echo -e "${RED}‚ùå Script de test cr√©atures non trouv√©${NC}"
                return 1
            fi
            ;;
        "report")
            generate_test_report
            ;;
        "final")
            echo -e "${GREEN}üèÜ TEST FINAL COMPLET - TOUS LES TESTS${NC}"
            echo -e "${CYAN}=====================================${NC}"
            
            # Lancer tous les tests dans l'ordre
            echo -e "${YELLOW}üöÄ Phase 1: Tests rapides${NC}"
            run_test_suite "quick"
            
            echo -e "${YELLOW}üñ•Ô∏è  Phase 2: Tests UI${NC}"
            run_test_suite "ui"
            
            echo -e "${YELLOW}‚öôÔ∏è  Phase 3: Tests backend${NC}"
            run_test_suite "backend"
            
            echo -e "${YELLOW}‚òï Phase 4: Tests Maven${NC}"
            run_test_suite "maven"
            
            echo -e "${YELLOW}üé¨ Phase 5: D√©monstrations${NC}"
            run_test_suite "demo"
            
            echo -e "${YELLOW}‚öîÔ∏è  Phase 6: Tests bataille${NC}"
            run_test_suite "bataille"
            
            echo -e "${YELLOW}üåÄ Phase 7: Tests quantum${NC}"
            run_test_suite "quantum"
            
            echo -e "${YELLOW}üé≠ Phase 8: Tests sc√©narios${NC}"
            run_test_suite "scenarios"
            
            echo -e "${YELLOW}üöÄ Phase 9: Tests JSON (architecture HSP)${NC}"
            run_test_suite "json"
            
            echo -e "${YELLOW}üé≥ Phase 10: Tests Jean-Gros complets${NC}"
            run_test_suite "jean-gros"
            
            echo -e "${YELLOW}üåÄ Phase 11: Tests DK20 Temporal Decay${NC}"
            run_test_suite "decay"
            
            echo -e "${YELLOW}‚ö° Phase 12: Tests performance${NC}"
            run_test_suite "performance"
            
            echo -e "${YELLOW}üîó Phase 13: Tests int√©gration${NC}"
            run_test_suite "integration"
            
            echo -e "${YELLOW}üéØ Phase 14: Tests sc√©narios manquants${NC}"
            run_test_suite "missing"
            
            echo ""
            echo -e "${CYAN}üèÜ TEST FINAL COMPLET TERMIN√â${NC}"
            echo -e "${GREEN}‚úÖ Toutes les phases de test ex√©cut√©es${NC}"
            
            # Rapport final
            generate_test_report
            ;;
        "list")
            list_available_tests
            ;;
        "complete"|*)
            echo -e "${GREEN}üî¨ Tests complets en cours...${NC}"
            if [ -f "scripts/test/test-complet-final.sh" ]; then
                bash scripts/test/test-complet-final.sh
            elif [ -f "test-complet-final.sh" ]; then
                bash test-complet-final.sh
            else
                echo -e "${RED}‚ùå Script de test complet non trouv√©${NC}"
                return 1
            fi
            ;;
    esac
}

generate_test_report() {
    echo -e "${CYAN}üìä Rapport complet des tests Heroes of Time${NC}"
    echo -e "${CYAN}===========================================${NC}"
    echo ""
    
    # V√©rifier l'√©tat des services
    echo -e "${YELLOW}üîç √âtat des services:${NC}"
    check_services
    local active_services=$?
    echo ""
    
    # V√©rifier le Test Runner
    echo -e "${YELLOW}üß™ Test Runner Analysis:${NC}"
    if lsof -i :8888 >/dev/null 2>&1; then
        echo -e "  ‚úÖ Test Runner actif sur port 8888"
        echo -e "  üåê Interface: ${CYAN}http://localhost:8888${NC}"
        
        # Analyser les tests disponibles dans le Test Runner
        if [ -f "test-runner-interface.html" ]; then
            echo -e "  üìã Interface HTML: ${GREEN}Disponible${NC}"
            
            # Extraire les tests configur√©s
            echo -e "  üéØ Tests configur√©s dans l'interface:"
            grep -o "script: '[^']*'" test-runner-interface.html 2>/dev/null | sed "s/script: '/    üìÑ /" | sed "s/'$//"
        fi
        
        if [ -f "test-runner-server.py" ]; then
            echo -e "  üêç Serveur Python: ${GREEN}Disponible${NC}"
        fi
    else
        echo -e "  ‚ùå Test Runner non actif"
    fi
    echo ""
    
    # Analyser les scripts de test disponibles
    echo -e "${YELLOW}üìÅ Scripts de test disponibles:${NC}"
    local test_count=0
    
    if [ -d "scripts/test" ]; then
        while IFS= read -r script; do
            if [ -f "$script" ]; then
                local size=$(du -h "$script" 2>/dev/null | cut -f1)
                local name=$(basename "$script")
                echo -e "  üìÑ ${GREEN}$name${NC} (${size})"
                ((test_count++))
            fi
        done < <(find scripts/test -name "*.sh" | sort)
    fi
    
    if [ -d "scripts/demo" ]; then
        echo ""
        echo -e "${YELLOW}üé¨ Scripts de d√©mo disponibles:${NC}"
        while IFS= read -r script; do
            if [ -f "$script" ]; then
                local size=$(du -h "$script" 2>/dev/null | cut -f1)
                local name=$(basename "$script")
                echo -e "  üé≠ ${PURPLE}$name${NC} (${size})"
                ((test_count++))
            fi
        done < <(find scripts/demo -name "*.sh" | sort)
    fi
    
    echo ""
    echo -e "${YELLOW}üîç Tests racine disponibles:${NC}"
    for script in test-*.sh tester-*.sh; do
        if [ -f "$script" ]; then
            local size=$(du -h "$script" 2>/dev/null | cut -f1)
            echo -e "  üß™ ${BLUE}$script${NC} (${size})"
            ((test_count++))
        fi
    done
    
    # Analyser le backend Maven
    echo ""
    echo -e "${YELLOW}‚òï Analyse Backend Maven:${NC}"
    if [ -f "backend/pom.xml" ]; then
        echo -e "  üìÑ pom.xml: ${GREEN}Disponible${NC}"
        if [ -d "backend/src/main/java" ]; then
            local java_files=$(find backend/src/main/java -name "*.java" | wc -l)
            echo -e "  ‚òï Fichiers Java: ${GREEN}$java_files fichiers${NC}"
        fi
        if [ -d "backend/target" ]; then
            echo -e "  üéØ Target Maven: ${GREEN}Pr√©sent${NC}"
        else
            echo -e "  üéØ Target Maven: ${YELLOW}Absent (pas compil√©)${NC}"
        fi
        
        # Test de compilation rapide
        echo -e "  üîß Test compilation rapide..."
        if (cd backend && mvn compile -q >/dev/null 2>&1); then
            echo -e "  ‚úÖ Compilation: ${GREEN}R√©ussie${NC}"
        else
            echo -e "  ‚ùå Compilation: ${RED}√âchoue${NC}"
            echo -e "    üí° Probl√®mes connus: executeFormula manquante, JPA entities"
        fi
    else
        echo -e "  ‚ùå Backend Maven non trouv√©"
    fi
    
    # Analyser les frontends
    echo ""
    echo -e "${YELLOW}üñ•Ô∏è  Analyse Frontends:${NC}"
    local frontend_count=0
    for frontend_dir in frontend frontend-temporal frontend-legendary-ui quantum-visualizer; do
        if [ -d "$frontend_dir" ] && [ -f "$frontend_dir/index.html" ]; then
            local size=$(du -sh "$frontend_dir" 2>/dev/null | cut -f1)
            echo -e "  üìÅ ${GREEN}$frontend_dir${NC} (${size})"
            ((frontend_count++))
        fi
    done
    echo -e "  üìä Total frontends: ${GREEN}$frontend_count${NC}"
    
    # Analyser les sc√©narios et assets
    echo ""
    echo -e "${YELLOW}üé≠ Analyse Sc√©narios et Assets:${NC}"
    if [ -d "game_assets/scenarios" ]; then
        local hots_files=$(find game_assets/scenarios -name "*.hots" | wc -l)
        local json_files=$(find game_assets/scenarios -name "*.json" | wc -l)
        echo -e "  üìÑ Fichiers HOTS: ${GREEN}$hots_files${NC}"
        echo -e "  üìÑ Fichiers JSON: ${GREEN}$json_files${NC}"
    else
        echo -e "  ‚ùå Dossier game_assets/scenarios non trouv√©"
    fi
    
    echo ""
    echo -e "${YELLOW}üìä R√©sum√© du rapport:${NC}"
    echo -e "  üéÆ Services actifs: ${GREEN}$active_services/6${NC}"
    echo -e "  üß™ Scripts de test: ${GREEN}$test_count${NC}"
    echo -e "  üñ•Ô∏è  Frontends: ${GREEN}$frontend_count${NC}"
    echo -e "  üåê Test Runner: $(if lsof -i :8888 >/dev/null 2>&1; then echo -e "${GREEN}Actif${NC}"; else echo -e "${RED}Inactif${NC}"; fi)"
    echo -e "  ‚òï Backend Maven: $(if [ -f "backend/pom.xml" ]; then echo -e "${GREEN}Disponible${NC}"; else echo -e "${RED}Manquant${NC}"; fi)"
    
    # √âtat de sant√© global
    echo ""
    echo -e "${YELLOW}üè• √âtat de sant√© global:${NC}"
    local health_score=0
    
    if [ $active_services -ge 4 ]; then ((health_score += 25)); fi
    if [ $test_count -ge 20 ]; then ((health_score += 25)); fi
    if lsof -i :8888 >/dev/null 2>&1; then ((health_score += 25)); fi
    if [ -f "backend/pom.xml" ]; then ((health_score += 25)); fi
    
    if [ $health_score -ge 90 ]; then
        echo -e "  üü¢ ${GREEN}Excellent${NC} ($health_score/100)"
    elif [ $health_score -ge 70 ]; then
        echo -e "  üü° ${YELLOW}Bon${NC} ($health_score/100)"
    elif [ $health_score -ge 50 ]; then
        echo -e "  üü† ${YELLOW}Moyen${NC} ($health_score/100)"
    else
        echo -e "  üî¥ ${RED}N√©cessite attention${NC} ($health_score/100)"
    fi
    
    # Recommandations
    echo ""
    echo -e "${YELLOW}üí° Recommandations:${NC}"
    
    if [ $active_services -lt 6 ]; then
        echo -e "  ‚ö†Ô∏è  D√©marrer tous les services: ${CYAN}./hots start${NC}"
    fi
    
    if ! lsof -i :8888 >/dev/null 2>&1; then
        echo -e "  üß™ Lancer le Test Runner: ${CYAN}python3 test-runner-server.py 8888 &${NC}"
    fi
    
    if [ -f "backend/pom.xml" ] && ! (cd backend && mvn compile -q >/dev/null 2>&1); then
        echo -e "  üîß R√©parer backend Maven: ${CYAN}./hots test maven${NC}"
    fi
    
    echo -e "  üöÄ Tests rapides: ${CYAN}./hots test quick${NC}"
    echo -e "  üé¨ D√©monstration: ${CYAN}./hots test demo${NC}"
    echo -e "  üèÜ Test final complet: ${CYAN}./hots test final${NC}"
    echo -e "  üìã Liste compl√®te: ${CYAN}./hots test list${NC}"
    
    echo ""
    echo -e "${CYAN}üìà Pour un diagnostic complet, utilisez: ${GREEN}./hots test final${NC}"
}

# üß† Fonction de g√©n√©ration MD - Memento
generate_md_docs() {
    echo -e "${CYAN}üß† MEMENTO - G√©n√©rateur de Documentation MD${NC}"
    echo -e "${CYAN}============================================${NC}"
    echo ""
    
    if [ ! -f "scripts/generate-md-from-json.py" ]; then
        echo -e "${RED}‚ùå G√©n√©rateur MD non trouv√©: scripts/generate-md-from-json.py${NC}"
        return 1
    fi
    
    echo -e "${YELLOW}üîÑ G√©n√©ration automatique des fichiers Markdown...${NC}"
    python3 scripts/generate-md-from-json.py
    
    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}‚úÖ G√©n√©ration termin√©e avec succ√®s !${NC}"
        echo -e "${YELLOW}üìÅ Fichiers g√©n√©r√©s dans :${NC}"
        echo -e "  - ${CYAN}docs/artifacts/generated/${NC}"
        echo -e "  - ${CYAN}docs/heroes/generated/${NC}"
        echo -e "  - ${CYAN}docs/creatures/generated/${NC}"
    else
        echo -e "${RED}‚ùå Erreur lors de la g√©n√©ration${NC}"
        return 1
    fi
}

# üó∫Ô∏è Fonctions MAP
manage_maps() {
    local action="$1"
    
    case "$action" in
        "list"|"")
            echo -e "${CYAN}üó∫Ô∏è  SYST√àME MAP - Heroes of Time${NC}"
            echo -e "${CYAN}================================${NC}"
            echo ""
            echo -e "${YELLOW}üìÅ Maps disponibles :${NC}"
            
            if [ -d "game_assets/scenarios/maps/templates" ]; then
                find game_assets/scenarios/maps/templates -name "*.hsp" -o -name "*.json" | while read map; do
                    local name=$(basename "$map")
                    local size=$(du -sh "$map" 2>/dev/null | cut -f1)
                    echo -e "  üìÑ ${GREEN}$name${NC} (${size})"
                done
            else
                echo -e "  ‚ùå Dossier templates non trouv√©"
            fi
            
            echo ""
            echo -e "${YELLOW}üéÆ Commandes disponibles :${NC}"
            echo -e "  ${GREEN}./hots map list${NC}          # Liste les maps"
            echo -e "  ${GREEN}./hots map create <name>${NC}  # Cr√©er une nouvelle map"
            echo -e "  ${GREEN}./hots map info <name>${NC}    # Infos sur une map"
            ;;
        "create")
            local map_name="$2"
            if [ -z "$map_name" ]; then
                echo -e "${RED}‚ùå Usage: ./hots map create <nom_de_la_map>${NC}"
                return 1
            fi
            
            echo -e "${YELLOW}üîß Cr√©ation de la map: $map_name${NC}"
            echo -e "${GREEN}‚úÖ Map cr√©√©e (fonctionnalit√© √† impl√©menter)${NC}"
            ;;
        "info")
            local map_name="$2"
            echo -e "${YELLOW}üìä Informations sur la map: $map_name${NC}"
            echo -e "${GREEN}‚úÖ Infos map (fonctionnalit√© √† impl√©menter)${NC}"
            ;;
        *)
            echo -e "${RED}‚ùå Action inconnue: $action${NC}"
            echo -e "${YELLOW}Actions disponibles: list, create, info${NC}"
            return 1
            ;;
    esac
}

# üìπ Fonctions REPLAY
manage_replays() {
    local action="$1"
    
    case "$action" in
        "list"|"")
            echo -e "${CYAN}üìπ SYST√àME REPLAY - Heroes of Time${NC}"
            echo -e "${CYAN}==================================${NC}"
            echo ""
            echo -e "${YELLOW}üé¨ Replays disponibles :${NC}"
            
            if [ -d "game_assets/scenarios/maps/replays" ]; then
                find game_assets/scenarios/maps/replays -name "*.hsp" -o -name "*.json" | while read replay; do
                    local name=$(basename "$replay" | sed 's/\.[^.]*$//')
                    local size=$(du -sh "$replay" 2>/dev/null | cut -f1)
                    local date=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$replay" 2>/dev/null)
                    echo -e "  üé¨ ${GREEN}$name${NC} (${size}) - $date"
                done
            else
                echo -e "  ‚ùå Aucun replay trouv√©"
            fi
            
            echo ""
            echo -e "${YELLOW}üéÆ Commandes disponibles :${NC}"
                echo -e "  ${GREEN}./hots replay list${NC}           # Liste les replays"
    echo -e "  ${GREEN}./hots replay center${NC}         # üé¨ Ouvre le Centre de Replay (dashboard)"
    echo -e "  ${GREEN}./hots replay view <name>${NC}     # Voir un replay sp√©cifique"
    echo -e "  ${GREEN}./hots replay analyze <name>${NC}  # Analyser un replay (infos d√©taill√©es)"
    echo -e "  ${GREEN}./hots replay save <name>${NC}     # Sauvegarder partie actuelle"
            ;;
        "view")
            local replay_name="$2"
            if [ -z "$replay_name" ]; then
                echo -e "${RED}‚ùå Usage: ./hots replay view <nom_du_replay>${NC}"
                return 1
            fi
            
            echo -e "${YELLOW}üé¨ Visualisation du replay: $replay_name${NC}"
            echo -e "${GREEN}‚úÖ Ouverture du Centre de Replay...${NC}"
            
            # V√©rifier que le dashboard est actif
            if ! curl -s http://localhost:9000/dashboard.html > /dev/null; then
                echo -e "${RED}‚ùå Dashboard non accessible sur le port 9000${NC}"
                echo -e "${YELLOW}üí° Lancez d'abord: ./hots start${NC}"
                return 1
            fi
            
            echo -e "${CYAN}üé¨ Ouverture du Centre de Replay dans le navigateur...${NC}"
            if command -v open > /dev/null; then
                # macOS
                open "http://localhost:9000/dashboard.html"
            elif command -v xdg-open > /dev/null; then
                # Linux
                xdg-open "http://localhost:9000/dashboard.html"
            else
                echo -e "${YELLOW}üìã Acc√©dez manuellement √†: http://localhost:9000/dashboard.html${NC}"
                echo -e "${YELLOW}   Puis cliquez sur 'üé¨ Centre de Replay'${NC}"
            fi
            ;;
        "center"|"centre")
            echo -e "${CYAN}üé¨ Ouverture du Centre de Replay Heroes of Time${NC}"
            
            # V√©rifier que le dashboard est actif
            if ! curl -s http://localhost:9000/dashboard.html > /dev/null; then
                echo -e "${RED}‚ùå Dashboard non accessible sur le port 9000${NC}"
                echo -e "${YELLOW}üí° Lancez d'abord: ./hots start${NC}"
                return 1
            fi
            
            echo -e "${GREEN}‚úÖ Dashboard actif - Ouverture du navigateur...${NC}"
            if command -v open > /dev/null; then
                # macOS
                open "http://localhost:9000/dashboard.html"
            elif command -v xdg-open > /dev/null; then
                # Linux  
                xdg-open "http://localhost:9000/dashboard.html"
            else
                echo -e "${YELLOW}üìã Acc√©dez manuellement √†: http://localhost:9000/dashboard.html${NC}"
                echo -e "${YELLOW}   Puis cliquez sur 'üé¨ Centre de Replay'${NC}"
            fi
            ;;
        "analyze")
            local replay_name="$2"
            echo -e "${YELLOW}üìä Analyse du replay: $replay_name${NC}"
            
            # Chercher le fichier de replay
            local replay_file=""
            if [ -f "game_assets/scenarios/maps/replays/20250721_session_jean/$replay_name.hsp" ]; then
                replay_file="game_assets/scenarios/maps/replays/20250721_session_jean/$replay_name.hsp"
            elif [ -f "game_assets/scenarios/visualizer/$replay_name.hsp" ]; then
                replay_file="game_assets/scenarios/visualizer/$replay_name.hsp"
            fi
            
            if [ -n "$replay_file" ]; then
                echo -e "${GREEN}üìÑ Fichier trouv√©: $replay_file${NC}"
                echo -e "${CYAN}üìä Informations du replay:${NC}"
                
                # Extraire les infos JSON
                if command -v jq > /dev/null; then
                    echo -e "${YELLOW}üéÆ Nom du jeu:${NC} $(jq -r '.replayInfo.gameName // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}üìÖ Date:${NC} $(jq -r '.replayInfo.date // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}‚è±Ô∏è Dur√©e:${NC} $(jq -r '.replayInfo.duration // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}üèÜ Gagnant:${NC} $(jq -r '.replayInfo.winner // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}üë• Joueurs:${NC} $(jq -r '.replayInfo.players | join(", ") // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}üîÑ Tours:${NC} $(jq -r '.replayInfo.totalTurns // "N/A"' "$replay_file" 2>/dev/null)"
                else
                    head -20 "$replay_file"
                fi
            else
                echo -e "${RED}‚ùå Replay '$replay_name' non trouv√©${NC}"
                echo -e "${YELLOW}üí° Utilisez: ./hots replay list${NC}"
            fi
            ;;
        "save")
            local replay_name="$2"
            echo -e "${YELLOW}üíæ Sauvegarde de la partie actuelle: $replay_name${NC}"
            echo -e "${GREEN}‚úÖ Fonctionnalit√© de sauvegarde (√† connecter au backend)${NC}"
            ;;
        *)
            echo -e "${RED}‚ùå Action inconnue: $action${NC}"
            echo -e "${YELLOW}Actions disponibles: list, view, analyze, save${NC}"
            return 1
            ;;
    esac
}

# üé® Fonction √âDITEUR VISUEL
launch_visual_editor() {
    echo -e "${CYAN}üé® √âDITEUR VISUEL SCRIPT SPATIO-TEMPOREL - Heroes of Time${NC}"
    echo -e "${CYAN}========================================================${NC}"
    echo ""
    
    # V√©rifier que le frontend est actif
    if ! curl -s http://localhost:8000 > /dev/null; then
        echo -e "${RED}‚ùå Frontend non accessible sur le port 8000${NC}"
        echo -e "${YELLOW}üí° Lancez d'abord: ./hots start essential${NC}"
        return 1
    fi
    
    echo -e "${GREEN}‚úÖ Frontend actif - Ouverture de l'√©diteur visuel...${NC}"
    if command -v open > /dev/null; then
        # macOS
        open "http://localhost:8000/visual-script-editor.html"
    elif command -v xdg-open > /dev/null; then
        # Linux  
        xdg-open "http://localhost:8000/visual-script-editor.html"
    else
        echo -e "${YELLOW}üìã Acc√©dez manuellement √†: http://localhost:8000/visual-script-editor.html${NC}"
    fi
    
    echo -e "${CYAN}üé® Fonctionnalit√©s de l'√©diteur:${NC}"
    echo -e "  üö∂ Actions de base (MOV, USE, CREATE, HERO, BATTLE)"
    echo -e "  œà Actions temporelles (PSI, TRIGGER, COLLAPSE)"
    echo -e "  ‚è∞ Timeline Editor avec branches multiples"
    echo -e "  üéÆ Game Board interactif"
    echo -e "  üîß Syst√®me de macros personnalis√©es"
    echo -e "  üìú G√©n√©ration automatique de scripts"
    echo -e "  üíæ Sauvegarde/chargement de configurations"
    echo ""
    echo -e "${YELLOW}üí° R√©volution du game design:${NC}"
    echo -e "  ‚Ä¢ Premier IDE visuel de scripting quantico-temporel au monde"
    echo -e "  ‚Ä¢ Point-and-click ‚Üí Scripts complexes automatiques"
    echo -e "  ‚Ä¢ Visualisation des superpositions et causalit√©s"
    echo -e "  ‚Ä¢ Macros personnalis√©es pour actions rapides"
}

# üéÆ Fonction INTERFACE ADMIN MULTIJOUEUR
launch_admin_interface() {
    echo -e "${CYAN}üéÆ INTERFACE D'ADMINISTRATION MULTIJOUEUR - Heroes of Time${NC}"
    echo -e "${CYAN}========================================================${NC}"
    echo ""
    
    # V√©rifier que les services sont actifs
    if ! curl -s http://localhost:8080 > /dev/null; then
        echo -e "${RED}‚ùå Backend non accessible sur le port 8080${NC}"
        echo -e "${YELLOW}üí° Lancez d'abord: ./hots start essential${NC}"
        return 1
    fi
    
    if ! curl -s http://localhost:8000 > /dev/null; then
        echo -e "${RED}‚ùå Frontend non accessible sur le port 8000${NC}"
        echo -e "${YELLOW}üí° Lancez d'abord: ./hots start essential${NC}"
        return 1
    fi
    
    echo -e "${GREEN}‚úÖ Services v√©rifi√©s${NC}"
    echo ""
    echo -e "${YELLOW}üéÆ Lancement de l'interface d'administration multijoueur...${NC}"
    echo ""
    
    # Ouvrir l'interface dans le navigateur
    if command -v open > /dev/null; then
        open "http://localhost:8000/admin-multiplayer.html"
    elif command -v xdg-open > /dev/null; then
        xdg-open "http://localhost:8000/admin-multiplayer.html"
    else
        echo -e "${YELLOW}üåê Ouvrez manuellement: http://localhost:8000/admin-multiplayer.html${NC}"
    fi
    
    echo -e "${GREEN}üéÆ Interface d'administration lanc√©e !${NC}"
    echo ""
    echo -e "${CYAN}üìã Fonctionnalit√©s disponibles:${NC}"
    echo -e "  üèóÔ∏è  Gestion des jeux (cr√©er, lister, supprimer)"
    echo -e "  üë• Gestion des joueurs (ajouter, expulser)"
    echo -e "  ü¶∏ Gestion des h√©ros (appara√Ætre, t√©l√©porter, supprimer)"
    echo -e "  üéØ Contr√¥le du jeu (pause, tour suivant, reset, fin)"
    echo -e "  üöÄ D√©marrage rapide multijoueur"
    echo -e "  üß™ Tests complets du syst√®me"
    echo -e "  üé¨ D√©mo multijoueur"
    echo ""
    echo -e "${YELLOW}üí° Mode Administrateur - Jean sur le canap√©${NC}"
    echo -e "${YELLOW}üí° Protocole Memento - Fusion Claudius activ√©e${NC}"
}

# Fonction pour g√©rer les sc√©narios HEP
manage_scenarios() {
    local command="$1"
    local scenario_name="$2"
    
    echo -e "${PURPLE}üé¨ Gestionnaire de Sc√©narios HEP (Heroes Epic Play)${NC}"
    echo -e "${PURPLE}==============================================${NC}"
    
    case "$command" in
        "list"|"")
            echo -e "${YELLOW}üìã Sc√©narios HEP disponibles:${NC}"
            echo ""
            
            if [ -d "game_assets/scenarios/hots" ]; then
                echo -e "${CYAN}üé¨ Sc√©narios HOTS (.hots):${NC}"
                find game_assets/scenarios/hots -name "*.hots" -type f | while read file; do
                    local filename=$(basename "$file" .hots)
                    local size=$(du -h "$file" 2>/dev/null | cut -f1)
                    echo -e "  üìÑ ${GREEN}$filename${NC} (${size})"
                done
            fi
            
            if [ -d "game_assets/scenarios" ]; then
                echo ""
                echo -e "${CYAN}üéÆ Sc√©narios JSON classiques:${NC}"
                find game_assets/scenarios -name "*.json" -type f | while read file; do
                    local filename=$(basename "$file" .json)
                    local size=$(du -h "$file" 2>/dev/null | cut -f1)
                    echo -e "  üìÑ ${BLUE}$filename${NC} (${size})"
                done
            fi
            
            echo ""
            echo -e "${YELLOW}üí° Usage: ./hots scenario [nom_scenario]${NC}"
            echo -e "${YELLOW}üí° Exemple: ./hots scenario bataille${NC}"
            ;;
            
        "bataille"|"bataille_temporelle")
            echo -e "${YELLOW}‚öîÔ∏è  Lancement de la Bataille Temporelle Compl√®te...${NC}"
            local scenario_file="game_assets/scenarios/hots/bataille_temporelle_complete.hots"
            if [ -f "$scenario_file" ]; then
                echo -e "${GREEN}‚úÖ Sc√©nario trouv√©: $scenario_file${NC}"
                echo -e "${CYAN}üìä Analyse du sc√©nario:${NC}"
                wc -l "$scenario_file"
                echo ""
                if [ -x "scripts/test-anthor-ford-scenario.sh" ]; then
                    echo -e "${BLUE}üéØ Lancement avec moteur de test int√©gr√©...${NC}"
                    ./scripts/test-anthor-ford-scenario.sh "$scenario_file"
                else
                    echo -e "${YELLOW}‚ö†Ô∏è  Moteur de test non trouv√©, lancement simul√©...${NC}"
                    echo -e "${CYAN}üé¨ Contenu du sc√©nario:${NC}"
                    head -20 "$scenario_file"
                    echo -e "${YELLOW}... (contenu tronqu√©)${NC}"
                fi
            else
                echo -e "${RED}‚ùå Sc√©nario non trouv√©: $scenario_file${NC}"
            fi
            ;;
            
        "anthor"|"anthor_vs_grofi")
            echo -e "${YELLOW}üé≠ Lancement du Duel Anthor vs Jean-Grofignon...${NC}"
            local scenario_file="game_assets/scenarios/hots/anthor_vs_grofi_temporal_duel.hots"
            if [ -f "$scenario_file" ]; then
                echo -e "${GREEN}‚úÖ Sc√©nario trouv√©: $scenario_file${NC}"
                echo -e "${CYAN}üìä Analyse du sc√©nario:${NC}"
                wc -l "$scenario_file"
                echo ""
                if [ -x "scripts/test-anthor-ford-scenario.sh" ]; then
                    echo -e "${BLUE}üéØ Lancement du test Anthor sp√©cialis√©...${NC}"
                    ./scripts/test-anthor-ford-scenario.sh
                else
                    echo -e "${YELLOW}‚ö†Ô∏è  Moteur de test Anthor non trouv√©, affichage du sc√©nario...${NC}"
                    echo -e "${CYAN}üé¨ Extrait du duel √©pique:${NC}"
                    grep -E "(HERO|SAY|ABILITY)" "$scenario_file" | head -10
                    echo -e "${YELLOW}... (plus de contenu disponible)${NC}"
                fi
            else
                echo -e "${RED}‚ùå Sc√©nario non trouv√©: $scenario_file${NC}"
            fi
            ;;
            
        *)
            echo -e "${YELLOW}üîç Recherche du sc√©nario: $command${NC}"
            local found=false
            
            # Chercher dans les fichiers .hots
            if [ -d "game_assets/scenarios/hots" ]; then
                for file in game_assets/scenarios/hots/*.hots; do
                    if [[ "$(basename "$file" .hots)" == *"$command"* ]]; then
                        echo -e "${GREEN}‚úÖ Sc√©nario HOTS trouv√©: $(basename "$file")${NC}"
                        echo -e "${CYAN}üìä Analyse:${NC}"
                        wc -l "$file"
                        echo -e "${CYAN}üé¨ Aper√ßu:${NC}"
                        head -10 "$file"
                        found=true
                        break
                    fi
                done
            fi
            
            # Chercher dans les fichiers JSON
            if [ ! "$found" = true ] && [ -d "game_assets/scenarios" ]; then
                for file in game_assets/scenarios/*.json; do
                    if [[ "$(basename "$file" .json)" == *"$command"* ]]; then
                        echo -e "${GREEN}‚úÖ Sc√©nario JSON trouv√©: $(basename "$file")${NC}"
                        echo -e "${CYAN}üìä Analyse:${NC}"
                        wc -l "$file"
                        echo -e "${CYAN}üé¨ Aper√ßu:${NC}"
                        head -10 "$file"
                        found=true
                        break
                    fi
                done
            fi
            
            if [ ! "$found" = true ]; then
                echo -e "${RED}‚ùå Sc√©nario '$command' non trouv√©${NC}"
                echo -e "${YELLOW}üí° Utilisez './hots scenario list' pour voir les sc√©narios disponibles${NC}"
            fi
            ;;
    esac
}

# Fonction principale
case "${1:-help}" in
    "start")
        if [ "$2" = "essential" ]; then
            start_essential_services
        else
            start_services
        fi
        ;;
    "stop")
        stop_services
        ;;
    "restart")
        restart_services
        ;;
    "status")
        show_status
        ;;
    "test")
        run_test_suite "$2"
        ;;
    "generate")
        generate_md_docs
        ;;
    "map")
        manage_maps "$2" "$3"
        ;;
    "replay")
        manage_replays "$2" "$3"
        ;;
    "editor")
        launch_visual_editor
        ;;
    "admin")
        launch_admin_interface
        ;;
    "test-uis")
        run_test_suite "ui"
        ;;
    "debug")
        echo -e "${BLUE}üêõ Mode debug actif - Lancement de la compilation avec debug info...${NC}"
        if [ -d "backend" ]; then
            cd backend
            echo -e "${YELLOW}üîß Compilation avec debug info...${NC}"
            mvn clean compile -e -X > ../debug-compile.log 2>&1
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}‚úÖ Compilation r√©ussie avec debug info${NC}"
                echo -e "${CYAN}üìã Logs sauvegard√©s dans: debug-compile.log${NC}"
            else
                echo -e "${RED}‚ùå Erreurs de compilation d√©tect√©es${NC}"
                echo -e "${YELLOW}üìã V√©rifiez debug-compile.log pour les d√©tails${NC}"
                tail -20 ../debug-compile.log
            fi
            cd ..
        else
            echo -e "${RED}‚ùå Dossier backend non trouv√©${NC}"
        fi
        ;;
    "compile")
        echo -e "${BLUE}üîß Compilation backend avec debug info...${NC}"
        if [ -d "backend" ]; then
            cd backend
            echo -e "${YELLOW}üßπ Nettoyage...${NC}"
            mvn clean
            echo -e "${YELLOW}üîß Compilation avec debug...${NC}"
            mvn compile -e -X -Dorg.slf4j.simpleLogger.defaultLogLevel=debug
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}‚úÖ Compilation r√©ussie${NC}"
                echo -e "${CYAN}üìã Pr√™t pour le d√©marrage en mode debug${NC}"
            else
                echo -e "${RED}‚ùå Erreurs de compilation${NC}"
                echo -e "${YELLOW}üí° Utilisez './hots debug' pour plus de d√©tails${NC}"
            fi
            cd ..
        else
            echo -e "${RED}‚ùå Dossier backend non trouv√©${NC}"
        fi
        ;;
    "logs")
        echo -e "${BLUE}üìã Affichage des logs en temps r√©el...${NC}"
        echo -e "${YELLOW}üí° Appuyez sur Ctrl+C pour arr√™ter${NC}"
        echo ""
        
        # Logs backend
        if [ -f "backend.log" ]; then
            echo -e "${CYAN}üîß Logs Backend:${NC}"
            tail -f backend.log &
        fi
        
        # Logs debug
        if [ -f "debug-compile.log" ]; then
            echo -e "${CYAN}üêõ Logs Debug:${NC}"
            tail -f debug-compile.log &
        fi
        
        # Attendre l'interruption
        wait
        ;;
    "scenario")
        manage_scenarios "$2" "$3"
        ;;
    "vince")
        echo -e "${PURPLE}üî´ Lancement de Vince's Process Annihilator !${NC}"
        echo -e "${YELLOW}üíÄ 'Say hello to my little friend... the SIGKILL!'${NC}"
        echo ""
        
        if [ -x "scripts/vince-process-annihilator.sh" ]; then
            ./scripts/vince-process-annihilator.sh
        else
            echo -e "${RED}‚ùå Script vince-process-annihilator.sh non trouv√© ou non ex√©cutable${NC}"
            echo -e "${YELLOW}üí° V√©rifiez scripts/vince-process-annihilator.sh${NC}"
        fi
        ;;
    "walter")
        echo -e "${BLUE}üé≥ Activation du Walter's Anti-Vince Protocol !${NC}"
        echo -e "${YELLOW}üíÄ 'This aggression will not stand, man!'${NC}"
        echo ""
        
        if [ -x "scripts/walter-anti-vince-protocol.sh" ]; then
            ./scripts/walter-anti-vince-protocol.sh
        else
            echo -e "${RED}‚ùå Script walter-anti-vince-protocol.sh non trouv√© ou non ex√©cutable${NC}"
            echo -e "${YELLOW}üí° V√©rifiez scripts/walter-anti-vince-protocol.sh${NC}"
        fi
        ;;
    "save")
        # Sauvegarde manuelle
        if [ -z "$2" ]; then
            echo -e "${RED}‚ùå Nom de sauvegarde requis${NC}"
            echo -e "${YELLOW}Usage: ./hots save <nom_sauvegarde> [game_id] [player_id]${NC}"
            exit 1
        fi
        
        SAVE_NAME="$2"
        GAME_ID="${3:-1}"
        PLAYER_ID="${4:-player1}"
        
        echo -e "${BLUE}üíæ Sauvegarde de la partie...${NC}"
        RESPONSE=$(curl -s -X POST "http://localhost:8080/api/persistence/games/$GAME_ID/save" \
            -H "Content-Type: application/json" \
            -d "{\"playerId\": \"$PLAYER_ID\", \"saveName\": \"$SAVE_NAME\", \"description\": \"Sauvegarde manuelle\"}")
        
        if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ Partie sauvegard√©e: $SAVE_NAME${NC}"
            echo "$RESPONSE" | jq -r '.message'
        else
            echo -e "${RED}‚ùå Erreur sauvegarde${NC}"
            echo "$RESPONSE" | jq -r '.error // "Erreur inconnue"'
        fi
        ;;
    "load")
        # Charger une sauvegarde
        if [ -z "$2" ]; then
            echo -e "${RED}‚ùå ID ou nom de sauvegarde requis${NC}"
            echo -e "${YELLOW}Usage: ./hots load <save_id_ou_nom> [player_id]${NC}"
            exit 1
        fi
        
        SAVE_ID="$2"
        PLAYER_ID="${3:-player1}"
        
        echo -e "${BLUE}üìÇ Chargement de la sauvegarde...${NC}"
        
        # Si c'est un nombre, charger par ID
        if [[ "$SAVE_ID" =~ ^[0-9]+$ ]]; then
            RESPONSE=$(curl -s -X POST "http://localhost:8080/api/persistence/saves/$SAVE_ID/load" \
                -H "Content-Type: application/json" \
                -d "{\"playerId\": \"$PLAYER_ID\"}")
        else
            # Sinon, chercher par nom (√† impl√©menter c√¥t√© backend si n√©cessaire)
            echo -e "${YELLOW}‚ö†Ô∏è  Chargement par nom non encore impl√©ment√©${NC}"
            echo -e "${YELLOW}üí° Utilisez './hots list-saves' pour voir les IDs${NC}"
            exit 1
        fi
        
        if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ Partie charg√©e avec succ√®s${NC}"
            echo "$RESPONSE" | jq -r '.message'
        else
            echo -e "${RED}‚ùå Erreur chargement${NC}"
            echo "$RESPONSE" | jq -r '.error // "Erreur inconnue"'
        fi
        ;;
    "list-saves")
        # Lister les sauvegardes
        PLAYER_ID="${2:-player1}"
        
        echo -e "${BLUE}üìã Liste des sauvegardes pour $PLAYER_ID:${NC}"
        echo ""
        
        RESPONSE=$(curl -s "http://localhost:8080/api/persistence/saves?playerId=$PLAYER_ID")
        
        if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
            COUNT=$(echo "$RESPONSE" | jq -r '.count')
            echo -e "${GREEN}‚úÖ $COUNT sauvegarde(s) trouv√©e(s)${NC}"
            echo ""
            
            echo "$RESPONSE" | jq -r '.saves[] | 
                "ID: \(.id) | \(.saveName)" +
                "\n  Tour: \(.turnNumber) | " +
                (if .isAutoSave then "üîÑ Auto-save" else "üíæ Manuelle" end) +
                "\n  Cr√©√©e: \(.createdAt) | Derni√®re: \(.lastPlayedAt)" +
                "\n  " + (.description // "Pas de description") +
                "\n"'
        else
            echo -e "${RED}‚ùå Erreur r√©cup√©ration sauvegardes${NC}"
            echo "$RESPONSE" | jq -r '.error // "Erreur inconnue"'
        fi
        ;;
    "help"|*)
        show_help
        ;;
esac 