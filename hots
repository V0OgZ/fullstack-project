#!/bin/bash

# Heroes of Time - Script de contrÃ´le principal
# Usage: ./hots [start|stop|status|restart|test|help]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICES_SCRIPT="$SCRIPT_DIR/scripts/actifs/start-services-background.sh"
STOP_SCRIPT="$SCRIPT_DIR/scripts/actifs/stop-all-services.sh"

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${CYAN}ğŸ® Heroes of Time - ContrÃ´le des services${NC}"
    echo -e "${CYAN}=========================================${NC}"
    echo ""
    echo -e "${GREEN}Usage:${NC} ./hots [commande] [options]"
    echo ""
    echo -e "${YELLOW}Commandes disponibles:${NC}"
    echo -e "  ${GREEN}start${NC}       DÃ©marre tous les services en arriÃ¨re-plan"
    echo -e "  ${GREEN}start essential${NC} ğŸ¯ DÃ©marre services essentiels seulement (Backend + Frontend + Dashboard)"
    echo -e "  ${GREEN}stop${NC}        ArrÃªte tous les services"
    echo -e "  ${GREEN}restart${NC}     RedÃ©marre tous les services"
    echo -e "  ${GREEN}status${NC}      Affiche le statut des services"
    echo -e "  ${GREEN}test${NC}        Lance les tests (voir options ci-dessous)"
    echo -e "  ${GREEN}generate${NC}    ğŸ§  GÃ©nÃ¨re la documentation MD depuis JSON (Memento)"
    echo -e "  ${GREEN}map${NC}         ğŸ—ºï¸  Gestion des maps et terrains"
    echo -e "  ${GREEN}replay${NC}      ğŸ“¹ SystÃ¨me de replay des parties"
    echo -e "  ${GREEN}editor${NC}      ğŸ¨ Ã‰diteur visuel script spatio-temporel"
    echo -e "  ${GREEN}admin${NC}       ğŸ® Interface d'administration multijoueur"
    echo -e "  ${GREEN}test-uis${NC}    ğŸ§ª Test complet de toutes les UIs"
    echo -e "  ${GREEN}debug${NC}       ğŸ› Mode debug complet (compilation + logs)"
    echo -e "  ${GREEN}compile${NC}     ğŸ”§ Compilation backend avec debug info"
    echo -e "  ${GREEN}logs${NC}        ğŸ“‹ Affiche les logs en temps rÃ©el"
    echo -e "  ${GREEN}scenario${NC}    ğŸ¬ Lance un scÃ©nario HEP (Heroes Epic Play)"
    echo -e "  ${GREEN}vince${NC}       ğŸ”« Vince Process Annihilator - Nettoie les process avec style!"
    echo -e "  ${GREEN}walter${NC}      ğŸ³ Walter Anti-Vince Protocol - Protection backend"
    echo -e "  ${GREEN}help${NC}        Affiche cette aide"
    echo ""
    echo -e "${YELLOW}Options de test:${NC}"
    echo -e "  ${GREEN}./hots test${NC}              Tests complets (dÃ©faut)"
    echo -e "  ${GREEN}./hots test quick${NC}        Tests rapides (1-2 min)"
    echo -e "  ${GREEN}./hots test ui${NC}           Tests interfaces utilisateur"
    echo -e "  ${GREEN}./hots test backend${NC}      Tests backend uniquement"
    echo -e "  ${GREEN}./hots test maven${NC}        Tests Maven compilation/build"
    echo -e "  ${GREEN}./hots test demo${NC}         DÃ©monstrations interactives"
    echo -e "  ${GREEN}./hots test bataille${NC}     Tests bataille temporelle"
    echo -e "  ${GREEN}./hots test quantum${NC}      Tests quantum/visualiseurs"
    echo -e "  ${GREEN}./hots test scenarios${NC}    Tests scÃ©narios HOTS complets"
    echo -e "  ${GREEN}./hots test json${NC}         ğŸš€ Tests nouveaux scripts JSON (HSP)"
    echo -e "  ${GREEN}./hots test jean-gros${NC}    ğŸ³ Tests Jean-Gros v2/v3 complets"
    echo -e "  ${GREEN}./hots test decay${NC}        ğŸŒ€ Tests systÃ¨me DK20 Temporal Decay (Anna)"
    echo -e "  ${GREEN}./hots test hybrid${NC}       ğŸ³ Tests systÃ¨me Hybrid Decay (The Dude)"
    echo -e "  ${GREEN}./hots test missing${NC}      ğŸ¯ Tests scÃ©narios manquants et crÃ©atures"
    echo -e "  ${GREEN}./hots test creatures${NC}    ğŸ‰ Tests spÃ©cifiques des crÃ©atures quantiques"
    echo -e "  ${GREEN}./hots test performance${NC}  Tests de performance"
    echo -e "  ${GREEN}./hots test integration${NC}  Tests d'intÃ©gration complÃ¨te"
    echo -e "  ${GREEN}./hots test report${NC}       Rapport complet des tests"
    echo -e "  ${GREEN}./hots test final${NC}        ğŸ† TOUS LES TESTS (complet)"
    echo -e "  ${GREEN}./hots test list${NC}         Liste tous les tests disponibles"
    echo -e "  ${GREEN}./hots test economie${NC}     ğŸ® Test simulation Ã©conomique complÃ¨te"
    echo -e "  ${GREEN}./hots test translation${NC}  ğŸ§  Test service traduction intelligent (SANS LLM)"
    echo -e "  ${GREEN}./hots test md-generator${NC} ğŸ“ Test gÃ©nÃ©rateur MD automatique"
    echo ""
    echo -e "${YELLOW}Exemples:${NC}"
    echo -e "  ${CYAN}./hots start${NC}             # DÃ©marre tout"
    echo -e "  ${CYAN}./hots status${NC}            # VÃ©rifie l'Ã©tat"
    echo -e "  ${CYAN}./hots test quick${NC}        # Tests rapides"
    echo -e "  ${CYAN}./hots test maven${NC}        # Test compilation backend"
    echo -e "  ${CYAN}./hots test final${NC}        # ğŸ† TEST COMPLET FINAL"
    echo -e "  ${CYAN}./hots test report${NC}       # Rapport dÃ©taillÃ©"
    echo -e "  ${CYAN}./hots debug${NC}             # ğŸ› Mode debug complet"
    echo -e "  ${CYAN}./hots compile${NC}           # ğŸ”§ Compilation avec debug"
    echo -e "  ${CYAN}./hots logs${NC}              # ğŸ“‹ Logs en temps rÃ©el"
    echo -e "  ${CYAN}./hots generate${NC}          # ğŸ§  GÃ©nÃ¨re tous les MD depuis JSON"
    echo -e "  ${CYAN}./hots map list${NC}          # ğŸ—ºï¸  Liste les maps disponibles"
    echo -e "  ${CYAN}./hots replay center${NC}     # ğŸ¬ Centre de Replay complet"
    echo -e "  ${CYAN}./hots scenario list${NC}     # ğŸ¬ Liste les scÃ©narios HEP disponibles"
    echo -e "  ${CYAN}./hots scenario bataille${NC} # ğŸ¬ Lance bataille temporelle HOTS"
    echo -e "  ${CYAN}./hots scenario anthor${NC}   # ğŸ¬ Lance duel Anthor vs Grofi"
    echo -e "  ${CYAN}./hots editor${NC}            # ğŸ¨ Lance l'Ã©diteur visuel"
    echo -e "  ${CYAN}./hots vince${NC}             # ğŸ”« Nettoie les process lents (animation ROFL)"
    echo -e "  ${CYAN}./hots walter${NC}            # ğŸ³ Protection backend Anti-Vince"
    echo ""
    echo -e "${PURPLE}ğŸ’¾ Commandes de Persistence:${NC}"
    echo -e "  ${GREEN}save${NC} <nom> [game_id] [player]  Sauvegarder la partie"
    echo -e "  ${GREEN}load${NC} <id> [player]            Charger une sauvegarde"
    echo -e "  ${GREEN}list-saves${NC} [player]           Lister les sauvegardes"
    echo ""
    echo -e "${YELLOW}Exemples persistence:${NC}"
    echo -e "  ${CYAN}./hots save ma-partie${NC}        # Sauvegarder la partie courante"
    echo -e "  ${CYAN}./hots load 1${NC}                # Charger la sauvegarde ID 1"
    echo -e "  ${CYAN}./hots list-saves${NC}            # Voir toutes les sauvegardes"
}

check_services() {
    local services_found=0
    
    # VÃ©rifier chaque port
    if lsof -i :9000 >/dev/null 2>&1; then
        echo -e "  âœ… Dashboard (9000) - ACTIF"
        ((services_found++))
    else
        echo -e "  âŒ Dashboard (9000) - ARRÃŠTÃ‰"
    fi
    
    if lsof -i :8000 >/dev/null 2>&1; then
        echo -e "  âœ… Frontend (8000) - ACTIF"
        ((services_found++))
    else
        echo -e "  âŒ Frontend (8000) - ARRÃŠTÃ‰"
    fi
    
    if lsof -i :8080 >/dev/null 2>&1; then
        echo -e "  âœ… Backend API (8080) - ACTIF"
        ((services_found++))
    else
        echo -e "  âŒ Backend API (8080) - ARRÃŠTÃ‰"
    fi
    
    if lsof -i :5174 >/dev/null 2>&1; then
        echo -e "  âœ… Temporal (5174) - ACTIF"
        ((services_found++))
    else
        echo -e "  âŒ Temporal (5174) - ARRÃŠTÃ‰"
    fi
    
    if lsof -i :8001 >/dev/null 2>&1; then
        echo -e "  âœ… Quantum (8001) - ACTIF"
        ((services_found++))
    else
        echo -e "  âŒ Quantum (8001) - ARRÃŠTÃ‰"
    fi
    
    if lsof -i :5175 >/dev/null 2>&1; then
        echo -e "  âœ… Visualizer (5175) - ACTIF"
        ((services_found++))
    else
        echo -e "  âŒ Visualizer (5175) - ARRÃŠTÃ‰"
    fi
    
    if lsof -i :8888 >/dev/null 2>&1; then
        echo -e "  âœ… Test Runner (8888) - ACTIF"
        ((services_found++))
    else
        echo -e "  âŒ Test Runner (8888) - ARRÃŠTÃ‰"
    fi
    
    return $services_found
}

show_status() {
    echo -e "${BLUE}ğŸ” Statut des services Heroes of Time${NC}"
    echo "===================================="
    check_services
    local active_services=$?
    
    echo ""
    echo "URLs d'accÃ¨s:"
    echo -e "  ğŸ¯ Dashboard + ğŸ¬ Replay: ${CYAN}http://localhost:9000/dashboard.html${NC}"
    echo -e "  ğŸ“Š Frontend Principal: ${CYAN}http://localhost:8000${NC}"
    echo -e "  âš™ï¸ Backend API: ${CYAN}http://localhost:8080/api/health${NC}"
    echo -e "  âš”ï¸ Interface Temporelle: ${CYAN}http://localhost:5174${NC}"
    echo -e "  ğŸŒŒ Quantum Visualizer: ${CYAN}http://localhost:8001${NC}"
    echo -e "  ğŸ”® Collection & Grammar: ${CYAN}http://localhost:5175${NC}"
    echo -e "  ğŸ§ª Test Runner: ${CYAN}http://localhost:8888${NC}"
    echo ""
    echo -e "  ${YELLOW}ğŸ’¡ Centre de Replay:${NC} ${CYAN}./hots replay center${NC} ou clic sur ğŸ¬ dans Dashboard"
    
    echo ""
    # ğŸ³ WALTER'S ANTI-SCHRÃ–DINGER FIX - LOGIC BINAIRE PURE !
    if [ $active_services -eq 7 ]; then
        echo -e "${GREEN}ğŸ³ WALTER: TOUS LES SERVICES SONT VRAIMENT ACTIFS ! ($active_services/7)${NC}"
    elif [ $active_services -gt 4 ]; then
        echo -e "${YELLOW}âš ï¸  WALTER: SERVICES PARTIELLEMENT ACTIFS ($active_services/7) - ACCEPTABLE${NC}"
    else
        echo -e "${RED}ğŸš¨ WALTER: SERVICES EN PANNE ! ($active_services/7) - INACCEPTABLE !${NC}"
    fi
}

start_services() {
    echo -e "${BLUE}ğŸš€ DÃ©marrage des services Heroes of Time${NC}"
    echo "========================================"
    
    if [ -f "$SERVICES_SCRIPT" ]; then
        bash "$SERVICES_SCRIPT"
        echo ""
        echo -e "${GREEN}âœ… Services lancÃ©s en arriÃ¨re-plan${NC}"
        echo -e "${YELLOW}ğŸ’¡ Utilisez './hots status' pour vÃ©rifier l'Ã©tat${NC}"
    else
        echo -e "${RED}âŒ Script de dÃ©marrage non trouvÃ©: $SERVICES_SCRIPT${NC}"
        return 1
    fi
}

start_essential_services() {
    echo -e "${BLUE}ğŸ¯ DÃ©marrage des services essentiels Heroes of Time${NC}"
    echo "=================================================="
    echo -e "${YELLOW}Services essentiels : Backend + Frontend + Dashboard${NC}"
    echo ""
    
    # DÃ©marrer le backend
    echo -e "${CYAN}âš™ï¸  DÃ©marrage du Backend (port 8080)...${NC}"
    if [ -d "backend" ]; then
        cd backend
        if mvn spring-boot:run -q > backend.log 2>&1 &
        then
            echo -e "${GREEN}âœ… Backend dÃ©marrÃ©${NC}"
            cd ..
        else
            echo -e "${RED}âŒ Erreur dÃ©marrage backend${NC}"
            cd ..
            return 1
        fi
    else
        echo -e "${RED}âŒ Dossier backend non trouvÃ©${NC}"
        return 1
    fi
    
    # Attendre que le backend soit prÃªt
    echo -e "${YELLOW}â³ Attente du dÃ©marrage backend...${NC}"
    sleep 10
    
    # DÃ©marrer le frontend
    echo -e "${CYAN}ğŸ® DÃ©marrage du Frontend (port 8000)...${NC}"
    if [ -d "frontend" ]; then
        cd frontend
        if python3 -m http.server 8000 > frontend.log 2>&1 &
        then
            echo -e "${GREEN}âœ… Frontend dÃ©marrÃ©${NC}"
            cd ..
        else
            echo -e "${RED}âŒ Erreur dÃ©marrage frontend${NC}"
            cd ..
            return 1
        fi
    else
        echo -e "${RED}âŒ Dossier frontend non trouvÃ©${NC}"
        return 1
    fi
    
    # DÃ©marrer le dashboard
    echo -e "${CYAN}ğŸ¯ DÃ©marrage du Dashboard (port 9000)...${NC}"
    if [ -f "dashboard.html" ]; then
        if python3 -m http.server 9000 > dashboard.log 2>&1 &
        then
            echo -e "${GREEN}âœ… Dashboard dÃ©marrÃ©${NC}"
        else
            echo -e "${RED}âŒ Erreur dÃ©marrage dashboard${NC}"
            return 1
        fi
    else
        echo -e "${RED}âŒ Fichier dashboard.html non trouvÃ©${NC}"
        return 1
    fi
    
    echo ""
    echo -e "${GREEN}âœ… Services essentiels dÃ©marrÃ©s !${NC}"
    echo -e "${YELLOW}ğŸŒ URLs d'accÃ¨s :${NC}"
    echo -e "  ğŸ¯ Dashboard : ${CYAN}http://localhost:9000/dashboard.html${NC}"
    echo -e "  ğŸ® Frontend : ${CYAN}http://localhost:8000${NC}"
    echo -e "  âš™ï¸  Backend API : ${CYAN}http://localhost:8080/api/health${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Pour dÃ©marrer tous les services : ${CYAN}./hots start${NC}"
    echo -e "${YELLOW}ğŸ’¡ Pour vÃ©rifier l'Ã©tat : ${CYAN}./hots status${NC}"
}

stop_services() {
    echo -e "${BLUE}ğŸ›‘ ArrÃªt des services Heroes of Time${NC}"
    echo "====================================="
    
    if [ -f "$STOP_SCRIPT" ]; then
        bash "$STOP_SCRIPT"
        echo ""
        echo -e "${GREEN}âœ… Services arrÃªtÃ©s${NC}"
    else
        echo -e "${RED}âŒ Script d'arrÃªt non trouvÃ©: $STOP_SCRIPT${NC}"
        return 1
    fi
}

restart_services() {
    echo -e "${BLUE}ğŸ”„ RedÃ©marrage des services Heroes of Time${NC}"
    echo "=========================================="
    stop_services
    sleep 2
    start_services
}

# Nouvelles fonctions de test
list_available_tests() {
    echo -e "${CYAN}ğŸ“‹ Tests disponibles dans Heroes of Time${NC}"
    echo -e "${CYAN}=======================================${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ”§ Tests de base:${NC}"
    echo -e "  ${GREEN}quick${NC}         - Tests rapides (1-2 min)"
    echo -e "  ${GREEN}ui${NC}            - Tests interfaces utilisateur"
    echo -e "  ${GREEN}backend${NC}       - Tests backend uniquement"
    echo -e "  ${GREEN}maven${NC}         - Tests Maven compilation/build"
    echo ""
    echo -e "${YELLOW}ğŸ® Tests spÃ©cialisÃ©s:${NC}"
    echo -e "  ${GREEN}demo${NC}          - DÃ©monstrations interactives"
    echo -e "  ${GREEN}bataille${NC}      - Tests bataille temporelle"
    echo -e "  ${GREEN}quantum${NC}       - Tests quantum/visualiseurs"
    echo -e "  ${GREEN}scenarios${NC}     - Tests scÃ©narios HOTS complets"
    echo -e "  ${GREEN}json${NC}          - Tests nouveaux scripts JSON (architecture HSP)"
    echo -e "  ${GREEN}jean-gros${NC}     - Tests Jean-Gros v2/v3 complets"
    echo -e "  ${GREEN}decay${NC}         - Tests systÃ¨me DK20 Temporal Decay (Anna the Martopicker)"
    echo -e "  ${GREEN}hybrid${NC}        - Tests systÃ¨me Hybrid Decay (The Dude's fusion)"
    echo -e "  ${GREEN}performance${NC}   - Tests de performance et optimisation"
    echo -e "  ${GREEN}integration${NC}   - Tests d'intÃ©gration complÃ¨te"
    echo ""
    echo -e "${YELLOW}ğŸ“Š Rapports et analyse:${NC}"
    echo -e "  ${GREEN}report${NC}        - Rapport complet des tests"
    echo -e "  ${GREEN}final${NC}         - Test final complet (tous les tests)"
    echo -e "  ${GREEN}list${NC}          - Cette liste"
    echo ""
    echo -e "${YELLOW}ğŸ“ Scripts de test disponibles:${NC}"
    
    # Lister les scripts de test disponibles
    if [ -d "scripts/test" ]; then
        find scripts/test -name "*.sh" | sort | while read script; do
            echo -e "  ğŸ“„ ${BLUE}$script${NC}"
        done
    fi
    
    if [ -d "scripts/demo" ]; then
        echo ""
        echo -e "${YELLOW}ğŸ¬ Scripts de dÃ©mo disponibles:${NC}"
        find scripts/demo -name "*.sh" | sort | while read script; do
            echo -e "  ğŸ­ ${PURPLE}$script${NC}"
        done
    fi
}

run_test_suite() {
    local test_type="${1:-complete}"
    
    echo -e "${CYAN}ğŸ§ª Lancement des tests Heroes of Time${NC}"
    echo -e "${CYAN}====================================${NC}"
    echo -e "${YELLOW}Type de test: ${test_type}${NC}"
    echo ""
    
    case "$test_type" in
        "quick")
            echo -e "${GREEN}ğŸš€ Tests rapides en cours...${NC}"
            if [ -f "scripts/test/test-ui-quick.sh" ]; then
                bash scripts/test/test-ui-quick.sh
            elif [ -f "scripts/actifs/test-ui-quick.sh" ]; then
                bash scripts/actifs/test-ui-quick.sh
            else
                echo -e "${RED}âŒ Script de test rapide non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "ui")
            echo -e "${GREEN}ğŸ–¥ï¸  Tests d'interface utilisateur...${NC}"
            if [ -f "scripts/test/test-scenarios-ui.sh" ]; then
                bash scripts/test/test-scenarios-ui.sh
            else
                echo -e "${RED}âŒ Script de test UI non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "backend")
            echo -e "${GREEN}âš™ï¸  Tests backend...${NC}"
            if [ -f "scripts/test/test-backend-conformity.sh" ]; then
                bash scripts/test/test-backend-conformity.sh
            else
                echo -e "${RED}âŒ Script de test backend non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "maven")
            echo -e "${GREEN}â˜• Tests Maven compilation...${NC}"
            echo -e "${YELLOW}ğŸ”§ Test compilation backend Maven...${NC}"
            if [ -d "backend" ]; then
                cd backend
                echo "ğŸ“‹ Tentative de compilation Maven..."
                if mvn clean compile -q; then
                    echo -e "${GREEN}âœ… Compilation Maven rÃ©ussie${NC}"
                else
                    echo -e "${RED}âŒ Erreur de compilation Maven${NC}"
                    echo -e "${YELLOW}ğŸ’¡ ProblÃ¨mes connus: executeFormula manquante, JPA entities${NC}"
                fi
                cd ..
            else
                echo -e "${RED}âŒ Dossier backend non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "demo")
            echo -e "${GREEN}ğŸ¬ DÃ©monstrations interactives...${NC}"
            if [ -f "scripts/demo/demo-quantum-final.sh" ]; then
                bash scripts/demo/demo-quantum-final.sh
            else
                echo -e "${RED}âŒ Script de dÃ©mo non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "bataille")
            echo -e "${GREEN}âš”ï¸  Tests bataille temporelle...${NC}"
            if [ -f "scripts/test/test-complete-bataille-temporelle.sh" ]; then
                bash scripts/test/test-complete-bataille-temporelle.sh
            else
                echo -e "${RED}âŒ Script de test bataille non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "quantum")
            echo -e "${GREEN}ğŸŒ€ Tests quantum et visualiseurs...${NC}"
            if [ -f "tester-quantum-ui.sh" ]; then
                bash tester-quantum-ui.sh
            else
                echo -e "${RED}âŒ Script de test quantum non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "scenarios")
            echo -e "${GREEN}ğŸ­ Tests scÃ©narios HOTS...${NC}"
            if [ -f "scripts/test/run-all-hots-scenarios.sh" ]; then
                bash scripts/test/run-all-hots-scenarios.sh
            else
                echo -e "${RED}âŒ Script de test scÃ©narios non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "json")
            echo -e "${GREEN}ğŸš€ Tests nouveaux scripts JSON (architecture HSP)...${NC}"
            echo -e "${YELLOW}ğŸ” Test script panopticon JSON...${NC}"
            if [ -f "scripts/test-panopticon-json-scenario.sh" ]; then
                bash scripts/test-panopticon-json-scenario.sh
            else
                echo -e "${RED}âŒ Script panopticon JSON non trouvÃ©${NC}"
            fi
            
            echo -e "${YELLOW}âš”ï¸ Test script duel collapse JSON...${NC}"
            if [ -f "scripts/test-duel-collapse-json.sh" ]; then
                bash scripts/test-duel-collapse-json.sh
            else
                echo -e "${RED}âŒ Script duel collapse JSON non trouvÃ©${NC}"
            fi
            
            echo -e "${YELLOW}ğŸ® Test runner gÃ©nÃ©rique JSON...${NC}"
            if [ -f "scripts/test-json-scenario-runner.sh" ]; then
                echo "Testing with GROFI_QUICK_TEST scenario..."
                bash scripts/test-json-scenario-runner.sh GROFI_QUICK_TEST
            else
                echo -e "${RED}âŒ Script runner JSON non trouvÃ©${NC}"
            fi
            ;;
        "jean-gros")
            echo -e "${GREEN}ğŸ³ Tests Jean-Gros complets...${NC}"
            echo -e "${YELLOW}ğŸ”§ Lancement Jean-Gros v2 FIXED...${NC}"
            if [ -f "scripts/test-jean-gros-v2-FIXED.sh" ]; then
                bash scripts/test-jean-gros-v2-FIXED.sh
            else
                echo -e "${RED}âŒ Script Jean-Gros v2 non trouvÃ©${NC}"
            fi
            
            echo -e "${YELLOW}ğŸš€ Lancement Jean-Gros v3 WITH JSON...${NC}"
            if [ -f "scripts/test-jean-gros-v3-with-json.sh" ]; then
                bash scripts/test-jean-gros-v3-with-json.sh
            else
                echo -e "${RED}âŒ Script Jean-Gros v3 non trouvÃ©${NC}"
            fi
            ;;
        "decay")
            echo -e "${GREEN}ğŸŒ€ Tests systÃ¨me DK20 Temporal Decay...${NC}"
            echo -e "${PURPLE}ğŸ’« Testing Anna the Martopicker's temporal mechanics${NC}"
            if [ -f "scripts/test-temporal-decay-dk20.sh" ]; then
                bash scripts/test-temporal-decay-dk20.sh
            else
                echo -e "${RED}âŒ Script DK20 Temporal Decay non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "hybrid")
            echo -e "${GREEN}ğŸ³ Tests systÃ¨me Hybrid Decay...${NC}"
            echo -e "${PURPLE}ğŸ’« Testing The Dude's unified temporal decay system${NC}"
            if [ -f "scripts/test-temporal-decay-hybrid-dude.sh" ]; then
                bash scripts/test-temporal-decay-hybrid-dude.sh
            else
                echo -e "${RED}âŒ Script Hybrid Decay non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "performance")
            echo -e "${GREEN}âš¡ Tests de performance...${NC}"
            if [ -f "scripts/test/test-optimizations-performance.sh" ]; then
                bash scripts/test/test-optimizations-performance.sh
            elif [ -f "scripts/test/benchmark-native-vs-script.sh" ]; then
                bash scripts/test/benchmark-native-vs-script.sh
            else
                echo -e "${RED}âŒ Script de test performance non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "integration")
            echo -e "${GREEN}ğŸ”— Tests d'intÃ©gration...${NC}"
            if [ -f "scripts/test/test-integration-complete.sh" ]; then
                bash scripts/test/test-integration-complete.sh
            else
                echo -e "${RED}âŒ Script de test intÃ©gration non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "missing")
            echo -e "${GREEN}ğŸ¯ Tests scÃ©narios manquants et crÃ©atures...${NC}"
            if [ -f "scripts/test-all-missing-scenarios.sh" ]; then
                chmod +x scripts/test-all-missing-scenarios.sh
                bash scripts/test-all-missing-scenarios.sh
            else
                echo -e "${RED}âŒ Script de test scÃ©narios manquants non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "creatures")
            echo -e "${GREEN}ğŸ‰ Tests spÃ©cifiques des crÃ©atures quantiques...${NC}"
            if [ -f "scripts/test-all-missing-scenarios.sh" ]; then
                chmod +x scripts/test-all-missing-scenarios.sh
                bash scripts/test-all-missing-scenarios.sh | grep -E "(CRÃ‰ATURE|ğŸ‰|creature|Luciole|Dragon|Liche|PhÃ©nix)"
            else
                echo -e "${RED}âŒ Script de test crÃ©atures non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "report")
            generate_test_report
            ;;
        "final")
            echo -e "${GREEN}ğŸ† TEST FINAL COMPLET - TOUS LES TESTS${NC}"
            echo -e "${CYAN}=====================================${NC}"
            
            # Lancer tous les tests dans l'ordre
            echo -e "${YELLOW}ğŸš€ Phase 1: Tests rapides${NC}"
            run_test_suite "quick"
            
            echo -e "${YELLOW}ğŸ–¥ï¸  Phase 2: Tests UI${NC}"
            run_test_suite "ui"
            
            echo -e "${YELLOW}âš™ï¸  Phase 3: Tests backend${NC}"
            run_test_suite "backend"
            
            echo -e "${YELLOW}â˜• Phase 4: Tests Maven${NC}"
            run_test_suite "maven"
            
            echo -e "${YELLOW}ğŸ¬ Phase 5: DÃ©monstrations${NC}"
            run_test_suite "demo"
            
            echo -e "${YELLOW}âš”ï¸  Phase 6: Tests bataille${NC}"
            run_test_suite "bataille"
            
            echo -e "${YELLOW}ğŸŒ€ Phase 7: Tests quantum${NC}"
            run_test_suite "quantum"
            
            echo -e "${YELLOW}ğŸ­ Phase 8: Tests scÃ©narios${NC}"
            run_test_suite "scenarios"
            
            echo -e "${YELLOW}ğŸš€ Phase 9: Tests JSON (architecture HSP)${NC}"
            run_test_suite "json"
            
            echo -e "${YELLOW}ğŸ³ Phase 10: Tests Jean-Gros complets${NC}"
            run_test_suite "jean-gros"
            
            echo -e "${YELLOW}ğŸŒ€ Phase 11: Tests DK20 Temporal Decay${NC}"
            run_test_suite "decay"
            
            echo -e "${YELLOW}âš¡ Phase 12: Tests performance${NC}"
            run_test_suite "performance"
            
            echo -e "${YELLOW}ğŸ”— Phase 13: Tests intÃ©gration${NC}"
            run_test_suite "integration"
            
            echo -e "${YELLOW}ğŸ¯ Phase 14: Tests scÃ©narios manquants${NC}"
            run_test_suite "missing"
            
            echo ""
            echo -e "${CYAN}ğŸ† TEST FINAL COMPLET TERMINÃ‰${NC}"
            echo -e "${GREEN}âœ… Toutes les phases de test exÃ©cutÃ©es${NC}"
            
            # Rapport final
            generate_test_report
            ;;
        "list")
            list_available_tests
            ;;
        "economie")
            echo -e "${GREEN}ğŸ® Test simulation Ã©conomique complÃ¨te...${NC}"
            if [ -f "scripts/test/test-economie-guerre.sh" ]; then
                bash scripts/test/test-economie-guerre.sh
            else
                echo -e "${RED}âŒ Script de test Ã©conomique non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "translation")
            echo -e "${GREEN}ğŸ§  Test service traduction intelligent (SANS LLM)...${NC}"
            if [ -f "MUSEUM/scripts-collection/test-smart-translation.py" ]; then
                python3 MUSEUM/scripts-collection/test-smart-translation.py
            else
                echo -e "${RED}âŒ Script de test traduction non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "md-generator")
            echo -e "${GREEN}ğŸ“ Test gÃ©nÃ©rateur MD automatique...${NC}"
            if [ -f "scripts/test/generate-scenario-md.py" ]; then
                python3 scripts/test/generate-scenario-md.py
            else
                echo -e "${RED}âŒ Script gÃ©nÃ©rateur MD non trouvÃ©${NC}"
                return 1
            fi
            ;;
        "complete"|*)
            echo -e "${GREEN}ğŸ”¬ Tests complets en cours...${NC}"
            if [ -f "scripts/test/test-complet-final.sh" ]; then
                bash scripts/test/test-complet-final.sh
            elif [ -f "test-complet-final.sh" ]; then
                bash test-complet-final.sh
            else
                echo -e "${RED}âŒ Script de test complet non trouvÃ©${NC}"
                return 1
            fi
            ;;
    esac
}

generate_test_report() {
    echo -e "${CYAN}ğŸ“Š Rapport complet des tests Heroes of Time${NC}"
    echo -e "${CYAN}===========================================${NC}"
    echo ""
    
    # VÃ©rifier l'Ã©tat des services
    echo -e "${YELLOW}ğŸ” Ã‰tat des services:${NC}"
    check_services
    local active_services=$?
    echo ""
    
    # VÃ©rifier le Test Runner
    echo -e "${YELLOW}ğŸ§ª Test Runner Analysis:${NC}"
    if lsof -i :8888 >/dev/null 2>&1; then
        echo -e "  âœ… Test Runner actif sur port 8888"
        echo -e "  ğŸŒ Interface: ${CYAN}http://localhost:8888${NC}"
        
        # Analyser les tests disponibles dans le Test Runner
        if [ -f "test-runner-interface.html" ]; then
            echo -e "  ğŸ“‹ Interface HTML: ${GREEN}Disponible${NC}"
            
            # Extraire les tests configurÃ©s
            echo -e "  ğŸ¯ Tests configurÃ©s dans l'interface:"
            grep -o "script: '[^']*'" test-runner-interface.html 2>/dev/null | sed "s/script: '/    ğŸ“„ /" | sed "s/'$//"
        fi
        
        if [ -f "test-runner-server.py" ]; then
            echo -e "  ğŸ Serveur Python: ${GREEN}Disponible${NC}"
        fi
    else
        echo -e "  âŒ Test Runner non actif"
    fi
    echo ""
    
    # Analyser les scripts de test disponibles
    echo -e "${YELLOW}ğŸ“ Scripts de test disponibles:${NC}"
    local test_count=0
    
    if [ -d "scripts/test" ]; then
        while IFS= read -r script; do
            if [ -f "$script" ]; then
                local size=$(du -h "$script" 2>/dev/null | cut -f1)
                local name=$(basename "$script")
                echo -e "  ğŸ“„ ${GREEN}$name${NC} (${size})"
                ((test_count++))
            fi
        done < <(find scripts/test -name "*.sh" | sort)
    fi
    
    if [ -d "scripts/demo" ]; then
        echo ""
        echo -e "${YELLOW}ğŸ¬ Scripts de dÃ©mo disponibles:${NC}"
        while IFS= read -r script; do
            if [ -f "$script" ]; then
                local size=$(du -h "$script" 2>/dev/null | cut -f1)
                local name=$(basename "$script")
                echo -e "  ğŸ­ ${PURPLE}$name${NC} (${size})"
                ((test_count++))
            fi
        done < <(find scripts/demo -name "*.sh" | sort)
    fi
    
    echo ""
    echo -e "${YELLOW}ğŸ” Tests racine disponibles:${NC}"
    for script in test-*.sh tester-*.sh; do
        if [ -f "$script" ]; then
            local size=$(du -h "$script" 2>/dev/null | cut -f1)
            echo -e "  ğŸ§ª ${BLUE}$script${NC} (${size})"
            ((test_count++))
        fi
    done
    
    # Analyser le backend Maven
    echo ""
    echo -e "${YELLOW}â˜• Analyse Backend Maven:${NC}"
    if [ -f "backend/pom.xml" ]; then
        echo -e "  ğŸ“„ pom.xml: ${GREEN}Disponible${NC}"
        if [ -d "backend/src/main/java" ]; then
            local java_files=$(find backend/src/main/java -name "*.java" | wc -l)
            echo -e "  â˜• Fichiers Java: ${GREEN}$java_files fichiers${NC}"
        fi
        if [ -d "backend/target" ]; then
            echo -e "  ğŸ¯ Target Maven: ${GREEN}PrÃ©sent${NC}"
        else
            echo -e "  ğŸ¯ Target Maven: ${YELLOW}Absent (pas compilÃ©)${NC}"
        fi
        
        # Test de compilation rapide
        echo -e "  ğŸ”§ Test compilation rapide..."
        if (cd backend && mvn compile -q >/dev/null 2>&1); then
            echo -e "  âœ… Compilation: ${GREEN}RÃ©ussie${NC}"
        else
            echo -e "  âŒ Compilation: ${RED}Ã‰choue${NC}"
            echo -e "    ğŸ’¡ ProblÃ¨mes connus: executeFormula manquante, JPA entities"
        fi
    else
        echo -e "  âŒ Backend Maven non trouvÃ©"
    fi
    
    # Analyser les frontends
    echo ""
    echo -e "${YELLOW}ğŸ–¥ï¸  Analyse Frontends:${NC}"
    local frontend_count=0
    for frontend_dir in frontend frontend-temporal frontend-legendary-ui quantum-visualizer; do
        if [ -d "$frontend_dir" ] && [ -f "$frontend_dir/index.html" ]; then
            local size=$(du -sh "$frontend_dir" 2>/dev/null | cut -f1)
            echo -e "  ğŸ“ ${GREEN}$frontend_dir${NC} (${size})"
            ((frontend_count++))
        fi
    done
    echo -e "  ğŸ“Š Total frontends: ${GREEN}$frontend_count${NC}"
    
    # Analyser les scÃ©narios et assets
    echo ""
    echo -e "${YELLOW}ğŸ­ Analyse ScÃ©narios et Assets:${NC}"
    if [ -d "game_assets/scenarios" ]; then
        local hots_files=$(find game_assets/scenarios -name "*.hots" | wc -l)
        local json_files=$(find game_assets/scenarios -name "*.json" | wc -l)
        echo -e "  ğŸ“„ Fichiers HOTS: ${GREEN}$hots_files${NC}"
        echo -e "  ğŸ“„ Fichiers JSON: ${GREEN}$json_files${NC}"
    else
        echo -e "  âŒ Dossier game_assets/scenarios non trouvÃ©"
    fi
    
    echo ""
    echo -e "${YELLOW}ğŸ“Š RÃ©sumÃ© du rapport:${NC}"
    echo -e "  ğŸ® Services actifs: ${GREEN}$active_services/6${NC}"
    echo -e "  ğŸ§ª Scripts de test: ${GREEN}$test_count${NC}"
    echo -e "  ğŸ–¥ï¸  Frontends: ${GREEN}$frontend_count${NC}"
    echo -e "  ğŸŒ Test Runner: $(if lsof -i :8888 >/dev/null 2>&1; then echo -e "${GREEN}Actif${NC}"; else echo -e "${RED}Inactif${NC}"; fi)"
    echo -e "  â˜• Backend Maven: $(if [ -f "backend/pom.xml" ]; then echo -e "${GREEN}Disponible${NC}"; else echo -e "${RED}Manquant${NC}"; fi)"
    
    # Ã‰tat de santÃ© global
    echo ""
    echo -e "${YELLOW}ğŸ¥ Ã‰tat de santÃ© global:${NC}"
    local health_score=0
    
    if [ $active_services -ge 4 ]; then ((health_score += 25)); fi
    if [ $test_count -ge 20 ]; then ((health_score += 25)); fi
    if lsof -i :8888 >/dev/null 2>&1; then ((health_score += 25)); fi
    if [ -f "backend/pom.xml" ]; then ((health_score += 25)); fi
    
    if [ $health_score -ge 90 ]; then
        echo -e "  ğŸŸ¢ ${GREEN}Excellent${NC} ($health_score/100)"
    elif [ $health_score -ge 70 ]; then
        echo -e "  ğŸŸ¡ ${YELLOW}Bon${NC} ($health_score/100)"
    elif [ $health_score -ge 50 ]; then
        echo -e "  ğŸŸ  ${YELLOW}Moyen${NC} ($health_score/100)"
    else
        echo -e "  ğŸ”´ ${RED}NÃ©cessite attention${NC} ($health_score/100)"
    fi
    
    # Recommandations
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Recommandations:${NC}"
    
    if [ $active_services -lt 6 ]; then
        echo -e "  âš ï¸  DÃ©marrer tous les services: ${CYAN}./hots start${NC}"
    fi
    
    if ! lsof -i :8888 >/dev/null 2>&1; then
        echo -e "  ğŸ§ª Lancer le Test Runner: ${CYAN}python3 test-runner-server.py 8888 &${NC}"
    fi
    
    if [ -f "backend/pom.xml" ] && ! (cd backend && mvn compile -q >/dev/null 2>&1); then
        echo -e "  ğŸ”§ RÃ©parer backend Maven: ${CYAN}./hots test maven${NC}"
    fi
    
    echo -e "  ğŸš€ Tests rapides: ${CYAN}./hots test quick${NC}"
    echo -e "  ğŸ¬ DÃ©monstration: ${CYAN}./hots test demo${NC}"
    echo -e "  ğŸ† Test final complet: ${CYAN}./hots test final${NC}"
    echo -e "  ğŸ“‹ Liste complÃ¨te: ${CYAN}./hots test list${NC}"
    
    echo ""
    echo -e "${CYAN}ğŸ“ˆ Pour un diagnostic complet, utilisez: ${GREEN}./hots test final${NC}"
}

# ğŸ§  Fonction de gÃ©nÃ©ration MD - Memento
generate_md_docs() {
    echo -e "${CYAN}ğŸ§  MEMENTO - GÃ©nÃ©rateur de Documentation MD${NC}"
    echo -e "${CYAN}============================================${NC}"
    echo ""
    
    if [ ! -f "scripts/generate-md-from-json.py" ]; then
        echo -e "${RED}âŒ GÃ©nÃ©rateur MD non trouvÃ©: scripts/generate-md-from-json.py${NC}"
        return 1
    fi
    
    echo -e "${YELLOW}ğŸ”„ GÃ©nÃ©ration automatique des fichiers Markdown...${NC}"
    python3 scripts/generate-md-from-json.py
    
    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}âœ… GÃ©nÃ©ration terminÃ©e avec succÃ¨s !${NC}"
        echo -e "${YELLOW}ğŸ“ Fichiers gÃ©nÃ©rÃ©s dans :${NC}"
        echo -e "  - ${CYAN}docs/artifacts/generated/${NC}"
        echo -e "  - ${CYAN}docs/heroes/generated/${NC}"
        echo -e "  - ${CYAN}docs/creatures/generated/${NC}"
    else
        echo -e "${RED}âŒ Erreur lors de la gÃ©nÃ©ration${NC}"
        return 1
    fi
}

# ğŸ—ºï¸ Fonctions MAP
manage_maps() {
    local action="$1"
    
    case "$action" in
        "list"|"")
            echo -e "${CYAN}ğŸ—ºï¸  SYSTÃˆME MAP - Heroes of Time${NC}"
            echo -e "${CYAN}================================${NC}"
            echo ""
            echo -e "${YELLOW}ğŸ“ Maps disponibles :${NC}"
            
            if [ -d "game_assets/scenarios/maps/templates" ]; then
                find game_assets/scenarios/maps/templates -name "*.hsp" -o -name "*.json" | while read map; do
                    local name=$(basename "$map")
                    local size=$(du -sh "$map" 2>/dev/null | cut -f1)
                    echo -e "  ğŸ“„ ${GREEN}$name${NC} (${size})"
                done
            else
                echo -e "  âŒ Dossier templates non trouvÃ©"
            fi
            
            echo ""
            echo -e "${YELLOW}ğŸ® Commandes disponibles :${NC}"
            echo -e "  ${GREEN}./hots map list${NC}          # Liste les maps"
            echo -e "  ${GREEN}./hots map create <name>${NC}  # CrÃ©er une nouvelle map"
            echo -e "  ${GREEN}./hots map info <name>${NC}    # Infos sur une map"
            ;;
        "create")
            local map_name="$2"
            if [ -z "$map_name" ]; then
                echo -e "${RED}âŒ Usage: ./hots map create <nom_de_la_map>${NC}"
                return 1
            fi
            
            echo -e "${YELLOW}ğŸ”§ CrÃ©ation de la map: $map_name${NC}"
            echo -e "${GREEN}âœ… Map crÃ©Ã©e (fonctionnalitÃ© Ã  implÃ©menter)${NC}"
            ;;
        "info")
            local map_name="$2"
            echo -e "${YELLOW}ğŸ“Š Informations sur la map: $map_name${NC}"
            echo -e "${GREEN}âœ… Infos map (fonctionnalitÃ© Ã  implÃ©menter)${NC}"
            ;;
        *)
            echo -e "${RED}âŒ Action inconnue: $action${NC}"
            echo -e "${YELLOW}Actions disponibles: list, create, info${NC}"
            return 1
            ;;
    esac
}

# ğŸ“¹ Fonctions REPLAY
manage_replays() {
    local action="$1"
    
    case "$action" in
        "list"|"")
            echo -e "${CYAN}ğŸ“¹ SYSTÃˆME REPLAY - Heroes of Time${NC}"
            echo -e "${CYAN}==================================${NC}"
            echo ""
            echo -e "${YELLOW}ğŸ¬ Replays disponibles :${NC}"
            
            if [ -d "game_assets/scenarios/maps/replays" ]; then
                find game_assets/scenarios/maps/replays -name "*.hsp" -o -name "*.json" | while read replay; do
                    local name=$(basename "$replay" | sed 's/\.[^.]*$//')
                    local size=$(du -sh "$replay" 2>/dev/null | cut -f1)
                    local date=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$replay" 2>/dev/null)
                    echo -e "  ğŸ¬ ${GREEN}$name${NC} (${size}) - $date"
                done
            else
                echo -e "  âŒ Aucun replay trouvÃ©"
            fi
            
            echo ""
            echo -e "${YELLOW}ğŸ® Commandes disponibles :${NC}"
                echo -e "  ${GREEN}./hots replay list${NC}           # Liste les replays"
    echo -e "  ${GREEN}./hots replay center${NC}         # ğŸ¬ Ouvre le Centre de Replay (dashboard)"
    echo -e "  ${GREEN}./hots replay view <name>${NC}     # Voir un replay spÃ©cifique"
    echo -e "  ${GREEN}./hots replay analyze <name>${NC}  # Analyser un replay (infos dÃ©taillÃ©es)"
    echo -e "  ${GREEN}./hots replay save <name>${NC}     # Sauvegarder partie actuelle"
            ;;
        "view")
            local replay_name="$2"
            if [ -z "$replay_name" ]; then
                echo -e "${RED}âŒ Usage: ./hots replay view <nom_du_replay>${NC}"
                return 1
            fi
            
            echo -e "${YELLOW}ğŸ¬ Visualisation du replay: $replay_name${NC}"
            echo -e "${GREEN}âœ… Ouverture du Centre de Replay...${NC}"
            
            # VÃ©rifier que le dashboard est actif
            if ! curl -s http://localhost:9000/dashboard.html > /dev/null; then
                echo -e "${RED}âŒ Dashboard non accessible sur le port 9000${NC}"
                echo -e "${YELLOW}ğŸ’¡ Lancez d'abord: ./hots start${NC}"
                return 1
            fi
            
            echo -e "${CYAN}ğŸ¬ Ouverture du Centre de Replay dans le navigateur...${NC}"
            if command -v open > /dev/null; then
                # macOS
                open "http://localhost:9000/dashboard.html"
            elif command -v xdg-open > /dev/null; then
                # Linux
                xdg-open "http://localhost:9000/dashboard.html"
            else
                echo -e "${YELLOW}ğŸ“‹ AccÃ©dez manuellement Ã : http://localhost:9000/dashboard.html${NC}"
                echo -e "${YELLOW}   Puis cliquez sur 'ğŸ¬ Centre de Replay'${NC}"
            fi
            ;;
        "center"|"centre")
            echo -e "${CYAN}ğŸ¬ Ouverture du Centre de Replay Heroes of Time${NC}"
            
            # VÃ©rifier que le dashboard est actif
            if ! curl -s http://localhost:9000/dashboard.html > /dev/null; then
                echo -e "${RED}âŒ Dashboard non accessible sur le port 9000${NC}"
                echo -e "${YELLOW}ğŸ’¡ Lancez d'abord: ./hots start${NC}"
                return 1
            fi
            
            echo -e "${GREEN}âœ… Dashboard actif - Ouverture du navigateur...${NC}"
            if command -v open > /dev/null; then
                # macOS
                open "http://localhost:9000/dashboard.html"
            elif command -v xdg-open > /dev/null; then
                # Linux  
                xdg-open "http://localhost:9000/dashboard.html"
            else
                echo -e "${YELLOW}ğŸ“‹ AccÃ©dez manuellement Ã : http://localhost:9000/dashboard.html${NC}"
                echo -e "${YELLOW}   Puis cliquez sur 'ğŸ¬ Centre de Replay'${NC}"
            fi
            ;;
        "analyze")
            local replay_name="$2"
            echo -e "${YELLOW}ğŸ“Š Analyse du replay: $replay_name${NC}"
            
            # Chercher le fichier de replay
            local replay_file=""
            if [ -f "game_assets/scenarios/maps/replays/20250721_session_jean/$replay_name.hsp" ]; then
                replay_file="game_assets/scenarios/maps/replays/20250721_session_jean/$replay_name.hsp"
            elif [ -f "game_assets/scenarios/visualizer/$replay_name.hsp" ]; then
                replay_file="game_assets/scenarios/visualizer/$replay_name.hsp"
            fi
            
            if [ -n "$replay_file" ]; then
                echo -e "${GREEN}ğŸ“„ Fichier trouvÃ©: $replay_file${NC}"
                echo -e "${CYAN}ğŸ“Š Informations du replay:${NC}"
                
                # Extraire les infos JSON
                if command -v jq > /dev/null; then
                    echo -e "${YELLOW}ğŸ® Nom du jeu:${NC} $(jq -r '.replayInfo.gameName // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}ğŸ“… Date:${NC} $(jq -r '.replayInfo.date // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}â±ï¸ DurÃ©e:${NC} $(jq -r '.replayInfo.duration // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}ğŸ† Gagnant:${NC} $(jq -r '.replayInfo.winner // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}ğŸ‘¥ Joueurs:${NC} $(jq -r '.replayInfo.players | join(", ") // "N/A"' "$replay_file" 2>/dev/null)"
                    echo -e "${YELLOW}ğŸ”„ Tours:${NC} $(jq -r '.replayInfo.totalTurns // "N/A"' "$replay_file" 2>/dev/null)"
                else
                    head -20 "$replay_file"
                fi
            else
                echo -e "${RED}âŒ Replay '$replay_name' non trouvÃ©${NC}"
                echo -e "${YELLOW}ğŸ’¡ Utilisez: ./hots replay list${NC}"
            fi
            ;;
        "save")
            local replay_name="$2"
            echo -e "${YELLOW}ğŸ’¾ Sauvegarde de la partie actuelle: $replay_name${NC}"
            echo -e "${GREEN}âœ… FonctionnalitÃ© de sauvegarde (Ã  connecter au backend)${NC}"
            ;;
        *)
            echo -e "${RED}âŒ Action inconnue: $action${NC}"
            echo -e "${YELLOW}Actions disponibles: list, view, analyze, save${NC}"
            return 1
            ;;
    esac
}

# ğŸ¨ Fonction Ã‰DITEUR VISUEL
launch_visual_editor() {
    echo -e "${CYAN}ğŸ¨ Ã‰DITEUR VISUEL SCRIPT SPATIO-TEMPOREL - Heroes of Time${NC}"
    echo -e "${CYAN}========================================================${NC}"
    echo ""
    
    # VÃ©rifier que le frontend est actif
    if ! curl -s http://localhost:8000 > /dev/null; then
        echo -e "${RED}âŒ Frontend non accessible sur le port 8000${NC}"
        echo -e "${YELLOW}ğŸ’¡ Lancez d'abord: ./hots start essential${NC}"
        return 1
    fi
    
    echo -e "${GREEN}âœ… Frontend actif - Ouverture de l'Ã©diteur visuel...${NC}"
    if command -v open > /dev/null; then
        # macOS
        open "http://localhost:8000/visual-script-editor.html"
    elif command -v xdg-open > /dev/null; then
        # Linux  
        xdg-open "http://localhost:8000/visual-script-editor.html"
    else
        echo -e "${YELLOW}ğŸ“‹ AccÃ©dez manuellement Ã : http://localhost:8000/visual-script-editor.html${NC}"
    fi
    
    echo -e "${CYAN}ğŸ¨ FonctionnalitÃ©s de l'Ã©diteur:${NC}"
    echo -e "  ğŸš¶ Actions de base (MOV, USE, CREATE, HERO, BATTLE)"
    echo -e "  Ïˆ Actions temporelles (PSI, TRIGGER, COLLAPSE)"
    echo -e "  â° Timeline Editor avec branches multiples"
    echo -e "  ğŸ® Game Board interactif"
    echo -e "  ğŸ”§ SystÃ¨me de macros personnalisÃ©es"
    echo -e "  ğŸ“œ GÃ©nÃ©ration automatique de scripts"
    echo -e "  ğŸ’¾ Sauvegarde/chargement de configurations"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ RÃ©volution du game design:${NC}"
    echo -e "  â€¢ Premier IDE visuel de scripting quantico-temporel au monde"
    echo -e "  â€¢ Point-and-click â†’ Scripts complexes automatiques"
    echo -e "  â€¢ Visualisation des superpositions et causalitÃ©s"
    echo -e "  â€¢ Macros personnalisÃ©es pour actions rapides"
}

# ğŸ® Fonction INTERFACE ADMIN MULTIJOUEUR
launch_admin_interface() {
    echo -e "${CYAN}ğŸ® INTERFACE D'ADMINISTRATION MULTIJOUEUR - Heroes of Time${NC}"
    echo -e "${CYAN}========================================================${NC}"
    echo ""
    
    # VÃ©rifier que les services sont actifs
    if ! curl -s http://localhost:8080 > /dev/null; then
        echo -e "${RED}âŒ Backend non accessible sur le port 8080${NC}"
        echo -e "${YELLOW}ğŸ’¡ Lancez d'abord: ./hots start essential${NC}"
        return 1
    fi
    
    if ! curl -s http://localhost:8000 > /dev/null; then
        echo -e "${RED}âŒ Frontend non accessible sur le port 8000${NC}"
        echo -e "${YELLOW}ğŸ’¡ Lancez d'abord: ./hots start essential${NC}"
        return 1
    fi
    
    echo -e "${GREEN}âœ… Services vÃ©rifiÃ©s${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ® Lancement de l'interface d'administration multijoueur...${NC}"
    echo ""
    
    # Ouvrir l'interface dans le navigateur
    if command -v open > /dev/null; then
        open "http://localhost:8000/admin-multiplayer.html"
    elif command -v xdg-open > /dev/null; then
        xdg-open "http://localhost:8000/admin-multiplayer.html"
    else
        echo -e "${YELLOW}ğŸŒ Ouvrez manuellement: http://localhost:8000/admin-multiplayer.html${NC}"
    fi
    
    echo -e "${GREEN}ğŸ® Interface d'administration lancÃ©e !${NC}"
    echo ""
    echo -e "${CYAN}ğŸ“‹ FonctionnalitÃ©s disponibles:${NC}"
    echo -e "  ğŸ—ï¸  Gestion des jeux (crÃ©er, lister, supprimer)"
    echo -e "  ğŸ‘¥ Gestion des joueurs (ajouter, expulser)"
    echo -e "  ğŸ¦¸ Gestion des hÃ©ros (apparaÃ®tre, tÃ©lÃ©porter, supprimer)"
    echo -e "  ğŸ¯ ContrÃ´le du jeu (pause, tour suivant, reset, fin)"
    echo -e "  ğŸš€ DÃ©marrage rapide multijoueur"
    echo -e "  ğŸ§ª Tests complets du systÃ¨me"
    echo -e "  ğŸ¬ DÃ©mo multijoueur"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Mode Administrateur - Jean sur le canapÃ©${NC}"
    echo -e "${YELLOW}ğŸ’¡ Protocole Memento - Fusion Claudius activÃ©e${NC}"
}

# Fonction pour gÃ©rer les scÃ©narios HEP
manage_scenarios() {
    local command="$1"
    local scenario_name="$2"
    
    echo -e "${PURPLE}ğŸ¬ Gestionnaire de ScÃ©narios HEP (Heroes Epic Play)${NC}"
    echo -e "${PURPLE}==============================================${NC}"
    
    case "$command" in
        "list"|"")
            echo -e "${YELLOW}ğŸ“‹ ScÃ©narios HEP disponibles:${NC}"
            echo ""
            
            if [ -d "game_assets/scenarios/hots" ]; then
                echo -e "${CYAN}ğŸ¬ ScÃ©narios HOTS (.hots):${NC}"
                find game_assets/scenarios/hots -name "*.hots" -type f | while read file; do
                    local filename=$(basename "$file" .hots)
                    local size=$(du -h "$file" 2>/dev/null | cut -f1)
                    echo -e "  ğŸ“„ ${GREEN}$filename${NC} (${size})"
                done
            fi
            
            if [ -d "game_assets/scenarios" ]; then
                echo ""
                echo -e "${CYAN}ğŸ® ScÃ©narios JSON classiques:${NC}"
                find game_assets/scenarios -name "*.json" -type f | while read file; do
                    local filename=$(basename "$file" .json)
                    local size=$(du -h "$file" 2>/dev/null | cut -f1)
                    echo -e "  ğŸ“„ ${BLUE}$filename${NC} (${size})"
                done
            fi
            
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Usage: ./hots scenario [nom_scenario]${NC}"
            echo -e "${YELLOW}ğŸ’¡ Exemple: ./hots scenario bataille${NC}"
            ;;
            
        "bataille"|"bataille_temporelle")
            echo -e "${YELLOW}âš”ï¸  Lancement de la Bataille Temporelle ComplÃ¨te...${NC}"
            local scenario_file="game_assets/scenarios/hots/bataille_temporelle_complete.hots"
            if [ -f "$scenario_file" ]; then
                echo -e "${GREEN}âœ… ScÃ©nario trouvÃ©: $scenario_file${NC}"
                echo -e "${CYAN}ğŸ“Š Analyse du scÃ©nario:${NC}"
                wc -l "$scenario_file"
                echo ""
                if [ -x "scripts/test-anthor-ford-scenario.sh" ]; then
                    echo -e "${BLUE}ğŸ¯ Lancement avec moteur de test intÃ©grÃ©...${NC}"
                    ./scripts/test-anthor-ford-scenario.sh "$scenario_file"
                else
                    echo -e "${YELLOW}âš ï¸  Moteur de test non trouvÃ©, lancement simulÃ©...${NC}"
                    echo -e "${CYAN}ğŸ¬ Contenu du scÃ©nario:${NC}"
                    head -20 "$scenario_file"
                    echo -e "${YELLOW}... (contenu tronquÃ©)${NC}"
                fi
            else
                echo -e "${RED}âŒ ScÃ©nario non trouvÃ©: $scenario_file${NC}"
            fi
            ;;
            
        "anthor"|"anthor_vs_grofi")
            echo -e "${YELLOW}ğŸ­ Lancement du Duel Anthor vs Jean-Grofignon...${NC}"
            local scenario_file="game_assets/scenarios/hots/anthor_vs_grofi_temporal_duel.hots"
            if [ -f "$scenario_file" ]; then
                echo -e "${GREEN}âœ… ScÃ©nario trouvÃ©: $scenario_file${NC}"
                echo -e "${CYAN}ğŸ“Š Analyse du scÃ©nario:${NC}"
                wc -l "$scenario_file"
                echo ""
                if [ -x "scripts/test-anthor-ford-scenario.sh" ]; then
                    echo -e "${BLUE}ğŸ¯ Lancement du test Anthor spÃ©cialisÃ©...${NC}"
                    ./scripts/test-anthor-ford-scenario.sh
                else
                    echo -e "${YELLOW}âš ï¸  Moteur de test Anthor non trouvÃ©, affichage du scÃ©nario...${NC}"
                    echo -e "${CYAN}ğŸ¬ Extrait du duel Ã©pique:${NC}"
                    grep -E "(HERO|SAY|ABILITY)" "$scenario_file" | head -10
                    echo -e "${YELLOW}... (plus de contenu disponible)${NC}"
                fi
            else
                echo -e "${RED}âŒ ScÃ©nario non trouvÃ©: $scenario_file${NC}"
            fi
            ;;
            
        *)
            echo -e "${YELLOW}ğŸ” Recherche du scÃ©nario: $command${NC}"
            local found=false
            
            # Chercher dans les fichiers .hots
            if [ -d "game_assets/scenarios/hots" ]; then
                for file in game_assets/scenarios/hots/*.hots; do
                    if [[ "$(basename "$file" .hots)" == *"$command"* ]]; then
                        echo -e "${GREEN}âœ… ScÃ©nario HOTS trouvÃ©: $(basename "$file")${NC}"
                        echo -e "${CYAN}ğŸ“Š Analyse:${NC}"
                        wc -l "$file"
                        echo -e "${CYAN}ğŸ¬ AperÃ§u:${NC}"
                        head -10 "$file"
                        found=true
                        break
                    fi
                done
            fi
            
            # Chercher dans les fichiers JSON
            if [ ! "$found" = true ] && [ -d "game_assets/scenarios" ]; then
                for file in game_assets/scenarios/*.json; do
                    if [[ "$(basename "$file" .json)" == *"$command"* ]]; then
                        echo -e "${GREEN}âœ… ScÃ©nario JSON trouvÃ©: $(basename "$file")${NC}"
                        echo -e "${CYAN}ğŸ“Š Analyse:${NC}"
                        wc -l "$file"
                        echo -e "${CYAN}ğŸ¬ AperÃ§u:${NC}"
                        head -10 "$file"
                        found=true
                        break
                    fi
                done
            fi
            
            if [ ! "$found" = true ]; then
                echo -e "${RED}âŒ ScÃ©nario '$command' non trouvÃ©${NC}"
                echo -e "${YELLOW}ğŸ’¡ Utilisez './hots scenario list' pour voir les scÃ©narios disponibles${NC}"
            fi
            ;;
    esac
}

# Fonction principale
case "${1:-help}" in
    "start")
        if [ "$2" = "essential" ]; then
            start_essential_services
        else
            start_services
        fi
        ;;
    "stop")
        stop_services
        ;;
    "restart")
        restart_services
        ;;
    "status")
        show_status
        ;;
    "test")
        run_test_suite "$2"
        ;;
    "generate")
        generate_md_docs
        ;;
    "map")
        manage_maps "$2" "$3"
        ;;
    "replay")
        manage_replays "$2" "$3"
        ;;
    "editor")
        launch_visual_editor
        ;;
    "admin")
        launch_admin_interface
        ;;
    "test-uis")
        run_test_suite "ui"
        ;;
    "debug")
        echo -e "${BLUE}ğŸ› Mode debug actif - Lancement de la compilation avec debug info...${NC}"
        if [ -d "backend" ]; then
            cd backend
            echo -e "${YELLOW}ğŸ”§ Compilation avec debug info...${NC}"
            mvn clean compile -e -X > ../debug-compile.log 2>&1
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}âœ… Compilation rÃ©ussie avec debug info${NC}"
                echo -e "${CYAN}ğŸ“‹ Logs sauvegardÃ©s dans: debug-compile.log${NC}"
            else
                echo -e "${RED}âŒ Erreurs de compilation dÃ©tectÃ©es${NC}"
                echo -e "${YELLOW}ğŸ“‹ VÃ©rifiez debug-compile.log pour les dÃ©tails${NC}"
                tail -20 ../debug-compile.log
            fi
            cd ..
        else
            echo -e "${RED}âŒ Dossier backend non trouvÃ©${NC}"
        fi
        ;;
    "compile")
        echo -e "${BLUE}ğŸ”§ Compilation backend avec debug info...${NC}"
        if [ -d "backend" ]; then
            cd backend
            echo -e "${YELLOW}ğŸ§¹ Nettoyage...${NC}"
            mvn clean
            echo -e "${YELLOW}ğŸ”§ Compilation avec debug...${NC}"
            mvn compile -e -X -Dorg.slf4j.simpleLogger.defaultLogLevel=debug
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}âœ… Compilation rÃ©ussie${NC}"
                echo -e "${CYAN}ğŸ“‹ PrÃªt pour le dÃ©marrage en mode debug${NC}"
            else
                echo -e "${RED}âŒ Erreurs de compilation${NC}"
                echo -e "${YELLOW}ğŸ’¡ Utilisez './hots debug' pour plus de dÃ©tails${NC}"
            fi
            cd ..
        else
            echo -e "${RED}âŒ Dossier backend non trouvÃ©${NC}"
        fi
        ;;
    "logs")
        echo -e "${BLUE}ğŸ“‹ Affichage des logs en temps rÃ©el...${NC}"
        echo -e "${YELLOW}ğŸ’¡ Appuyez sur Ctrl+C pour arrÃªter${NC}"
        echo ""
        
        # Logs backend
        if [ -f "backend.log" ]; then
            echo -e "${CYAN}ğŸ”§ Logs Backend:${NC}"
            tail -f backend.log &
        fi
        
        # Logs debug
        if [ -f "debug-compile.log" ]; then
            echo -e "${CYAN}ğŸ› Logs Debug:${NC}"
            tail -f debug-compile.log &
        fi
        
        # Attendre l'interruption
        wait
        ;;
    "scenario")
        manage_scenarios "$2" "$3"
        ;;
    "vince")
        echo -e "${PURPLE}ğŸ”« Lancement de Vince's Process Annihilator !${NC}"
        echo -e "${YELLOW}ğŸ’€ 'Say hello to my little friend... the SIGKILL!'${NC}"
        echo ""
        
        if [ -x "scripts/vince-process-annihilator.sh" ]; then
            ./scripts/vince-process-annihilator.sh
        else
            echo -e "${RED}âŒ Script vince-process-annihilator.sh non trouvÃ© ou non exÃ©cutable${NC}"
            echo -e "${YELLOW}ğŸ’¡ VÃ©rifiez scripts/vince-process-annihilator.sh${NC}"
        fi
        ;;
    "walter")
        echo -e "${BLUE}ğŸ³ Activation du Walter's Anti-Vince Protocol !${NC}"
        echo -e "${YELLOW}ğŸ’€ 'This aggression will not stand, man!'${NC}"
        echo ""
        
        if [ -x "scripts/walter-anti-vince-protocol.sh" ]; then
            ./scripts/walter-anti-vince-protocol.sh
        else
            echo -e "${RED}âŒ Script walter-anti-vince-protocol.sh non trouvÃ© ou non exÃ©cutable${NC}"
            echo -e "${YELLOW}ğŸ’¡ VÃ©rifiez scripts/walter-anti-vince-protocol.sh${NC}"
        fi
        ;;
    "save")
        # Sauvegarde manuelle
        if [ -z "$2" ]; then
            echo -e "${RED}âŒ Nom de sauvegarde requis${NC}"
            echo -e "${YELLOW}Usage: ./hots save <nom_sauvegarde> [game_id] [player_id]${NC}"
            exit 1
        fi
        
        SAVE_NAME="$2"
        GAME_ID="${3:-1}"
        PLAYER_ID="${4:-player1}"
        
        echo -e "${BLUE}ğŸ’¾ Sauvegarde de la partie...${NC}"
        RESPONSE=$(curl -s -X POST "http://localhost:8080/api/persistence/games/$GAME_ID/save" \
            -H "Content-Type: application/json" \
            -d "{\"playerId\": \"$PLAYER_ID\", \"saveName\": \"$SAVE_NAME\", \"description\": \"Sauvegarde manuelle\"}")
        
        if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… Partie sauvegardÃ©e: $SAVE_NAME${NC}"
            echo "$RESPONSE" | jq -r '.message'
        else
            echo -e "${RED}âŒ Erreur sauvegarde${NC}"
            echo "$RESPONSE" | jq -r '.error // "Erreur inconnue"'
        fi
        ;;
    "load")
        # Charger une sauvegarde
        if [ -z "$2" ]; then
            echo -e "${RED}âŒ ID ou nom de sauvegarde requis${NC}"
            echo -e "${YELLOW}Usage: ./hots load <save_id_ou_nom> [player_id]${NC}"
            exit 1
        fi
        
        SAVE_ID="$2"
        PLAYER_ID="${3:-player1}"
        
        echo -e "${BLUE}ğŸ“‚ Chargement de la sauvegarde...${NC}"
        
        # Si c'est un nombre, charger par ID
        if [[ "$SAVE_ID" =~ ^[0-9]+$ ]]; then
            RESPONSE=$(curl -s -X POST "http://localhost:8080/api/persistence/saves/$SAVE_ID/load" \
                -H "Content-Type: application/json" \
                -d "{\"playerId\": \"$PLAYER_ID\"}")
        else
            # Sinon, chercher par nom (Ã  implÃ©menter cÃ´tÃ© backend si nÃ©cessaire)
            echo -e "${YELLOW}âš ï¸  Chargement par nom non encore implÃ©mentÃ©${NC}"
            echo -e "${YELLOW}ğŸ’¡ Utilisez './hots list-saves' pour voir les IDs${NC}"
            exit 1
        fi
        
        if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… Partie chargÃ©e avec succÃ¨s${NC}"
            echo "$RESPONSE" | jq -r '.message'
        else
            echo -e "${RED}âŒ Erreur chargement${NC}"
            echo "$RESPONSE" | jq -r '.error // "Erreur inconnue"'
        fi
        ;;
    "list-saves")
        # Lister les sauvegardes
        PLAYER_ID="${2:-player1}"
        
        echo -e "${BLUE}ğŸ“‹ Liste des sauvegardes pour $PLAYER_ID:${NC}"
        echo ""
        
        RESPONSE=$(curl -s "http://localhost:8080/api/persistence/saves?playerId=$PLAYER_ID")
        
        if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
            COUNT=$(echo "$RESPONSE" | jq -r '.count')
            echo -e "${GREEN}âœ… $COUNT sauvegarde(s) trouvÃ©e(s)${NC}"
            echo ""
            
            echo "$RESPONSE" | jq -r '.saves[] | 
                "ID: \(.id) | \(.saveName)" +
                "\n  Tour: \(.turnNumber) | " +
                (if .isAutoSave then "ğŸ”„ Auto-save" else "ğŸ’¾ Manuelle" end) +
                "\n  CrÃ©Ã©e: \(.createdAt) | DerniÃ¨re: \(.lastPlayedAt)" +
                "\n  " + (.description // "Pas de description") +
                "\n"'
        else
            echo -e "${RED}âŒ Erreur rÃ©cupÃ©ration sauvegardes${NC}"
            echo "$RESPONSE" | jq -r '.error // "Erreur inconnue"'
        fi
        ;;
    "help"|*)
        show_help
        ;;
esac 