import React, { useState, useEffect, useRef } from 'react';
import { GameScriptEngine, GameScript, ScriptAction, ExecutionResult } from '../services/gameScriptEngine';
import { useGameStore } from '../store/useGameStore';
import './GameScriptTester.css';

interface ScriptResult {
  timestamp: string;
  script: string;
  result: any;
  error?: string;
  logs: string[];
}

interface ScriptExample {
  name: string;
  description: string;
  script: string;
  category: string;
  icon: string;
}

interface QuickCommand {
  name: string;
  command: string;
  description: string;
  icon: string;
}

const GameScriptTester: React.FC = () => {
  const gameStore = useGameStore();
  const [scriptEngine, setScriptEngine] = useState<GameScriptEngine | null>(null);
  const [currentScript, setCurrentScript] = useState<string>('');
  const [scriptResults, setScriptResults] = useState<ScriptResult[]>([]);
  const [isExecuting, setIsExecuting] = useState(false);
  const [selectedExample, setSelectedExample] = useState<string>('');
  const [isMinimized, setIsMinimized] = useState(false);
  const [isMaximized, setIsMaximized] = useState(false);
  const [activeTab, setActiveTab] = useState<'script' | 'examples' | 'commands' | 'results'>('script');
  const [selectedCategory, setSelectedCategory] = useState<string>('basic');
  const logsRef = useRef<HTMLDivElement>(null);

  // Commandes rapides pour ins√©rer facilement
  const quickCommands: QuickCommand[] = [
    { name: 'Mouvement', command: 'MOVE hero1 TO (5, 7)', description: 'D√©placer un h√©ros', icon: 'üèÉ' },
    { name: 'Construction', command: 'BUILD barracks AT (10, 10)', description: 'Construire un b√¢timent', icon: 'üèóÔ∏è' },
    { name: 'Recrutement', command: 'RECRUIT 5 soldier FROM building1', description: 'Recruter des unit√©s', icon: 'üë•' },
    { name: 'S√©lection', command: 'SELECT_HERO hero1', description: 'S√©lectionner un h√©ros', icon: '‚öîÔ∏è' },
    { name: 'Magie', command: 'CAST fireball ON enemy', description: 'Lancer un sort', icon: 'üîÆ' },
    { name: 'Attente', command: 'WAIT 1000', description: 'Attendre (ms)', icon: '‚è±Ô∏è' },
    { name: 'Log', command: 'LOG "Message de test"', description: 'Afficher un message', icon: 'üìù' },
    { name: 'Fin tour', command: 'END_TURN', description: 'Terminer le tour', icon: 'üîÑ' },
    { name: 'Commerce', command: 'TRADE gold FOR wood WITH merchant', description: '√âchanger des ressources', icon: 'üí∞' },
    { name: 'Exploration', command: 'EXPLORE region_north', description: 'Explorer une r√©gion', icon: 'üó∫Ô∏è' },
    { name: 'Am√©lioration', command: 'UPGRADE building1 TO level2', description: 'Am√©liorer un b√¢timent', icon: '‚¨ÜÔ∏è' },
    { name: 'Bataille', command: 'ATTACK enemy_unit WITH army1', description: 'Attaquer un ennemi', icon: '‚öîÔ∏è' }
  ];

  // Exemples de scripts organis√©s par cat√©gorie
  const scriptExamples: ScriptExample[] = [
    {
      name: 'Mouvement Basique',
      category: 'basic',
      icon: 'üèÉ',
      description: 'D√©placer un h√©ros vers une position sp√©cifique',
      script: `// D√©placer le h√©ros vers la position (5, 7)
LOG "D√©but du mouvement h√©ros"
SELECT_HERO hero1
WAIT 500
MOVE hero1 TO (5, 7)
WAIT 1000
LOG "H√©ros d√©plac√© avec succ√®s vers (5, 7)"
LOG "Position mise √† jour"`
    },
    {
      name: 'Construction Rapide',
      category: 'basic',
      icon: 'üèóÔ∏è',
      description: 'Construire un b√¢timent dans le ch√¢teau',
      script: `// Construire une caserne
LOG "D√©but de la construction"
BUILD barracks AT (10, 10)
WAIT 2000
LOG "Caserne construite √† (10, 10)"
LOG "B√¢timent pr√™t pour le recrutement"`
    },
    {
      name: 'Recrutement d\'Arm√©e',
      category: 'basic',
      icon: 'üë•',
      description: 'Recruter des unit√©s militaires',
      script: `// Recruter diff√©rentes unit√©s
LOG "D√©but du recrutement"
RECRUIT 5 soldier FROM barracks
WAIT 1500
RECRUIT 3 archer FROM archery_range
WAIT 1500
RECRUIT 2 knight FROM castle
WAIT 1500
LOG "Arm√©e recrut√©e : 5 soldats, 3 archers, 2 chevaliers"`
    },
    {
      name: 'S√©quence Compl√®te',
      category: 'advanced',
      icon: 'üéØ',
      description: 'Exemple d\'une s√©quence compl√®te de jeu',
      script: `// S√©quence compl√®te d'un tour
LOG "=== D√âBUT DU TOUR ==="

// Phase 1: S√©lection et mouvement
LOG "Phase 1: Mouvement des h√©ros"
SELECT_HERO hero1
WAIT 500
MOVE hero1 TO (3, 4)
WAIT 1000

// Phase 2: Construction
LOG "Phase 2: D√©veloppement"
BUILD tower AT (5, 5)
WAIT 2000
BUILD farm AT (7, 7)
WAIT 2000

// Phase 3: Recrutement
LOG "Phase 3: Recrutement"
RECRUIT 3 archer FROM building2
WAIT 1500
RECRUIT 2 mage FROM magic_tower
WAIT 1500

// Phase 4: Fin du tour
LOG "Phase 4: Finalisation"
END_TURN
LOG "=== TOUR TERMIN√â AVEC SUCC√àS ==="
LOG "Pr√™t pour le prochain tour"`
    },
    {
      name: 'Magie Avanc√©e',
      category: 'advanced',
      icon: 'üîÆ',
      description: 'S√©rie de sorts magiques',
      script: `// S√©quence de sorts magiques
LOG "D√©but de la s√©quence magique"

// Sorts offensifs
LOG "Sorts d'attaque"
CAST spell_fireball ON target_enemy1
WAIT 1000
CAST spell_lightning ON target_enemy2
WAIT 1000
CAST spell_meteor ON area_target
WAIT 2000

// Sorts d√©fensifs
LOG "Sorts de protection"
CAST spell_shield ON hero1
WAIT 1000
CAST spell_heal ON hero1
WAIT 1000
CAST spell_blessing ON army1
WAIT 1000

LOG "S√©quence magique termin√©e"
LOG "Mana restant v√©rifi√©"`
    },
    {
      name: 'Strat√©gie √âconomique',
      category: 'strategy',
      icon: 'üí∞',
      description: 'Gestion des ressources et commerce',
      script: `// Strat√©gie √©conomique
LOG "=== STRAT√âGIE √âCONOMIQUE ==="

// D√©veloppement des ressources
LOG "D√©veloppement des ressources"
BUILD mine AT (1, 1)
WAIT 2000
BUILD farm AT (2, 2)
WAIT 2000
BUILD sawmill AT (3, 3)
WAIT 2000

// Commerce
LOG "Phase de commerce"
TRADE gold FOR wood WITH merchant1
WAIT 1000
TRADE wood FOR stone WITH merchant2
WAIT 1000
TRADE stone FOR mana WITH wizard
WAIT 1000

// Am√©lioration des b√¢timents
LOG "Am√©lioration des structures"
UPGRADE mine TO level2
WAIT 3000
UPGRADE farm TO level2
WAIT 3000

LOG "Strat√©gie √©conomique achev√©e"
LOG "Ressources optimis√©es"`
    },
    {
      name: 'Exploration Compl√®te',
      category: 'strategy',
      icon: 'üó∫Ô∏è',
      description: 'Explorer et conqu√©rir le territoire',
      script: `// Exploration et conqu√™te
LOG "=== EXPLORATION ET CONQU√äTE ==="

// Pr√©paration de l'exp√©dition
LOG "Pr√©paration de l'exp√©dition"
SELECT_HERO hero1
RECRUIT 10 soldier FROM barracks
WAIT 2000
RECRUIT 5 archer FROM archery_range
WAIT 2000

// Exploration par r√©gions
LOG "Exploration des r√©gions"
EXPLORE region_north
WAIT 3000
EXPLORE region_east
WAIT 3000
EXPLORE region_south
WAIT 3000
EXPLORE region_west
WAIT 3000

// Conqu√™te des positions strat√©giques
LOG "Conqu√™te des positions"
ATTACK enemy_outpost WITH army1
WAIT 4000
ATTACK enemy_tower WITH army1
WAIT 4000

LOG "Territoire explor√© et s√©curis√©"
LOG "Nouvelle zone sous contr√¥le"`
    },
    {
      name: 'Bataille √âpique',
      category: 'combat',
      icon: '‚öîÔ∏è',
      description: 'Combat strat√©gique avanc√©',
      script: `// Bataille √©pique
LOG "=== BATAILLE √âPIQUE ==="

// Pr√©paration au combat
LOG "Pr√©paration des forces"
SELECT_HERO hero1
CAST spell_blessing ON army1
WAIT 1000
CAST spell_shield ON hero1
WAIT 1000

// Formation de bataille
LOG "Formation de bataille"
MOVE army1 TO (10, 10)
WAIT 2000
MOVE archer_unit TO (12, 8)
WAIT 2000
MOVE cavalry TO (8, 12)
WAIT 2000

// Attaque coordonn√©e
LOG "Attaque coordonn√©e"
ATTACK enemy_army WITH cavalry
WAIT 3000
CAST spell_fireball ON enemy_mage
WAIT 1000
ATTACK enemy_archers WITH army1
WAIT 3000

// Finalisation
LOG "Finalisation du combat"
CAST spell_heal ON hero1
WAIT 1000
LOG "VICTOIRE! Bataille remport√©e"
LOG "Butin collect√© et territoire conquis"`
    },
    {
      name: 'Test Complet',
      category: 'debug',
      icon: 'üß™',
      description: 'Test de toutes les fonctionnalit√©s',
      script: `// Test complet du syst√®me
LOG "=== TEST COMPLET DU SYST√àME ==="

// Test des commandes de base
LOG "Test des commandes de base"
SELECT_HERO hero1
LOG "S√©lection h√©ros: OK"
MOVE hero1 TO (5, 5)
LOG "Mouvement: OK"
WAIT 1000

// Test de construction
LOG "Test de construction"
BUILD barracks AT (10, 10)
LOG "Construction: OK"
WAIT 2000

// Test de recrutement
LOG "Test de recrutement"
RECRUIT 3 soldier FROM barracks
LOG "Recrutement: OK"
WAIT 1500

// Test de magie
LOG "Test de magie"
CAST spell_heal ON hero1
LOG "Magie: OK"
WAIT 1000

// Test de commerce
LOG "Test de commerce"
TRADE gold FOR wood WITH merchant
LOG "Commerce: OK"
WAIT 1000

// Test final
LOG "Test de fin de tour"
END_TURN
LOG "=== TOUS LES TESTS R√âUSSIS ==="
LOG "Syst√®me op√©rationnel √† 100%"`
    }
  ];

  // Initialiser le script engine
  useEffect(() => {
    if (gameStore.currentGame?.id) {
      const engine = new GameScriptEngine();
      setScriptEngine(engine);
    }
  }, [gameStore.currentGame?.id, gameStore.currentPlayer?.id]);

  // Ins√©rer une commande rapide
  const insertQuickCommand = (command: string) => {
    const textarea = document.getElementById('script-textarea') as HTMLTextAreaElement;
    if (textarea) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const newText = text.substring(0, start) + command + '\n' + text.substring(end);
      setCurrentScript(newText);
      
      // Repositionner le curseur
      setTimeout(() => {
        textarea.focus();
        textarea.setSelectionRange(start + command.length + 1, start + command.length + 1);
      }, 0);
    }
  };

  // Charger un exemple de script
  const loadExample = (example: ScriptExample) => {
    setCurrentScript(example.script);
    setSelectedExample(example.name);
    setActiveTab('script');
  };

  // Ex√©cuter un script
  const executeScript = async () => {
    if (!scriptEngine || !currentScript.trim()) return;

    setIsExecuting(true);
    const timestamp = new Date().toLocaleTimeString();
    const logs: string[] = [];

    try {
      // Capturer les logs du script engine
      const originalLog = console.log;
      // eslint-disable-next-line no-self-assign
      console.log = console.log;

      // Ex√©cuter le script ligne par ligne
      const lines = currentScript.split('\n').filter(line => line.trim() && !line.trim().startsWith('//'));
      const results: ExecutionResult[] = [];
      
      for (const line of lines) {
        const trimmedLine = line.trim();
        if (trimmedLine.startsWith('WAIT')) {
          const waitTime = parseInt(trimmedLine.split(' ')[1]) || 1000;
          await new Promise(resolve => setTimeout(resolve, waitTime));
          continue;
        }
        
        if (trimmedLine.startsWith('LOG')) {
          const message = trimmedLine.substring(4).trim().replace(/^"|"$/g, '');
          logs.push(`üìù ${message}`);
          continue;
        }
        
        // Cr√©er un script complet
        const script: GameScript = {
          name: 'Generated Script',
          description: 'Script g√©n√©r√© automatiquement',
          actions: []
        };

        // Traiter chaque ligne
        lines.forEach((line, index) => {
          const trimmedLine = line.trim();
          if (!trimmedLine || trimmedLine.startsWith('//')) return;

          const words = trimmedLine.split(/\s+/);
          const command = words[0];
          
          let action: ScriptAction | null = null;

          if (command === 'move') {
            const heroId = words[1];
            const coordsMatch = trimmedLine.match(/\((\d+),\s*(\d+)\)/);
            const x = coordsMatch ? parseInt(coordsMatch[1], 10) : 0;
            const y = coordsMatch ? parseInt(coordsMatch[2], 10) : 0;
            action = { type: 'move', params: { heroId, x, y } };
          } else if (command === 'build') {
            const building = words[1];
            const coordsMatch = trimmedLine.match(/\((\d+),\s*(\d+)\)/);
            const x = coordsMatch ? parseInt(coordsMatch[1], 10) : 0;
            const y = coordsMatch ? parseInt(coordsMatch[2], 10) : 0;
            action = { type: 'build', params: { building, position: { x, y } } };
          } else if (command === 'recruit') {
            const unitType = words[1];
            const count = parseInt(words[2], 10) || 1;
            const building = words[3];
            action = { type: 'recruit', params: { unitType, count, building } };
          } else if (command === 'cast') {
            const spell = words[1];
            const target = words[2];
            action = { type: 'cast_spell', params: { spell, target } };
          } else if (command === 'hero') {
            const heroId = words[1];
            action = { type: 'move', params: { heroId } };
          } else if (command === 'end_turn') {
            action = { type: 'end_turn', params: {} };
          }

          if (action) {
            script.actions.push(action);
          }
        });

        return script;
      }
      
      // Restaurer console.log
      console.log = originalLog;
      
      // Ajouter le r√©sultat
      const scriptResult: ScriptResult = {
        timestamp,
        script: currentScript,
        result: { success: true, results },
        logs
      };
      
      setScriptResults(prev => [scriptResult, ...prev]);
      
    } catch (error) {
      const scriptResult: ScriptResult = {
        timestamp,
        script: currentScript,
        result: null,
        error: error instanceof Error ? error.message : 'Erreur inconnue',
        logs
      };
      
      setScriptResults(prev => [scriptResult, ...prev]);
    } finally {
      setIsExecuting(false);
    }
  };

  // Vider les r√©sultats
  const clearResults = () => {
    setScriptResults([]);
  };

  // Obtenir les exemples filtr√©s par cat√©gorie
  const getExamplesByCategory = (category: string) => {
    return scriptExamples.filter(example => example.category === category);
  };

  // Rendu des onglets
  const renderTabs = () => (
    <div className="script-tabs">
      <button 
        className={`tab-button ${activeTab === 'script' ? 'active' : ''}`}
        onClick={() => setActiveTab('script')}
      >
        <span className="tab-icon">üìù</span>
        Script
      </button>
      <button 
        className={`tab-button ${activeTab === 'commands' ? 'active' : ''}`}
        onClick={() => setActiveTab('commands')}
      >
        <span className="tab-icon">‚ö°</span>
        Commandes
      </button>
      <button 
        className={`tab-button ${activeTab === 'examples' ? 'active' : ''}`}
        onClick={() => setActiveTab('examples')}
      >
        <span className="tab-icon">üìö</span>
        Exemples
      </button>
      <button 
        className={`tab-button ${activeTab === 'results' ? 'active' : ''}`}
        onClick={() => setActiveTab('results')}
      >
        <span className="tab-icon">üìä</span>
        R√©sultats ({scriptResults.length})
      </button>
    </div>
  );

  // Contenu principal selon l'onglet actif
  const renderMainContent = () => {
    switch (activeTab) {
      case 'script':
        return (
          <div className="script-editor">
            <div className="editor-header">
              <h3>‚úçÔ∏è √âditeur de Script</h3>
              <div className="editor-actions">
                <button 
                  className="action-button clear-button"
                  onClick={() => setCurrentScript('')}
                >
                  üóëÔ∏è Vider
                </button>
                <button 
                  className="action-button execute-button"
                  onClick={executeScript}
                  disabled={isExecuting || !currentScript.trim()}
                >
                  {isExecuting ? '‚è≥ Ex√©cution...' : '‚ñ∂Ô∏è Ex√©cuter'}
                </button>
              </div>
            </div>
            <textarea
              id="script-textarea"
              className="script-textarea"
              value={currentScript}
              onChange={(e) => setCurrentScript(e.target.value)}
              placeholder={`Entrez votre script ici...

Exemples de commandes :
‚Ä¢ MOVE hero1 TO (5, 7)
‚Ä¢ BUILD barracks AT (10, 10)
‚Ä¢ RECRUIT 5 soldier FROM building1
‚Ä¢ CAST fireball ON enemy
‚Ä¢ LOG "Message"
‚Ä¢ WAIT 1000
‚Ä¢ END_TURN`}
              rows={20}
            />
          </div>
        );

      case 'commands':
        return (
          <div className="commands-panel">
            <h3>‚ö° Commandes Rapides</h3>
            <div className="commands-grid">
              {quickCommands.map((command, index) => (
                <div key={index} className="command-card">
                  <button
                    className="command-button"
                    onClick={() => insertQuickCommand(command.command)}
                  >
                    <span className="command-icon">{command.icon}</span>
                    <span className="command-name">{command.name}</span>
                  </button>
                  <p className="command-description">{command.description}</p>
                  <code className="command-code">{command.command}</code>
                </div>
              ))}
            </div>
          </div>
        );

      case 'examples':
        return (
          <div className="examples-panel">
            <h3>üìö Exemples de Scripts</h3>
            <div className="category-tabs">
              {['basic', 'advanced', 'strategy', 'combat', 'debug'].map(category => (
                <button
                  key={category}
                  className={`category-button ${selectedCategory === category ? 'active' : ''}`}
                  onClick={() => setSelectedCategory(category)}
                >
                  {category === 'basic' && 'üöÄ Basique'}
                  {category === 'advanced' && 'üéØ Avanc√©'}
                  {category === 'strategy' && 'üß† Strat√©gie'}
                  {category === 'combat' && '‚öîÔ∏è Combat'}
                  {category === 'debug' && 'üß™ Debug'}
                </button>
              ))}
            </div>
            <div className="examples-grid">
              {getExamplesByCategory(selectedCategory).map((example, index) => (
                <div key={index} className="example-card">
                  <div className="example-header">
                    <span className="example-icon">{example.icon}</span>
                    <h4>{example.name}</h4>
                  </div>
                  <p className="example-description">{example.description}</p>
                  <button
                    className="load-example-button"
                    onClick={() => loadExample(example)}
                  >
                    üìù Charger ce script
                  </button>
                </div>
              ))}
            </div>
          </div>
        );

      case 'results':
        return (
          <div className="results-panel">
            <div className="results-header">
              <h3>üìä R√©sultats d'Ex√©cution</h3>
              <button className="clear-results-button" onClick={clearResults}>
                üóëÔ∏è Vider les r√©sultats
              </button>
            </div>
            <div className="results-list">
              {scriptResults.length === 0 ? (
                <div className="no-results">
                  <p>Aucun r√©sultat pour le moment.</p>
                  <p>Ex√©cutez un script pour voir les r√©sultats ici.</p>
                </div>
              ) : (
                scriptResults.map((result, index) => (
                  <div key={index} className="result-item">
                    <div className="result-header">
                      <span className="result-timestamp">{result.timestamp}</span>
                      <span className={`result-status ${result.error ? 'error' : 'success'}`}>
                        {result.error ? '‚ùå Erreur' : '‚úÖ Succ√®s'}
                      </span>
                    </div>
                    {result.error && (
                      <div className="result-error">
                        <strong>Erreur:</strong> {result.error}
                      </div>
                    )}
                    {result.result && (
                      <div className="result-data">
                        <strong>R√©sultat:</strong>
                        <pre>{JSON.stringify(result.result, null, 2)}</pre>
                      </div>
                    )}
                    {result.logs.length > 0 && (
                      <div className="result-logs">
                        <strong>Logs:</strong>
                        {result.logs.map((log, logIndex) => (
                          <div key={logIndex} className="log-line">{log}</div>
                        ))}
                      </div>
                    )}
                  </div>
                ))
              )}
            </div>
          </div>
        );

      default:
        return null;
    }
  };

  if (isMinimized) {
    return (
      <div className="script-tester-minimized">
        <button
          className="restore-button"
          onClick={() => setIsMinimized(false)}
        >
          üß™ GameScript Tester
        </button>
      </div>
    );
  }

  return (
    <div className={`game-script-tester ${isMaximized ? 'maximized' : ''}`}>
      <div className="tester-header">
        <div className="header-left">
          <h2>üß™ GameScript Tester</h2>
          <span className="version-info">v2.0 - Interface Am√©lior√©e</span>
        </div>
        <div className="header-controls">
          <button
            className="control-button"
            onClick={() => setIsMinimized(true)}
          >
            ‚ûñ
          </button>
          <button
            className="control-button"
            onClick={() => setIsMaximized(!isMaximized)}
          >
            {isMaximized ? 'üóó' : 'üóñ'}
          </button>
        </div>
      </div>

      {renderTabs()}

      <div className="tester-content">
        {renderMainContent()}
      </div>

      <div className="tester-footer">
        <div className="footer-info">
          <span>üéÆ Jeu: {gameStore.currentGame?.id || 'Aucun'}</span>
          <span>üë§ Joueur: {gameStore.currentPlayer?.id || 'Aucun'}</span>
          <span>‚öîÔ∏è H√©ros: {gameStore.selectedHero?.id || 'Aucun'}</span>
          <span>üìä Scripts: {scriptResults.length}</span>
        </div>
      </div>
    </div>
  );
};

export default GameScriptTester; 