<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heroes of Time - Temporal Engine</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="temporal-styles.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="title">üï∞Ô∏è Heroes of Time - Temporal Engine</div>
            <div class="controls">
                <button id="new-game-btn" class="btn-primary">üéÆ New Game</button>
                <button id="add-ragnar-btn" class="btn-secondary">üõ°Ô∏è Add Ragnar</button>
                <button id="test-decay-btn" class="btn-warning">‚è∞ Test Decay</button>
                <button id="settings-btn" class="btn-icon">‚öôÔ∏è</button>
            </div>
        </header>
        
        <div class="game-area">
            <div class="game-board">
                <canvas id="game-canvas"></canvas>
                <div class="game-overlay">
                    <div class="temporal-info" id="temporal-info">
                        <div class="info-card">
                            <h3>‚è∞ Temporal Status</h3>
                            <div id="current-timeline">Timeline: ‚Ñ¨1</div>
                            <div id="current-turn">Turn: 0</div>
                            <div id="decay-status">Decay: None</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="side-panel">
                <div class="script-console" id="script-console">
                    <!-- Console will be populated by JavaScript -->
                </div>
                
                <div class="hero-panel" id="hero-panel">
                    <h3>ü¶∏ Heroes</h3>
                    <div id="heroes-list"></div>
                </div>
                
                <div class="decay-panel" id="decay-panel">
                    <h3>üé≠ Anna's Decay System</h3>
                    <div class="decay-controls">
                        <button id="apply-decay-btn" class="btn-warning">Apply Decay</button>
                        <button id="repair-buildings-btn" class="btn-success">Repair Buildings</button>
                    </div>
                    <div id="decay-stats"></div>
                </div>
            </div>
        </div>
        
        <div class="status-bar" id="status-bar">
            Ready to start... Anna the Martopicker watches from the shadows ‚è∞
        </div>
    </div>
    
    <script src="api.js"></script>
    <script src="script-console.js"></script>
    <script src="game.js"></script>
    <script src="runic-forge.js"></script>
    <script src="temporal-integration.js"></script>
    <script src="hero-avatars.js"></script>
    <script src="gameplay-enhancement.js"></script>
    <script src="missing-assets-loader.js"></script>
    <script>
        // Initialisation de l'application
        window.gameAPI = new GameAPI();
        window.gameRenderer = new GameRenderer('game-canvas');
        window.scriptConsole = new ScriptConsole('script-console');
        window.temporalIntegration = new TemporalIntegration();
        window.gameplayEnhancement = new GameplayEnhancement();
        window.missingAssetsLoader = new MissingAssetsLoader();
        
        // Fonction pour mettre √† jour la barre de statut
        window.updateStatusBar = function(message) {
            const statusBar = document.getElementById('status-bar');
            if (statusBar) {
                statusBar.textContent = message;
            }
        };
        
        // Fonction pour cr√©er des h√©ros de d√©monstration
        window.createMockHeroes = function() {
            const mockGameState = {
                gameId: 1,
                currentTurn: 0,
                status: 'ACTIVE',
                heroes: [
                    {
                        name: 'Ragnar',
                        position: { x: 5, y: 5 },
                        health: 100,
                        maxHealth: 100,
                        timeline: '‚Ñ¨1',
                        status: 'ACTIVE',
                        temporalEnergy: 100,
                        movementPoints: 3,
                        inventory: ['Shield', 'Sword'],
                        playerId: 'player1'
                    },
                    {
                        name: 'Arthur',
                        position: { x: 8, y: 3 },
                        health: 90,
                        maxHealth: 100,
                        timeline: '‚Ñ¨1',
                        status: 'ACTIVE',
                        temporalEnergy: 85,
                        movementPoints: 2,
                        inventory: ['Excalibur'],
                        playerId: 'player1'
                    },
                    {
                        name: 'Jean-Grofignon',
                        position: { x: 3, y: 8 },
                        health: 120,
                        maxHealth: 120,
                        timeline: '‚Ñ¨1',
                        status: 'ACTIVE',
                        temporalEnergy: 150,
                        movementPoints: 4,
                        inventory: ['GROFI_Omega', 'Temporal_Compass'],
                        playerId: 'player1'
                    }
                ],
                psiStates: [
                    {
                        id: 'œà001',
                        status: 'ACTIVE',
                        targetX: 10,
                        targetY: 10,
                        probability: 0.8,
                        expression: '‚äô(Œît+2 @10,10 ‚ü∂ MOV(Ragnar, @10,10))'
                    }
                ],
                tiles: []
            };
            
            window.gameRenderer.updateState(mockGameState);
            window.updateHeroesList(mockGameState.heroes);
            window.updateStatusBar('Demo Heroes: Ragnar üõ°Ô∏è, Arthur ‚öîÔ∏è, and Jean-Grofignon üß† ready!');
        };
        
        // Fonction pour mettre √† jour la liste des h√©ros
        window.updateHeroesList = function(heroes) {
            const heroesList = document.getElementById('heroes-list');
            if (!heroesList) return;
            
            heroesList.innerHTML = '';
            heroes.forEach(hero => {
                const heroElement = document.createElement('div');
                heroElement.className = 'hero-item';
                heroElement.innerHTML = `
                    <div class="hero-name">${hero.name}</div>
                    <div class="hero-stats">
                        <span class="health">‚ù§Ô∏è ${hero.health}/${hero.maxHealth}</span>
                        <span class="energy">‚ö° ${hero.temporalEnergy}</span>
                        <span class="movement">üëü ${hero.movementPoints}</span>
                    </div>
                    <div class="hero-timeline">‚è∞ ${hero.timeline}</div>
                `;
                heroesList.appendChild(heroElement);
            });
        };
        
        // Fonction pour tester le syst√®me de d√©croissance
        window.testTemporalDecay = async function() {
            if (!window.gameAPI.gameId) {
                window.scriptConsole.addToOutput('‚ùå No game active. Create a game first.', 'error');
                return;
            }
            
            try {
                window.scriptConsole.addToOutput('üé≠ Anna the Martopicker applies temporal decay...', 'warning');
                
                const response = await fetch(`http://localhost:8080/api/temporal/games/${window.gameAPI.gameId}/decay/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.scriptConsole.addToOutput(`‚è∞ Decay applied! ${result.message}`, 'success');
                    window.scriptConsole.addToOutput(`üèóÔ∏è Affected buildings: ${result.affectedBuildings}`, 'info');
                    window.scriptConsole.addToOutput(`üí• Destroyed buildings: ${result.destroyedBuildings}`, 'warning');
                    
                    // Mettre √† jour les stats de d√©croissance
                    window.updateDecayStats(result);
                } else {
                    const error = await response.text();
                    window.scriptConsole.addToOutput(`‚ùå Decay failed: ${error}`, 'error');
                }
            } catch (error) {
                window.scriptConsole.addToOutput(`‚ùå Decay test failed: ${error.message}`, 'error');
            }
        };
        
        // Fonction pour mettre √† jour les stats de d√©croissance
        window.updateDecayStats = function(decayResult) {
            const decayStats = document.getElementById('decay-stats');
            if (!decayStats) return;
            
            decayStats.innerHTML = `
                <div class="decay-stat">
                    <span class="label">Affected:</span>
                    <span class="value">${decayResult.affectedBuildings}</span>
                </div>
                <div class="decay-stat">
                    <span class="label">Destroyed:</span>
                    <span class="value">${decayResult.destroyedBuildings}</span>
                </div>
                <div class="decay-stat">
                    <span class="label">Quote:</span>
                    <span class="value">"${decayResult.quote}"</span>
                </div>
            `;
        };
        
        // √âv√©nements
        document.getElementById('new-game-btn').addEventListener('click', async () => {
            try {
                const game = await window.gameAPI.createGame('Frontend Game');
                window.scriptConsole.addToOutput('üéÆ New game created! ID: ' + game.gameId, 'success');
                window.updateStatusBar('Game created - Ready for commands');
                
                // Cr√©er automatiquement Ragnar
                setTimeout(async () => {
                    try {
                        const result = await window.gameAPI.executeScript('HERO(Ragnar)');
                        window.scriptConsole.addToOutput('üõ°Ô∏è Hero Ragnar created via temporal script!', 'success');
                        window.gameRenderer.refresh();
                    } catch (error) {
                        window.scriptConsole.addToOutput(`‚ùå Backend error: ${error.message}`, 'error');
                        window.scriptConsole.addToOutput('üé≠ Loading demo heroes instead...', 'info');
                        window.createMockHeroes();
                    }
                }, 1000);
                
                window.gameRenderer.refresh();
            } catch (error) {
                window.scriptConsole.addToOutput(`‚ùå Failed to create game: ${error.message}`, 'error');
                window.scriptConsole.addToOutput('üé≠ Loading demo heroes for testing...', 'info');
                window.createMockHeroes();
            }
        });
        
        // Bouton pour ajouter Ragnar directement
        document.getElementById('add-ragnar-btn').addEventListener('click', () => {
            window.scriptConsole.addToOutput('üõ°Ô∏è Adding Ragnar directly...', 'info');
            window.createMockHeroes();
        });
        
        // Bouton pour tester la d√©croissance temporelle
        document.getElementById('test-decay-btn').addEventListener('click', () => {
            window.testTemporalDecay();
        });
        
        // Bouton pour appliquer la d√©croissance
        document.getElementById('apply-decay-btn').addEventListener('click', () => {
            window.testTemporalDecay();
        });
        
        // Bouton pour r√©parer les b√¢timents
        document.getElementById('repair-buildings-btn').addEventListener('click', async () => {
            if (!window.gameAPI.gameId) {
                window.scriptConsole.addToOutput('‚ùå No game active.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:8080/api/temporal/games/${window.gameAPI.gameId}/decay/repair`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ buildingType: 'castle', x: 5, y: 5, repairAmount: 50 })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.scriptConsole.addToOutput(`üîß Building repaired! ${result.message}`, 'success');
                } else {
                    const error = await response.text();
                    window.scriptConsole.addToOutput(`‚ùå Repair failed: ${error}`, 'error');
                }
            } catch (error) {
                window.scriptConsole.addToOutput(`‚ùå Repair failed: ${error.message}`, 'error');
            }
        });
        
        // Auto-refresh toutes les 3 secondes
        setInterval(() => {
            if (window.gameAPI.gameId) {
                window.gameRenderer.refresh();
            }
        }, 3000);
        
        // Message de bienvenue
        window.scriptConsole.addToOutput('üï∞Ô∏è Heroes of Time - Temporal Engine', 'success');
        window.scriptConsole.addToOutput('üé≠ Anna the Martopicker watches from the shadows...', 'warning');
        window.scriptConsole.addToOutput('üéÆ Click "New Game" or "Add Ragnar" to start!', 'normal');
        window.scriptConsole.addToOutput('üìú Temporal Grammar Examples:', 'normal');
        window.scriptConsole.addToOutput('  ‚Ä¢ HERO(Ragnar) - Create hero', 'normal');
        window.scriptConsole.addToOutput('  ‚Ä¢ MOV(Ragnar, @5,3) - Move hero', 'normal');
        window.scriptConsole.addToOutput('  ‚Ä¢ œà001: ‚äô(Œît+2 @10,10 ‚ü∂ MOV(Ragnar, @10,10)) - Temporal script', 'normal');
        window.scriptConsole.addToOutput('  ‚Ä¢ ‚Ä†œà001 - Collapse quantum state', 'normal');
        window.scriptConsole.addToOutput('  ‚Ä¢ ‚è∞ Test Decay - Anna punishes time travelers', 'warning');
        
        // Initialiser la barre de statut
        window.updateStatusBar('Ready to start... Anna the Martopicker watches from the shadows ‚è∞');
        
        // Charger Ragnar automatiquement pour d√©monstration
        setTimeout(() => {
            window.scriptConsole.addToOutput('üé≠ Loading heroes for immediate testing...', 'info');
            window.createMockHeroes();
        }, 2000);
    </script>
</body>
</html>