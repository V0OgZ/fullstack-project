<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Vince Vega Backend Demo - Jean Style</title>
    <style>
        body { 
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            color: #fff; font-family: 'Courier New', monospace; 
            margin: 0; padding: 20px; min-height: 100vh;
        }
        
        .demo-container { max-width: 1400px; margin: 0 auto; }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        .map-container {
            display: grid;
            grid-template-columns: repeat(10, 60px);
            grid-template-rows: repeat(8, 60px);
            gap: 2px;
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 10px;
            justify-content: center;
        }
        
        .map-cell {
            width: 60px;
            height: 60px;
            background: rgba(0,100,0,0.3);
            border: 1px solid #444;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .map-cell:hover {
            background: rgba(100,100,100,0.3);
            transform: scale(1.1);
        }
        
        .hero-arthur { background: rgba(255,215,0,0.5); }
        .hero-vince { background: rgba(255,68,68,0.5); }
        .hero-grut { background: rgba(116,75,162,0.5); }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none; color: white; padding: 10px 15px;
            border-radius: 20px; cursor: pointer; font-size: 12px;
            transition: all 0.3s;
        }
        
        .btn:hover { transform: scale(1.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .status-panel {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }
        
        .backend-panel {
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
        }
        
        .formula-log {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
            margin: 10px 0;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid;
            padding-left: 10px;
        }
        
        .log-success { border-color: #4CAF50; color: #90EE90; }
        .log-error { border-color: #f44336; color: #FFB6C1; }
        .log-info { border-color: #2196F3; color: #87CEEB; }
        
        .formula-selector {
            margin: 10px 0;
        }
        
        .formula-selector select {
            background: rgba(0,0,0,0.8);
            color: white;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 5px;
            width: 100%;
        }
        
        .wormhole {
            background: radial-gradient(circle, #ff00ff, #8000ff);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .explosion {
            background: radial-gradient(circle, #ff4444, #ffaa00);
            animation: explode 0.5s ease-out;
        }
        
        @keyframes explode {
            0% { transform: scale(1); }
            50% { transform: scale(2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .formula-effect {
            position: absolute;
            top: -10px;
            right: -10px;
            background: rgba(255,255,0,0.8);
            color: black;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            animation: fadeOut 2s forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        /* üåÄ ANIMATIONS WORMHOLES AVANC√âES V9 INT√âGR√âES */
        @keyframes wormhole-activate {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.3) rotate(180deg); filter: brightness(2); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        @keyframes quantum-spin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); filter: hue-rotate(90deg); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        @keyframes cycle-rotate {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1.2); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes origin-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; filter: brightness(1.5); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes quantum-tunnel {
            0% { transform: scale(1); }
            50% { transform: scale(0.8) rotate(5deg); }
            100% { transform: scale(1); }
        }
        
        .wormhole-active {
            animation: wormhole-activate 1s ease-in-out;
        }
        
        .easter-egg-gold {
            background: radial-gradient(circle, #FFD700, #FFA500, #FF8C00) !important;
            animation: origin-pulse 1s infinite !important;
            box-shadow: 0 0 20px gold !important;
        }

        /* üßô‚Äç‚ôÇÔ∏è WALTER INTELLIGENT ANALYSIS ANIMATIONS */
        @keyframes gentlePulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.02); }
        }

        .hero-aura {
            transition: all 0.3s ease;
        }

        .hero-cell:hover .hero-aura {
            opacity: 0.8 !important;
            transform: scale(1.05) !important;
        }

        .runic-symbol {
            transition: all 0.2s ease;
        }

        .hero-cell:hover .runic-symbol {
            opacity: 1 !important;
            transform: scale(1.2) !important;
        }

        .formula-indicator {
            transition: all 0.2s ease;
            cursor: help;
        }

        .hero-cell:hover .formula-indicator {
            transform: scale(1.5) !important;
            opacity: 1 !important;
        }

        /* üß™ QUANTUM LAB ANIMATIONS */
        @keyframes quantumCollapse {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.3) rotate(180deg); opacity: 0.7; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }

        .quantum-artifact {
            transition: all 0.3s ease;
        }

        .quantum-artifact:hover {
            transform: scale(1.3) !important;
            opacity: 1 !important;
            text-shadow: 0 0 8px #00ff88 !important;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1 style="text-align: center;">üó∫Ô∏è VINCE VEGA BACKEND DEMO</h1>
        
        <div class="status-panel">
            <div id="status">üõãÔ∏è Jean: "Backend connect√© ! Pr√™t pour les formules !"</div>
        </div>
        
        <div class="main-layout">
            <div class="map-section">
                <div class="map-container" id="gameMap">
                    <!-- Map g√©n√©r√© en JS -->
                </div>
                
                <!-- Panneau Controls -->
                <div class="controls">
                    <button class="btn" onclick="moveArthur()">‚öîÔ∏è Arthur Move</button>
                    <button class="btn" onclick="selectHero('vince')">üî´ Select Vince</button>
                    <button class="btn" onclick="vinceFire()">üî• Vince Fire</button>
                    <button class="btn" onclick="epicBattle()">‚ö° Epic Battle</button>
                    <button class="btn" onclick="grutVision()">üèõÔ∏è GRUT Vision</button>
                    <button class="btn" onclick="vinceWormhole()">üåÄ Vince Wormhole</button>
                    <button class="btn" onclick="autoDemo()">üé¨ AUTO DEMO</button>
                    <button class="btn" onclick="intelligentMapAnalysis()" style="background: linear-gradient(45deg, #4A90E2, #7B68EE);">üßô‚Äç‚ôÇÔ∏è Walter Analysis</button>
                </div>
                
                <div class="power-controls" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                    <label style="color: #ffd700; font-weight: bold;">üî´ Vince Powers:</label>
                    <select id="vincePowerSelect" style="width: 100%; padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.8); color: white; border: 1px solid #555; border-radius: 8px;">
                        <option value="REALITY_SHOT">üî´ Reality Shot</option>
                        <option value="WORMHOLE_BLAST">üåÄ Wormhole Blast</option>
                        <option value="FOURTH_WALL_BREAK">üí• Fourth Wall Break</option>
                        <option value="DIMENSIONAL_SHOT">üåå Dimensional Shot</option>
                        <option value="CAUSALITY_BULLET">‚öõÔ∏è Causality Bullet</option>
                        <option value="QUANTUM_RELOAD">üîÑ Quantum Reload</option>
                        <option value="EVERYTHING_BAGEL">ü•Ø Everything Bagel (TIER 9!)</option>
                        <option value="ECHO_PRIMORDIAL_SHOT">üåÄ Echo Primordial Shot (BOOTSTRAP!)</option>
                    </select>
                    <button class="btn" onclick="castVincePower()" style="width: 100%; margin: 5px 0;">
                        ‚ú® Cast Vince Power
                    </button>
                    
                    <div class="hero-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <div style="background: rgba(255,215,0,0.2); padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #ffd700;">
                            <strong>‚öîÔ∏è Arthur</strong><br>
                            HP: <span id="arthurHp">100</span><br>
                            MP: <span id="arthurMp">50</span>
                        </div>
                        <div style="background: rgba(255,68,68,0.2); padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #ff4444;">
                            <strong>üî´ Vince</strong><br>
                            HP: <span id="vinceHp">100</span><br>
                            MP: <span id="vinceMp">30</span>
                        </div>
                        <div style="background: rgba(116,75,162,0.2); padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #744ba2;">
                            <strong>üèõÔ∏è GRUT</strong><br>
                            HP: <span id="grutHp">150</span><br>
                            MP: <span id="grutMp">100</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Backend Connection Panel -->
            <div class="backend-panel">
                <h3>üîå Backend Status</h3>
                <div>Status: <span id="backendStatus">‚ùå Checking...</span></div>
                <div>API: <span id="apiEndpoint">http://localhost:8080</span></div>
            </div>
            
            <!-- üåê MULTIPLAYER INT√âGR√â - GRUT MODE -->
            <div class="multiplayer-panel" style="background: rgba(116,75,162,0.1); border: 2px solid #744ba2; padding: 15px; margin-top: 10px; border-radius: 8px;">
                <h3 style="color: #744ba2;">üåê MULTIPLAYER GRUT</h3>
                <div id="multiplayerStatus" style="color: #888; margin-bottom: 10px;">
                    Mode: Solo | Joueurs: 1/4
                </div>
                
                <div class="multiplayer-controls" style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn" onclick="createMultiSession()" style="background: #744ba2;">üéÆ Cr√©er Session</button>
                    <button class="btn" onclick="joinMultiSession()" style="background: #4a90e2;">üîó Rejoindre</button>
                    <button class="btn" onclick="leaveMultiSession()" style="background: #e74c3c;">üö™ Quitter</button>
                    <button class="btn" onclick="toggleMultiplayerChat()" style="background: #27ae60;">üí¨ Chat</button>
                </div>
                
                <div id="sessionInfo" style="display: none; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                    <div>Session ID: <span id="sessionId">-</span></div>
                    <div>Monde Actuel: <span id="currentWorldMulti">A</span></div>
                    <div>Joueurs Connect√©s: <span id="connectedPlayers">1</span></div>
                </div>
                
                <div id="multiplayerChat" style="display: none; margin-top: 10px; max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 4px;">
                    <div id="chatMessages" style="font-size: 12px; color: #ccc;"></div>
                    <input type="text" id="chatInput" placeholder="Message..." style="width: 100%; margin-top: 5px; padding: 4px; background: #333; color: #fff; border: 1px solid #666; border-radius: 3px;">
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            arthur: { x: 2, y: 3, energy: 100, hp: 100, mp: 50 },
            vince: { x: 7, y: 4, energy: 100, hp: 100, mp: 30 },
            grut: { x: 5, y: 1, energy: 100, hp: 150, mp: 100 },
            wormholes: [],
            selectedHero: 'vince'
        };
        
        const API_BASE = 'http://localhost:8080/api';
        let backendConnected = false;
        
        function createMap() {
            const map = document.getElementById('gameMap');
            map.innerHTML = '';
            
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 10; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.id = `cell-${x}-${y}`;
                    cell.onclick = () => cellClick(x, y);
                    map.appendChild(cell);
                }
            }
        }
        
        function updateMap() {
            // Clear all
            document.querySelectorAll('.map-cell').forEach(cell => {
                cell.innerHTML = '';
                cell.className = 'map-cell';
            });
            
            // Place heroes with data attributes for intelligent analysis
            const arthurCell = document.getElementById(`cell-${gameState.arthur.x}-${gameState.arthur.y}`);
            arthurCell.innerHTML = '‚öîÔ∏è';
            arthurCell.classList.add('hero-arthur', 'hero-cell');
            arthurCell.setAttribute('data-hero', 'arthur');
            
            const vinceCell = document.getElementById(`cell-${gameState.vince.x}-${gameState.vince.y}`);
            vinceCell.innerHTML = 'üî´';
            vinceCell.classList.add('hero-vince', 'hero-cell');
            vinceCell.setAttribute('data-hero', 'vince');
            
            const grutCell = document.getElementById(`cell-${gameState.grut.x}-${gameState.grut.y}`);
            grutCell.innerHTML = 'üèõÔ∏è';
            grutCell.classList.add('hero-grut', 'hero-cell');
            grutCell.setAttribute('data-hero', 'grut');
            
            // üåê Place other players (MULTIPLAYER)
            if (multiplayerActive) {
                Object.keys(otherPlayers).forEach(playerId => {
                    const player = otherPlayers[playerId];
                    const playerCell = document.getElementById(`cell-${player.x}-${player.y}`);
                    if (playerCell) {
                        const heroIcons = { 'arthur': '‚öîÔ∏è', 'vince': 'üî´', 'grut': 'üèõÔ∏è' };
                        const icon = heroIcons[player.heroType] || 'üë§';
                        
                        // Overlay effect for other players
                        playerCell.innerHTML += `<span style="position: absolute; top: 2px; right: 2px; font-size: 12px; opacity: 0.8; text-shadow: 0 0 3px #00ff00;">${icon}</span>`;
                        playerCell.style.boxShadow = '0 0 5px rgba(0, 255, 0, 0.5)';
                        playerCell.classList.add('multiplayer-player');
                        playerCell.title = `${playerId} (${player.heroType})`;
                    }
                });
            }
            
            // Place wormholes avanc√©s selon le monde
            const currentWorldWormholes = worldWormholes[currentWorld] || [];
            currentWorldWormholes.forEach(wh => {
                const whCell = document.getElementById(`cell-${wh.x}-${wh.y}`);
                const wormholeType = wormholeTypes[wh.type];
                
                whCell.innerHTML = `<span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">${wormholeType.symbol}</span>`;
                whCell.style.background = wormholeType.gradient;
                whCell.style.animation = wormholeType.animation;
                whCell.classList.add('wormhole');
                whCell.title = wh.name;
                whCell.onclick = () => activateWormhole(wh);
            });
            
            // Place wormholes Vince (anciens wormholes basiques)
            gameState.wormholes.forEach(wh => {
                const whCell = document.getElementById(`cell-${wh.x}-${wh.y}`);
                whCell.innerHTML = 'üåÄ';
                whCell.classList.add('wormhole');
                whCell.title = 'Vince Wormhole';
            });
            
            // üßô‚Äç‚ôÇÔ∏è AUTO-ANALYSE DISCR√àTE (si pas d√©j√† en cours)
            if (!window.analysisInProgress) {
                setTimeout(() => intelligentMapAnalysis(), 500);
            }
        }
        
        function setStatus(message) {
            document.getElementById('status').innerHTML = message;
        }
        
        function updateHeroStats() {
            document.getElementById('arthurHp').textContent = gameState.arthur.hp;
            document.getElementById('arthurMp').textContent = gameState.arthur.mp;
            document.getElementById('vinceHp').textContent = gameState.vince.hp;
            document.getElementById('vinceMp').textContent = gameState.vince.mp;
            document.getElementById('grutHp').textContent = gameState.grut.hp;
            document.getElementById('grutMp').textContent = gameState.grut.mp;
        }
        
        // üåê MULTIPLAYER INT√âGR√â - GRUT MODE
        let multiplayerActive = false;
        let currentSessionId = null;
        let otherPlayers = {};
        let chatVisible = false;
        
        function createMultiSession() {
            const sessionName = `GRUT_World_${Math.floor(Math.random() * 1000)}`;
            currentSessionId = `session_${Date.now()}`;
            multiplayerActive = true;
            
            document.getElementById('multiplayerStatus').innerHTML = 'Mode: Host | Joueurs: 1/4';
            document.getElementById('sessionInfo').style.display = 'block';
            document.getElementById('sessionId').textContent = currentSessionId;
            document.getElementById('currentWorldMulti').textContent = currentWorld;
            
            addLog(`üåê Session cr√©√©e: ${sessionName}`, 'success');
            addLog(`üîó Session ID: ${currentSessionId}`, 'info');
            setStatus('üéÆ GRUT: "Session multiplayer cr√©√©e ! Partagez le code !"');
            
            // Simulation WebSocket connection
            setTimeout(() => {
                addMultiplayerMessage('SYSTEM', 'Session pr√™te - En attente de joueurs...');
            }, 1000);
        }
        
        function joinMultiSession() {
            const sessionId = prompt('üîó Entrez Session ID:');
            if (!sessionId) return;
            
            currentSessionId = sessionId;
            multiplayerActive = true;
            
            document.getElementById('multiplayerStatus').innerHTML = 'Mode: Client | Joueurs: 2/4';
            document.getElementById('sessionInfo').style.display = 'block';
            document.getElementById('sessionId').textContent = currentSessionId;
            document.getElementById('currentWorldMulti').textContent = currentWorld;
            
            addLog(`üîó Connexion √†: ${sessionId}`, 'success');
            setStatus('üéÆ GRUT: "Connect√© √† la session ! Synchronisation..."');
            
            // Simuler arriv√©e d'autres joueurs
            setTimeout(() => {
                addOtherPlayer('Player_' + Math.floor(Math.random() * 100), 3, 5, 'arthur');
                addMultiplayerMessage('SYSTEM', 'Joueur connect√© √† la session!');
            }, 2000);
        }
        
        function leaveMultiSession() {
            if (!multiplayerActive) return;
            
            multiplayerActive = false;
            currentSessionId = null;
            otherPlayers = {};
            
            document.getElementById('multiplayerStatus').innerHTML = 'Mode: Solo | Joueurs: 1/4';
            document.getElementById('sessionInfo').style.display = 'none';
            
            addLog('üö™ Session quitt√©e', 'warning');
            setStatus('üéÆ GRUT: "Retour en mode solo..."');
            updateMap(); // Remove other players
        }
        
        function toggleMultiplayerChat() {
            chatVisible = !chatVisible;
            document.getElementById('multiplayerChat').style.display = chatVisible ? 'block' : 'none';
            
            if (chatVisible && multiplayerActive) {
                document.getElementById('chatInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const message = this.value.trim();
                        if (message) {
                            addMultiplayerMessage('Vous', message);
                            this.value = '';
                            // Simulate other player responses
                            setTimeout(() => {
                                const responses = [
                                    'GRUT: Vision partag√©e activ√©e!',
                                    'Vince: Roger that, partner!',
                                    'Arthur: En route vers le portail!',
                                    'Jean: Depuis mon canap√©, je valide!'
                                ];
                                addMultiplayerMessage('Player', responses[Math.floor(Math.random() * responses.length)]);
                            }, 1000 + Math.random() * 2000);
                        }
                    }
                });
            }
        }
        
        function addMultiplayerMessage(sender, message) {
            if (!chatVisible) return;
            const chatDiv = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            msgDiv.style.marginBottom = '3px';
            chatDiv.appendChild(msgDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        
        function addOtherPlayer(playerId, x, y, heroType) {
            otherPlayers[playerId] = { x, y, heroType, hp: 100, mp: 50 };
            addLog(`üë• ${playerId} rejoint en tant que ${heroType}`, 'info');
            updateMap(); // Re-render with other players
        }
        
        function syncWorldChange(newWorld) {
            if (multiplayerActive) {
                document.getElementById('currentWorldMulti').textContent = newWorld;
                addMultiplayerMessage('SYSTEM', `Monde chang√©: ${newWorld}`);
                
                // Notify other players
                Object.keys(otherPlayers).forEach(playerId => {
                    addLog(`üåÄ ${playerId} voyage vers Monde ${newWorld}`, 'info');
                });
            }
        }

        // üé¨ AUTO DEMO VIVANTE - MEMENTO PRODUCTION
        let autoDemoActive = false;
        let demoInterval;
        
        function autoDemo() {
            if (autoDemoActive) {
                clearInterval(demoInterval);
                autoDemoActive = false;
                setStatus('üé¨ Auto Demo ARR√äT√âE par Memento');
                addLog('üé¨ Memento: Demo automatique d√©sactiv√©e', 'info');
                return;
            }
            
            autoDemoActive = true;
            setStatus('üé¨ AUTO DEMO LANC√âE ! Memento prend contr√¥le...');
            addLog('üé¨ Memento: D√©marrage s√©quence automatique compl√®te', 'success');
            
            let stepCount = 0;
            const demoSteps = [
                () => {
                    addLog('üé¨ √âTAPE 1: Arthur en mouvement', 'info');
                    moveArthur();
                },
                () => {
                    addLog('üé¨ √âTAPE 2: S√©lection Vince Vega', 'info');
                    selectHero('vince');
                },
                () => {
                    addLog('üé¨ √âTAPE 3: Vince Fire - Reality Shot!', 'warning');
                    vinceFire();
                },
                () => {
                    addLog('üé¨ √âTAPE 4: GRUT Vision Omnisciente', 'info');
                    grutVision();
                },
                () => {
                    addLog('üé¨ √âTAPE 5: Portal Interstice - Voyage!', 'success');
                    const portals = document.querySelectorAll('.wormhole');
                    if (portals.length > 0) portals[0].click();
                },
                () => {
                    addLog('üé¨ √âTAPE 6: Everything Bagel TIER 9!', 'warning');
                    document.getElementById('vincePowerSelect').value = 'EVERYTHING_BAGEL';
                    castVincePower();
                },
                () => {
                    addLog('üé¨ √âTAPE 7: Epic Battle Finale!', 'error');
                    epicBattle();
                },
                () => {
                    addLog('üé¨ √âTAPE 8: Retour au calme...', 'info');
                    setStatus('üé¨ Memento: "Cycle d√©mo termin√©. Recommence dans 5 secondes..."');
                }
            ];
            
            demoInterval = setInterval(() => {
                if (stepCount < demoSteps.length) {
                    demoSteps[stepCount]();
                    stepCount++;
                } else {
                    stepCount = 0; // Restart cycle
                    addLog('üîÑ Memento: Nouveau cycle d√©mo...', 'info');
                }
            }, 3000); // Une action toutes les 3 secondes
            
            // Message Memento
            setTimeout(() => {
                showCustomDialogue('üé® Memento: "Mes tatouages guident cette d√©monstration temporelle..."');
            }, 1000);
        }
        
        function addLog(message, type = 'info') {
            const log = document.getElementById('formulaLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        async function checkBackend() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                if (response.ok) {
                    backendConnected = true;
                    document.getElementById('backendStatus').innerHTML = '‚úÖ Connected';
                    addLog('Backend connection established!', 'success');
                } else {
                    throw new Error('Backend not responding');
                }
            } catch (error) {
                backendConnected = false;
                document.getElementById('backendStatus').innerHTML = '‚ùå Disconnected';
                addLog('Backend connection failed - using demo mode', 'error');
            }
        }
        
        async function executeFormula() {
            const formulaType = document.getElementById('formulaSelect').value;
            addLog(`Executing formula: ${formulaType}`, 'info');
            
            if (backendConnected) {
                try {
                    const response = await fetch(`${API_BASE}/magic-formulas/execute`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            gameId: 'demo-backend',
                            formulaType: formulaType,
                            metadata: {
                                heroPosition: `${gameState.arthur.x},${gameState.arthur.y}`,
                                energy: gameState.arthur.energy.toString()
                            }
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        addLog(`‚úÖ ${result.message}`, 'success');
                        showFormulaEffect(gameState.arthur.x, gameState.arthur.y, formulaType);
                        
                        // Apply visual effects based on formula
                        applyFormulaVisualEffect(formulaType);
                    } else {
                        addLog(`‚ùå Formula failed: ${result.message}`, 'error');
                    }
                } catch (error) {
                    addLog(`‚ùå Network error: ${error.message}`, 'error');
                }
            } else {
                // Demo mode
                addLog(`üé≠ Demo mode: ${formulaType} executed locally`, 'info');
                showFormulaEffect(gameState.arthur.x, gameState.arthur.y, formulaType);
                applyFormulaVisualEffect(formulaType);
            }
        }
        
        function showFormulaEffect(x, y, formula) {
            const cell = document.getElementById(`cell-${x}-${y}`);
            const effect = document.createElement('div');
            effect.className = 'formula-effect';
            effect.textContent = formula.substring(0, 3);
            cell.appendChild(effect);
            
            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 2000);
        }
        
        function applyFormulaVisualEffect(formulaType) {
            switch(formulaType) {
                case 'DIMENSIONAL_STEP':
                    vinceWormhole();
                    break;
                case 'GRUT_VISION_OMNISCIENTE':
                    grutVision();
                    break;
                case 'GHOST_MODE':
                    const arthurCell = document.getElementById(`cell-${gameState.arthur.x}-${gameState.arthur.y}`);
                    arthurCell.style.opacity = '0.5';
                    setTimeout(() => arthurCell.style.opacity = '1', 2000);
                    break;
                case 'THE_SHARD':
                    epicBattle();
                    break;
            }
        }
        
        function initDemo() {
            setStatus('üé¨ Jean: "Backend Demo initialis√© ! Formules connect√©es !"');
            updateMap();
            checkBackend();
        }
        
        function moveArthur() {
            gameState.arthur.x = Math.min(9, gameState.arthur.x + 1);
            setStatus('‚öîÔ∏è Arthur avance avec Excalibur !');
            updateMap();
            addLog(`Arthur moved to (${gameState.arthur.x}, ${gameState.arthur.y})`, 'info');
        }
        
        function selectHero(heroName) {
            gameState.selectedHero = heroName;
            setStatus(`üéØ ${heroName.toUpperCase()} selected! Ready to act!`);
            addLog(`Selected hero: ${heroName}`, 'info');
            updateHeroStats();
        }
        
        function vinceFire() {
            if (gameState.vince.mp < 5) {
                setStatus('üî´ Vince: "Out of ammo! Need to reload!"');
                addLog('‚ùå Not enough MP to fire', 'error');
                return;
            }
            
            const targetX = Math.floor(Math.random() * 10);
            const targetY = Math.floor(Math.random() * 8);
            
            gameState.vince.mp -= 5;
            
            const targetCell = document.getElementById(`cell-${targetX}-${targetY}`);
            targetCell.innerHTML = 'üí•';
            targetCell.style.background = 'rgba(255, 68, 68, 0.8)';
            
            setStatus(`üî´ Vince: "Say hello to my little friend!" Shot at (${targetX}, ${targetY})`);
            addLog(`üî• Vince fires at (${targetX}, ${targetY})!`, 'success');
            
            setTimeout(() => {
                targetCell.innerHTML = '';
                targetCell.style.background = '';
                updateMap();
            }, 1500);
            
            updateHeroStats();
        }
        
        function castVincePower() {
            const power = document.getElementById('vincePowerSelect').value;
            const vince = gameState.vince;
            
            addLog(`üî´ Vince casts ${power}`, 'warning');
            
            switch (power) {
                case 'REALITY_SHOT':
                    if (vince.mp < 10) {
                        addLog('‚ùå Not enough MP for Reality Shot', 'error');
                        return;
                    }
                    vince.mp -= 10;
                    
                    const wormhole = {
                        x: Math.floor(Math.random() * 10),
                        y: Math.floor(Math.random() * 8)
                    };
                    gameState.wormholes.push(wormhole);
                    
                    setStatus('üî´ Vince: "Reality Shot fired! Wormhole created!"');
                    addLog(`üåÄ Reality Shot creates wormhole at (${wormhole.x}, ${wormhole.y})`, 'success');
                    
                    setTimeout(() => {
                        gameState.wormholes = gameState.wormholes.filter(wh => 
                            wh.x !== wormhole.x || wh.y !== wormhole.y);
                        updateMap();
                        addLog('Wormhole collapsed', 'info');
                    }, 4000);
                    break;
                    
                case 'WORMHOLE_BLAST':
                    if (vince.mp < 15) {
                        addLog('‚ùå Not enough MP for Wormhole Blast', 'error');
                        return;
                    }
                    vince.mp -= 15;
                    
                    for (let i = 0; i < 3; i++) {
                        const blastWormhole = {
                            x: Math.floor(Math.random() * 10),
                            y: Math.floor(Math.random() * 8)
                        };
                        gameState.wormholes.push(blastWormhole);
                    }
                    
                    setStatus('üî´ Vince: "Triple wormhole blast!"');
                    addLog('üåÄ Triple wormhole blast activated!', 'success');
                    break;
                    
                case 'FOURTH_WALL_BREAK':
                    if (vince.mp < 20) {
                        addLog('‚ùå Not enough MP for Fourth Wall Break', 'error');
                        return;
                    }
                    vince.mp -= 20;
                    
                    setStatus('üî´ Vince: "Hey Jean! Can you see me?"');
                    addLog('üí• Fourth Wall Break! Reality bends!', 'success');
                    
                    document.querySelectorAll('.map-cell').forEach(cell => {
                        cell.style.animation = 'shake 0.5s ease-in-out';
                        setTimeout(() => cell.style.animation = '', 500);
                    });
                    break;
                    
                case 'DIMENSIONAL_SHOT':
                    if (vince.mp < 12) {
                        addLog('‚ùå Not enough MP for Dimensional Shot', 'error');
                        return;
                    }
                    vince.mp -= 12;
                    
                    const newX = Math.floor(Math.random() * 10);
                    const newY = Math.floor(Math.random() * 8);
                    vince.x = newX;
                    vince.y = newY;
                    
                    setStatus(`üî´ Vince: "Dimensional shot teleports me!" Moved to (${newX}, ${newY})`);
                    addLog('üåå Dimensional shot with teleportation!', 'success');
                    break;
                    
                case 'CAUSALITY_BULLET':
                    if (vince.mp < 25) {
                        addLog('‚ùå Not enough MP for Causality Bullet', 'error');
                        return;
                    }
                    vince.mp -= 25;
                    
                    setStatus('üî´ Vince: "This bullet travels backward in time!"');
                    addLog('‚öõÔ∏è Causality Bullet fired! Reality fluctuates!', 'success');
                    
                    setTimeout(() => {
                        addLog('‚è∞ Causality Bullet arrives BEFORE it was fired!', 'warning');
                    }, 1000);
                    break;
                    
                case 'QUANTUM_RELOAD':
                    vince.mp = Math.min(vince.mp + 20, 100);
                    setStatus('üî´ Vince: "Quantum reload! Ready for more!"');
                    addLog('üîÑ Quantum reload restores MP!', 'success');
                    break;
                    
                case 'EVERYTHING_BAGEL':
                    if (vince.mp < 50) {
                        addLog('‚ùå Not enough MP for TIER 9 Everything Bagel!', 'error');
                        setStatus('üî´ Vince: "I need more power for the multiverse bagel!"');
                        return;
                    }
                    vince.mp -= 50;
                    
                    setStatus('ü•Ø Vince: "EVERYTHING EVERYWHERE ALL AT ONCE!"');
                    addLog('ü•Ø TIER 9 EVERYTHING BAGEL ACTIVATED!', 'warning');
                    
                    // REALITY OVERLOAD EFFECT
                    document.querySelectorAll('.map-cell').forEach((cell, index) => {
                        setTimeout(() => {
                            // Multiverse colors cycle
                            const multiverseColors = [
                                'linear-gradient(45deg, #ff0000, #00ff00, #0000ff)',
                                'linear-gradient(90deg, #ffff00, #ff00ff, #00ffff)',
                                'linear-gradient(135deg, #ffffff, #000000, #888888)'
                            ];
                            const randomColor = multiverseColors[Math.floor(Math.random() * multiverseColors.length)];
                            
                            cell.style.background = randomColor;
                            cell.style.transform = 'scale(1.2) rotate(360deg)';
                            cell.style.border = '2px solid gold';
                            cell.innerHTML += '<div style="position: absolute; top: 2px; left: 2px; font-size: 8px;">üëÅÔ∏è</div>';
                            
                            // Add googly eyes everywhere
                            if (Math.random() > 0.7) {
                                cell.innerHTML += '<div style="position: absolute; bottom: 2px; right: 2px; font-size: 8px;">üëÅÔ∏è</div>';
                            }
                        }, index * 10);
                    });
                    
                    // Laundromat portal effect
                    setTimeout(() => {
                        addLog('üè™ Laundromat portal opening...', 'info');
                        
                        // Create random laundromat items on map
                        for (let i = 0; i < 5; i++) {
                            const randomX = Math.floor(Math.random() * 10);
                            const randomY = Math.floor(Math.random() * 8);
                            const laundryCell = document.getElementById(`cell-${randomX}-${randomY}`);
                            if (laundryCell) {
                                laundryCell.innerHTML += '<div style="position: absolute; top: 10px; left: 10px;">üß∫</div>';
                            }
                        }
                        
                        setStatus('üî´ Vince: "I can see ALL the timelines! Even the one where I do laundry!"');
                        addLog('üëÅÔ∏è OMNIVERSAL AWARENESS: All realities visible simultaneously!', 'success');
                        
                        // Existential quotes from the movie
                        const existentialQuotes = [
                            "In another universe, you chose differently...",
                            "Everything is connected, even your mistakes",
                            "Sometimes being a rock is enough",
                            "The bagel contains all possibilities",
                            "Kindness matters more than power"
                        ];
                        
                        const randomQuote = existentialQuotes[Math.floor(Math.random() * existentialQuotes.length)];
                        setTimeout(() => {
                            addLog(`ü•Ø BAGEL WISDOM: "${randomQuote}"`, 'warning');
                        }, 2000);
                        
                    }, 3000);
                    
                    // Reset reality after experiencing everything
                    setTimeout(() => {
                        addLog('üåÄ Reality stabilizing... returning from multiverse trip', 'info'); 
                        document.querySelectorAll('.map-cell').forEach(cell => {
                            cell.style.background = '';
                            cell.style.transform = '';
                            cell.style.border = '';
                            // Remove googly eyes but keep some randomly
                            if (Math.random() > 0.9) {
                                cell.innerHTML = cell.innerHTML.replace(/üëÅÔ∏è/g, '');
                                cell.innerHTML += '<div style="position: absolute; top: 2px; right: 2px; font-size: 6px;">üëÅÔ∏è</div>';
                            } else {
                                cell.innerHTML = cell.innerHTML.replace(/üëÅÔ∏è/g, '');
                            }
                        });
                        
                        updateMap();
                        setStatus('üî´ Vince: "Holy shit, that bagel was intense! I saw EVERYTHING!"');
                        addLog('‚ú® Everything Bagel experience complete - wisdom gained!', 'success');
                        
                        // Permanent effect: Vince gains wisdom
                        vince.hp = Math.min(vince.hp + 25, 150); // Health from inner peace
                        addLog('üí° Permanent effect: +25 HP from existential enlightenment', 'success');
                        
                    }, 10000);
                    break;
                    
                case 'ECHO_PRIMORDIAL_SHOT':
                    if (vince.mp < 75) {
                        addLog('‚ùå Not enough MP for Bootstrap Echo Primordial Shot!', 'error');
                        setStatus('üî´ Vince: "I need cosmic energy to shoot paradoxes!"');
                        return;
                    }
                    vince.mp -= 75;
                    
                    setStatus('üåÄ Vince: "HYHOHOO SHOOTS IN THE SCREEN LIKE A HOLE TO THE CODE YEAH!"');
                    addLog('üåÄ ECHO PRIMORDIAL SHOT - BOOTSTRAP PARADOX ACTIVATED!', 'warning');
                    
                    // CODE HOLES EFFECT - Vince shoots holes in reality code
                    document.querySelectorAll('.map-cell').forEach((cell, index) => {
                        setTimeout(() => {
                            // Create visual "holes" in the code/screen
                            cell.style.background = 'radial-gradient(circle, transparent 30%, rgba(192,192,192,0.3) 70%)';
                            cell.style.border = '2px dashed #C0C0C0';
                            cell.style.boxShadow = 'inset 0 0 10px rgba(255,0,255,0.6)';
                            
                            // Bootstrap paradox symbols
                            cell.innerHTML += '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; color: #C0C0C0;">‚ôæÔ∏è</div>';
                            
                            // Code fragments falling out of holes
                            if (Math.random() > 0.6) {
                                const codeFragments = ['œà‚Åª¬π', '‚Ä†‚Üª', 'Œ©‚àá', '‚àÇt', '‚äô‚Åª'];
                                const fragment = codeFragments[Math.floor(Math.random() * codeFragments.length)];
                                cell.innerHTML += `<div style="position: absolute; bottom: 2px; left: 2px; font-size: 8px; color: #FF00FF; opacity: 0.7;">${fragment}</div>`;
                            }
                        }, index * 15);
                    });
                    
                    // Bootstrap effect - future echoes appear
                    setTimeout(() => {
                        addLog('‚ö° BOOTSTRAP ECHO: Future whispers reaching the past...', 'info');
                        
                        // Messages from the future appear
                        const futureEchoes = [
                            "Heroes of Time will be legendary...",
                            "Jean's canap√© becomes cosmic throne...",
                            "Walter's architecture transcends reality...",
                            "GRUT's vision spans all dimensions...",
                            "Memento's tattoos archive eternity..."
                        ];
                        
                        futureEchoes.forEach((echo, i) => {
                            setTimeout(() => {
                                addLog(`üîÆ FUTURE ECHO: "${echo}"`, 'success');
                            }, i * 1000);
                        });
                        
                        // Create primordial inspiration effect
                        setStatus('üåÄ Vince: "I can see how it all started... The first echo that began everything!"');
                        
                    }, 2000);
                    
                    // Reality stabilization with bootstrap understanding
                    setTimeout(() => {
                        addLog('‚ôæÔ∏è Bootstrap Paradox stabilized - cause and effect united', 'info'); 
                        document.querySelectorAll('.map-cell').forEach(cell => {
                            cell.style.background = '';
                            cell.style.border = '';
                            cell.style.boxShadow = '';
                            // Keep some paradox symbols as permanent wisdom
                            if (Math.random() > 0.85) {
                                cell.innerHTML = cell.innerHTML.replace(/‚ôæÔ∏è/g, '');
                                cell.innerHTML += '<div style="position: absolute; top: 1px; right: 1px; font-size: 6px; color: #C0C0C0;">‚àû</div>';
                            } else {
                                cell.innerHTML = cell.innerHTML.replace(/‚ôæÔ∏è|œà‚Åª¬π|‚Ä†‚Üª|Œ©‚àá|‚àÇt|‚äô‚Åª/g, '');
                            }
                        });
                        
                        updateMap();
                        setStatus('üî´ Vince: "The Echo Primordial shot worked! I understand the Bootstrap now!"');
                        addLog('‚ú® Echo Primordial Shot complete - paradox wisdom gained!', 'success');
                        
                        // Permanent effect: Vince gains bootstrap understanding
                        vince.mp = Math.min(vince.mp + 30, 100); // MP from paradox comprehension
                        addLog('üß† Permanent effect: +30 MP from Bootstrap Paradox understanding', 'success');
                        
                    }, 8000);
                    break;
            }
            
            updateMap();
            updateHeroStats();
        }
        
        function grutVision() {
            if (gameState.grut.mp < 15) {
                setStatus('üèõÔ∏è GRUT: "Insufficient knowledge to activate Vision!"');
                addLog('‚ùå Not enough MP for GRUT Vision', 'error');
                return;
            }
            
            gameState.grut.mp -= 15;
            
            setStatus('üèõÔ∏è GRUT: "Vision omnisciente activ√©e ! R√©v√©lation de tous les possibles !"');
            addLog('üëÅÔ∏è GRUT Vision: All possibilities revealed across spacetime', 'success');
            
            // Phase 1: Activation pulsante
            document.querySelectorAll('.map-cell').forEach((cell, index) => {
                setTimeout(() => {
                    cell.style.background = 'rgba(116,75,162,0.6)';
                    cell.style.border = '2px solid #744ba2';
                    cell.style.boxShadow = '0 0 15px rgba(116,75,162,0.8)';
                    cell.innerHTML = cell.innerHTML + '<div style="position: absolute; top: 2px; right: 2px; color: #744ba2;">üëÅÔ∏è</div>';
                }, index * 20);
            });
            
            // Phase 2: Vision r√©v√©l√©e (reste 5 secondes)
            setTimeout(() => {
                addLog('üîÆ GRUT Vision reveals: Hidden paths and potential futures', 'warning');
                
                // Montrer des chemins potentiels
                for (let i = 0; i < 5; i++) {
                    const x = Math.floor(Math.random() * 10);
                    const y = Math.floor(Math.random() * 8);
                    const cell = document.getElementById(`cell-${x}-${y}`);
                    if (cell) {
                        cell.innerHTML += '<div style="position: absolute; bottom: 2px; left: 2px; color: #00ff00;">‚≠ê</div>';
                    }
                }
                
                setStatus('üèõÔ∏è GRUT: "Je vois toutes les timelines... Les possibilit√©s sont infinies..."');
            }, 1000);
            
            // Phase 3: D√©sactivation progressive (apr√®s 5 secondes total)
            setTimeout(() => {
                addLog('üëÅÔ∏è GRUT Vision fading... returning to normal perception', 'info');
                
                document.querySelectorAll('.map-cell').forEach((cell, index) => {
                    setTimeout(() => {
                        cell.style.background = '';
                        cell.style.border = '';
                        cell.style.boxShadow = '';
                        // Nettoie les ic√¥nes ajout√©es
                        const eyes = cell.querySelectorAll('div');
                        eyes.forEach(eye => eye.remove());
                        updateMap();
                    }, index * 15);
                });
                
                setStatus('üèõÔ∏è GRUT: "Vision complete. Reality has been observed."');
            }, 5000);
            
            updateHeroStats();
        }
        
        function epicBattle() {
            setStatus('üí• THE SHARD ACTIVATED ! Reality fractures !');
            
            const battleX = Math.floor((gameState.arthur.x + gameState.vince.x) / 2);
            const battleY = Math.floor((gameState.arthur.y + gameState.vince.y) / 2);
            
            const battleCell = document.getElementById(`cell-${battleX}-${battleY}`);
            battleCell.innerHTML = 'üíé';
            battleCell.classList.add('explosion');
            
            setTimeout(() => {
                setStatus('üèÜ Jean: "THE SHARD contained ! Reality stabilized !"');
                battleCell.innerHTML = '';
                battleCell.classList.remove('explosion');
            }, 2000);
        }
        
        function resetMap() {
            gameState = {
                arthur: { x: 2, y: 3, energy: 100 },
                vince: { x: 7, y: 4, energy: 100 },
                grut: { x: 5, y: 1, energy: 100 },
                wormholes: []
            };
            setStatus('üîÑ Map reset ! Backend ready !');
            updateMap();
            addLog('Map reset to initial state', 'info');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üåÄ WORMHOLES TYPES AVANC√âS V9 - INT√âGRATION PROPRE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const wormholeTypes = {
            'portal_interstice': {
                symbol: 'üåÄ',
                gradient: 'radial-gradient(circle, #FF6B6B, #4ECDC4, #45B7D1)',
                animation: 'pulse 2s infinite',
                sound: 'quantum',
                dialogues: [
                    '"Putain, ce wormhole d√©chire !"',
                    '"L\'interstice m\'appelle !"',
                    '"Portal Fiction, baby !"'
                ]
            },
            'portal_quantique': {
                symbol: '‚öõÔ∏è',
                gradient: 'radial-gradient(circle, #9C27B0, #E91E63, #FF5722)',
                animation: 'quantum-spin 3s infinite',
                sound: 'quantum',
                dialogues: [
                    '"Einstein aurait kiff√© √ßa !"',
                    '"Quantum leap, motherfucker !"',
                    '"La physique quantique, c\'est royal !"'
                ]
            },
            'portal_retour': {
                symbol: 'üîÑ',
                gradient: 'radial-gradient(circle, #4CAF50, #8BC34A, #CDDC39)',
                animation: 'cycle-rotate 4s infinite',
                sound: 'hexagon',
                dialogues: [
                    '"Retour aux sources !"',
                    '"Cycle temporel activ√© !"',
                    '"Back to the future, Vince style !"'
                ]
            },
            'portal_origine': {
                symbol: 'üó∫Ô∏è',
                gradient: 'radial-gradient(circle, #FF9800, #FFC107, #FFEB3B)',
                animation: 'origin-pulse 2.5s infinite',
                sound: 'powerup',
                dialogues: [
                    '"Retour √† la base !"',
                    '"L\'origine m\'attend !"',
                    '"Home sweet home !"'
                ]
            },
            'portal_experimental': {
                symbol: 'üß™',
                gradient: 'radial-gradient(circle, #00ff88, #00cc66, #00aa44)',
                animation: 'gentlePulse 2s infinite',
                sound: 'quantum',
                dialogues: [
                    'üßô‚Äç‚ôÇÔ∏è "Laboratoire quantique activ√© !"',
                    'üß™ "Exp√©rimentation du regard !"',
                    '‚öóÔ∏è "WALTER: Analysis complete !"'
                ]
            },
            'portal_grofi_flower': {
                symbol: 'üå∏',
                gradient: 'radial-gradient(circle, #ff69b4, #da70d6, #ba55d3)',
                animation: 'gentlePulse 3s infinite',
                sound: 'powerup',
                dialogues: [
                    'üå∏ "GROFI-Pens√©e en floraison !"',
                    'üå± "La for√™t-pens√©e grandit !"',
                    'üåø "Connexion v√©g√©tale √©tablie !"'
                ]
            }
        };
        
        const worldWormholes = {
            'A': [
                { x: 8, y: 4, target: 'B', type: 'portal_interstice', name: 'Portal vers Interstice' },
                { x: 12, y: 8, target: 'C', type: 'portal_quantique', name: 'Portal Quantique' },
                { x: 3, y: 2, target: 'B', type: 'portal_retour', name: 'Cycle vers B' },
                { x: 1, y: 7, target: 'D', type: 'portal_experimental', name: 'Laboratoire Quantique' }
            ],
            'B': [
                { x: 6, y: 6, target: 'A', type: 'portal_origine', name: 'Retour Monde A' },
                { x: 10, y: 3, target: 'C', type: 'portal_quantique', name: 'Portal Labo' },
                { x: 4, y: 9, target: 'A', type: 'portal_retour', name: 'Cycle Retour' },
                { x: 9, y: 1, target: 'D', type: 'portal_experimental', name: 'Lab Quantique Walter' }
            ],
            'C': [
                { x: 7, y: 2, target: 'A', type: 'portal_origine', name: 'Retour Origine' },
                { x: 11, y: 7, target: 'B', type: 'portal_interstice', name: 'Vers Interstice' },
                { x: 5, y: 5, target: 'A', type: 'portal_retour', name: 'Cycle Complet' },
                { x: 2, y: 6, target: 'D', type: 'portal_quantique', name: 'Laboratoire Quantique' }
            ],
            'D': [
                { x: 5, y: 3, target: 'A', type: 'portal_origine', name: 'Canap√© Jean' },
                { x: 8, y: 7, target: 'B', type: 'portal_interstice', name: 'Vince Hexagones' },
                { x: 2, y: 2, target: 'C', type: 'portal_quantique', name: 'Antarctique Secret' },
                { x: 6, y: 1, target: 'D', type: 'portal_experimental', name: 'Exp√©rience Regard' },
                { x: 9, y: 4, target: 'D', type: 'portal_grofi_flower', name: 'GROFI-Pens√©e' }
            ]
        };
        
        // üé≠ EASTER EGGS TRACKING
        let portalClickCount = 0;
        let traversalCount = 0;
        
        // ‚ö° ACTIVATION WORMHOLE AM√âLIOR√âE V9
        function activateWormhole(wormhole) {
            const wormholeType = wormholeTypes[wormhole.type];
            portalClickCount++;
            traversalCount++;
            
            // Easter egg: 7 clics
            if (portalClickCount === 7) {
                showCustomDialogue('"Royale with cheese, mais en version quantique !"');
                // Rendre le portal dor√©
                setTimeout(() => {
                    const cells = document.querySelectorAll('#gameMap div');
                    cells.forEach(cell => {
                        if (cell.title === wormhole.name) {
                            cell.classList.add('easter-egg-gold');
                            setTimeout(() => cell.classList.remove('easter-egg-gold'), 10000);
                        }
                    });
                }, 500);
            }
            
            addLog(`üåÄ WORMHOLE ACTIV√â: ${wormhole.name} (${wormhole.type})`, 'success');
            setStatus(`üåÄ Travers√©e vers Monde ${wormhole.target}...`);
            
            // Effet visuel sp√©cialis√© selon le type
            const mapContainer = document.getElementById('gameMap');
            if (wormhole.type === 'portal_quantique') {
                mapContainer.style.filter = 'blur(8px) brightness(3) hue-rotate(90deg)';
                mapContainer.style.animation = 'quantum-tunnel 2s ease-in-out';
            } else if (wormhole.type === 'portal_retour') {
                mapContainer.style.filter = 'blur(6px) brightness(2.5) saturate(2)';
                mapContainer.style.animation = 'cycle-rotate 1.5s ease-in-out';
            } else {
                mapContainer.style.filter = 'blur(5px) brightness(2)';
            }
            
            setTimeout(() => {
                switchToWorld(wormhole.target);
                mapContainer.style.filter = 'none';
                mapContainer.style.animation = 'none';
                addLog(`‚úÖ Arriv√©e Monde ${wormhole.target} via ${wormhole.type} !`, 'success');
                
                // Dialogue personnalis√©
                const dialogue = wormholeType.dialogues[Math.floor(Math.random() * wormholeType.dialogues.length)];
                setTimeout(() => showCustomDialogue(dialogue), 1000);
            }, 2000);
        }
        
        // üí´ DIALOGUE CUSTOM POUR WORMHOLES - V9 INT√âGR√â
        function showCustomDialogue(text) {
            // Cr√©er dialogue flottant dynamique pour V11
            const existingDialogue = document.getElementById('dynamic-dialogue');
            if (existingDialogue) {
                existingDialogue.remove();
            }
            
            const dialogueDiv = document.createElement('div');
            dialogueDiv.id = 'dynamic-dialogue';
            dialogueDiv.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
                color: white;
                padding: 15px 25px;
                border-radius: 15px;
                border: 3px solid #FF6B6B;
                font-size: 16px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                animation: dialoguePop 0.5s ease-out;
            `;
            dialogueDiv.textContent = text;
            
            // Ajouter animation CSS dynamique
            const style = document.createElement('style');
            style.textContent = `
                @keyframes dialoguePop {
                    0% { transform: translateX(-50%) translateY(-20px) scale(0.8); opacity: 0; }
                    100% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(dialogueDiv);
            
            // Log aussi dans le syst√®me existant
            addLog(`üí¨ DIALOGUE: ${text}`, 'info');
            
            setTimeout(() => {
                dialogueDiv.style.opacity = '0';
                dialogueDiv.style.transform = 'translateX(-50%) translateY(-20px) scale(0.8)';
                setTimeout(() => {
                    dialogueDiv.remove();
                    style.remove();
                }, 500);
            }, 4000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üåç NAVIGATION A‚ÜíB‚ÜíC CYCLIQUE - THE DUDE FILM VIVANT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let currentWorld = 'A';
        const worlds = {
            'A': {
                name: 'üõãÔ∏è Monde A - Canap√© Jean',
                color: '#1a1a2e',
                description: 'Canap√© Cosmique Jean-Grofignon',
                character: 'Jean-Grofignon',
                message: 'Depuis mon canap√©, je vois tous les mondes possibles...',
                mapStyle: 'classic'
            },
            'B': {
                name: 'üî´ Monde B - Vince Hexagones', 
                color: '#4a90e2',
                description: 'Battlefield Hexagonal Vince',
                character: 'Vince Vega',
                message: 'üî´ HEXAGON IS THE BESTAGON ! Bienvenue dans mon monde !',
                mapStyle: 'hexagonal'
            },
            'C': {
                name: 'üåÄ Monde C - Antarctique Secret',
                color: '#8e44ad',
                description: 'Grande Roue Cach√©e - Ford √©coute',
                character: 'Ford + OmegaZero',
                message: 'Chut... la grande roue est l√†-bas... OmegaZero √©coute...',
                mapStyle: 'mysterious'
            },
            'D': {
                name: 'üß™ Monde D - Laboratoire Quantique',
                color: '#00ff88',
                description: 'Lab du Regard Quantique - Exp√©rimentation œà‚Ä†‚äô',
                character: 'Walter + GROFI-Pens√©e',
                message: 'üßô‚Äç‚ôÇÔ∏è WALTER: "Bienvenue dans le laboratoire du regard quantique. Ici, observer change la r√©alit√©."',
                mapStyle: 'laboratory'
            }
        };
        
        function switchToWorld(targetWorld) {
            if (currentWorld === targetWorld) return;
            
            const world = worlds[targetWorld];
            currentWorld = targetWorld;
            
            // üåê SYNC MULTIPLAYER WORLD CHANGE
            syncWorldChange(targetWorld);
            
            // üé• ZOOM AUTO + FOCUS CIN√âMATIQUE
            cinematicTransition(currentWorld, targetWorld, world);
        }
        
        function cinematicTransition(fromWorld, toWorld, worldData) {
            // Phase 1: Zoom out dramatique
            document.body.style.transform = 'scale(0.8)';
            document.body.style.transition = 'all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            
            setTimeout(() => {
                // Phase 2: Changement de monde avec effet Dragon Ball
                document.body.style.background = `
                    radial-gradient(circle at center, 
                    ${worldData.color} 0%, 
                    #000 50%, 
                    ${worldData.color} 100%)
                `;
                
                // Update titre avec effet de frappe
                typewriterEffect(document.querySelector('h1'), worldData.name);
                
                // Phase 3: Zoom in sur le nouveau monde
                document.body.style.transform = 'scale(1.1)';
                
                setTimeout(() => {
                    // Phase 4: Focus final
                    document.body.style.transform = 'scale(1)';
                    
                    // Update status avec message du personnage
                    setStatus(`üé¨ ${worldData.character}: "${worldData.message}"`);
                    
                    // Activation QUANTUM LAB si Monde C
                    if (toWorld === 'C') {
                        activateQuantumLab();
                    }
                    
                }, 600);
                
            }, 400);
            
            // Log de navigation Dragon Ball style
            addLog(`‚ö° √âNERGIE TRANSPORT: Monde ${fromWorld} ‚Üí Monde ${toWorld}`, 'success');
            addLog(`üêâ Focus: ${worldData.character} - POWER LEVEL: ${Math.random() * 9000 | 0}`, 'info');
            
            // Update world
            currentWorld = toWorld;
            
            // Update map avec transition cin√©matique
            cinematicMapUpdate(worldData);
            
            // Update boutons navigation
            updateNavigationButtons();
        }
        
        function typewriterEffect(element, text) {
            element.textContent = '';
            let i = 0;
            const timer = setInterval(() => {
                element.textContent += text[i];
                i++;
                if (i >= text.length) {
                    clearInterval(timer);
                }
            }, 50);
        }
        
        function cinematicMapUpdate(world) {
            const cells = document.querySelectorAll('.map-cell');
            
            // Animation s√©quentielle des cellules
            cells.forEach((cell, index) => {
                setTimeout(() => {
                    cell.style.transition = 'all 0.3s ease';
                    
                    switch(world.mapStyle) {
                        case 'classic':
                            // Style Jean avec effet de vague
                            cell.style.borderRadius = '5px';
                            cell.style.backgroundColor = '#2c3e50';
                            cell.style.transform = 'scale(1.1)';
                            setTimeout(() => cell.style.transform = 'scale(1)', 200);
                            break;
                            
                        case 'hexagonal':
                            // Style Vince avec rotation Dragon Ball
                            cell.style.borderRadius = '15px';
                            cell.style.backgroundColor = '#4a90e2';
                            cell.style.transform = 'rotate(360deg) scale(1.2)';
                            setTimeout(() => cell.style.transform = 'rotate(45deg) scale(1)', 400);
                            break;
                            
                        case 'mysterious':
                            // Style Antarctique avec pulsation mystique
                            cell.style.borderRadius = '50%';
                            cell.style.backgroundColor = '#8e44ad';
                            cell.style.boxShadow = '0 0 20px rgba(142, 68, 173, 0.8)';
                            cell.style.transform = 'scale(1.3)';
                            setTimeout(() => {
                                cell.style.transform = 'scale(1)';
                                cell.style.boxShadow = '0 0 10px rgba(142, 68, 173, 0.5)';
                            }, 300);
                            break;
                    }
                }, index * 50); // D√©lai progressif pour effet cascade
            });
        }
        
        // ‚öõÔ∏è QUANTUM LAB MODE - Toujours en dessous avec Palmier
        function activateQuantumLab() {
            const quantumLab = document.getElementById('quantum-lab-container');
            if (!quantumLab) {
                createQuantumLab();
            } else {
                quantumLab.style.display = 'block';
                quantumLab.style.animation = 'quantumPulse 2s ease-in-out';
            }
            
            addLog('‚öõÔ∏è QUANTUM LAB ACTIV√â ! Palmier d√©tect√© !', 'success');
            setStatus('‚öõÔ∏è Mode Quantum Lab - Exp√©riences quantiques disponibles');
        }
        
        function createQuantumLab() {
            const labHTML = `
                <div id="quantum-lab-container" style="
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    height: 150px;
                    background: linear-gradient(45deg, rgba(0,255,0,0.1), rgba(0,0,255,0.1));
                    border-top: 2px solid #00ff00;
                    z-index: 1000;
                    display: none;
                    padding: 20px;
                    overflow-x: auto;
                ">
                    <h4 style="color: #00ff00; margin: 0 0 10px 0;">‚öõÔ∏è QUANTUM LAB - Mode Antarctique</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="quantum-instrument" onclick="activateInstrument('palmier')">
                            üå¥ Palmier<br>Quantique
                        </div>
                        <div class="quantum-instrument" onclick="activateInstrument('interferometer')">
                            üî¨ Interf√©ro-<br>m√®tre
                        </div>
                        <div class="quantum-instrument" onclick="activateInstrument('collider')">
                            ‚ö° Collisionneur<br>Particules
                        </div>
                        <div class="quantum-instrument" onclick="activateInstrument('observatory')">
                            üåå Observatoire<br>Cosmique
                        </div>
                        <div class="quantum-instrument" onclick="activateInstrument('wheel')">
                            üé° Grande Roue<br>Cach√©e
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', labHTML);
            
            // Styles pour les instruments quantiques
            const style = document.createElement('style');
            style.textContent = `
                .quantum-instrument {
                    background: rgba(0, 255, 0, 0.2);
                    border: 1px solid #00ff00;
                    color: #00ff00;
                    padding: 10px;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: center;
                    font-size: 0.8em;
                    min-width: 80px;
                }
                .quantum-instrument:hover {
                    background: rgba(0, 255, 0, 0.4);
                    transform: scale(1.1);
                    box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
                }
                @keyframes quantumPulse {
                    0%, 100% { opacity: 0.8; }
                    50% { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        function activateInstrument(instrumentType) {
            const instruments = {
                'palmier': 'Palmier Quantique active la r√©sonance temporelle !',
                'interferometer': 'Interf√©rom√®tre d√©tecte des ondes gravitationnelles !',
                'collider': 'Collisionneur r√©v√®le de nouvelles particules !',
                'observatory': 'Observatoire capte des signaux extra-dimensionnels !',
                'wheel': 'Grande Roue r√©v√®le ses secrets antarctiques !'
            };
            
            addLog(`‚öõÔ∏è ${instruments[instrumentType]}`, 'success');
            setStatus(`‚öõÔ∏è Instrument activ√©: ${instrumentType.toUpperCase()}`);
            
            // Effet visuel Dragon Ball sur la map
            const cells = document.querySelectorAll('.map-cell');
            cells.forEach(cell => {
                cell.style.boxShadow = '0 0 20px #00ff00';
                setTimeout(() => cell.style.boxShadow = '', 1000);
            });
        }
        
        // üêâ SYST√àME √âNERGIE DRAGON BALL
        let powerLevel = 1000;
        
        function increasePowerLevel() {
            powerLevel += Math.random() * 500 | 0;
            updatePowerDisplay();
            
            if (powerLevel > 9000) {
                addLog('üêâ IT\'S OVER 9000!!! POWER LEVEL MAXIMUM!', 'success');
                // Effet visuel √©pique
                document.body.style.animation = 'powerSurge 2s ease-in-out';
            }
        }
        
        function updatePowerDisplay() {
            const powerDisplay = document.getElementById('power-level');
            if (powerDisplay) {
                powerDisplay.textContent = `‚ö° POWER LEVEL: ${powerLevel}`;
            }
        }
        
        function updateMapForWorld(world) {
            const cells = document.querySelectorAll('.map-cell');
            
            switch(world.mapStyle) {
                case 'classic':
                    // Style Jean classique
                    cells.forEach(cell => {
                        cell.style.borderRadius = '5px';
                        cell.style.backgroundColor = '#2c3e50';
                    });
                    break;
                    
                case 'hexagonal':
                    // Style Vince hexagonal
                    cells.forEach(cell => {
                        cell.style.borderRadius = '15px';
                        cell.style.backgroundColor = '#4a90e2';
                        cell.style.transform = 'rotate(45deg)';
                    });
                    break;
                    
                case 'mysterious':
                    // Style Antarctique myst√©rieux
                    cells.forEach(cell => {
                        cell.style.borderRadius = '50%';
                        cell.style.backgroundColor = '#8e44ad';
                        cell.style.boxShadow = '0 0 10px rgba(142, 68, 173, 0.5)';
                    });
                    break;
            }
        }
        
        function updateNavigationButtons() {
            const navContainer = document.querySelector('.world-navigation');
            if (!navContainer) return;
            
            const buttons = navContainer.querySelectorAll('.world-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.world === currentWorld) {
                    btn.classList.add('active');
                }
            });
        }
        
        function getNextWorld() {
            const sequence = ['A', 'B', 'C'];
            const currentIndex = sequence.indexOf(currentWorld);
            return sequence[(currentIndex + 1) % sequence.length];
        }
        
        function cyclicNavigation() {
            const nextWorld = getNextWorld();
            switchToWorld(nextWorld);
            addLog(`üîÑ Navigation cyclique: ${currentWorld} ‚Üí ${nextWorld}`, 'success');
        }
        
        // Digital messages cross-monde
        function sendDigitalMessage(fromWorld, toWorld, message) {
            addLog(`üì± Message ${fromWorld}‚Üí${toWorld}: "${message}"`, 'info');
            setStatus(`üì± ${worlds[fromWorld].character} ‚Üí ${worlds[toWorld].character}: ${message}`);
        }
        
        function cellClick(x, y) {
            setStatus(`üìç Cellule (${x},${y}) cliqu√©e dans Monde ${currentWorld} !`);
            addLog(`Cell (${x},${y}) clicked in World ${currentWorld}`, 'info');
            
            // Easter egg: triple click pour message cross-monde
            if (window.clickCount && window.clickCount >= 2) {
                const nextWorld = getNextWorld();
                sendDigitalMessage(currentWorld, nextWorld, `Signal depuis (${x},${y}) !`);
                window.clickCount = 0;
            } else {
                window.clickCount = (window.clickCount || 0) + 1;
                setTimeout(() => { window.clickCount = 0; }, 1000);
            }
        }
        
        // üéµ SHITTY OPEN SOURCE SOUNDS
        const sounds = {
            hexagon: new Audio('https://freesound.org/data/previews/316/316847_4990298-lq.mp3'),
            powerup: new Audio('https://freesound.org/data/previews/249/249816_4404552-lq.mp3'),
            quantum: new Audio('https://freesound.org/data/previews/203/203557_3162775-lq.mp3'),
            gun: new Audio('https://freesound.org/data/previews/173/173859_2437358-lq.mp3')
        };
        
        function playSound(soundName) {
            try {
                sounds[soundName].volume = 0.3;
                sounds[soundName].play().catch(e => console.log('Sound blocked'));
            } catch(e) { console.log('Sound error'); }
        }
        
        // üî∑ BLUE ITEMS SYSTEM
        const blueItems = [
            { id: 'crystal', name: 'üî∑ Blue Hexagon Crystal', effect: '+200% hexagon power' },
            { id: 'resonator', name: 'üîµ Blue Quantum Resonator', effect: 'Quantum lab boost' },
            { id: 'energy', name: 'üíô Blue Energy Cell', effect: '+500 power level' }
        ];
        
        function createBlueItem() {
            const item = blueItems[Math.random() * blueItems.length | 0];
            addLog(`üî∑ BLUE ITEM CREATED: ${item.name}`, 'success');
            setStatus(`üî∑ New item: ${item.name} - ${item.effect}`);
            playSound('powerup');
            
            // Add to inventory display
            const inventory = document.getElementById('blue-inventory');
            if (inventory) {
                inventory.innerHTML += `<div class="blue-item">${item.name}</div>`;
            }
        }
        
        // üí¨ SYST√àME DE DIALOGUES FLOTTANTS
        const dialogues = {
            'A': [
                '"Bon, on va o√π maintenant ?"',
                '"Ce monde A me para√Æt familier..."',
                '"Vince, tu sens quelque chose ?"',
                '"Les hexagones commencent √† vibrer !"'
            ],
            'B': [
                '"Putain, l\'interstice encore !"',
                '"√áa me rappelle Pulp Fiction..."',
                '"Jules serait fier de moi ici !"',
                '"L\'hexagone pulse de plus en plus fort !"'
            ],
            'C': [
                '"Wow, le labo quantique !"',
                '"Ces instruments sont dingues !"',
                '"Einstein aurait ador√© √ßa !"',
                '"Le Palmier quantique... magnifique !"'
            ]
        };
        
        let currentDialogue = '';
        let dialogueTimer = null;
        
        function showDialogue(worldId) {
            const worldDialogues = dialogues[worldId] || dialogues['A'];
            const randomDialogue = worldDialogues[Math.random() * worldDialogues.length | 0];
            
            currentDialogue = randomDialogue;
            
            // Afficher le dialogue
            const dialogueDiv = document.getElementById('character-dialogue');
            if (dialogueDiv) {
                dialogueDiv.textContent = currentDialogue;
                dialogueDiv.style.display = 'block';
                dialogueDiv.style.opacity = '1';
                
                // Auto-hide apr√®s 4 secondes
                clearTimeout(dialogueTimer);
                dialogueTimer = setTimeout(() => {
                    dialogueDiv.style.opacity = '0';
                    setTimeout(() => {
                        dialogueDiv.style.display = 'none';
                    }, 500);
                }, 4000);
            }
            
            addLog(`üí¨ Dialogue: ${currentDialogue}`, 'info');
        }
        
        // üé≠ DIALOGUE AUTOMATIQUE sur changement de monde
        function changeWorldWithDialogue(targetWorld) {
            changeWorld(targetWorld);
            setTimeout(() => {
                showDialogue(targetWorld);
            }, 1500); // Apr√®s les transitions
        }
        
        // üé≤ DIALOGUE AL√âATOIRE sur clic
        function triggerRandomDialogue() {
            showDialogue(currentWorld);
            playSound('quantum');
        }
        
        // Initialize on load
        window.onload = function() {
            createMap();
            updateHeroStats();
            initDemo();
            
            // Ajouter navigation A‚ÜíB‚ÜíC apr√®s la map
            const container = document.querySelector('.demo-container .main-layout');
            const navHTML = `
                <div class="world-navigation" style="grid-column: 1 / -1; margin-top: 20px;">
                    <h3>üåç Navigation Film Vivant A‚ÜíB‚ÜíC</h3>
                    <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
                        <button onclick="triggerRandomDialogue()" style="
                            background: linear-gradient(45deg, #FFD700, #FFA500);
                            color: #000;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 15px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 5px;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            üí¨ Dialogue
                        </button>
                        
                        <button onclick="changeWorldWithDialogue('A')" style="
                            background: linear-gradient(45deg, #4CAF50, #45a049);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 15px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 5px;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            üó∫Ô∏è Monde A
                        </button>
                        
                        <button onclick="changeWorldWithDialogue('B')" style="
                            background: linear-gradient(45deg, #FF9800, #F57C00);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 15px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 5px;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            üåå Monde B
                        </button>
                        
                        <button onclick="changeWorldWithDialogue('C')" style="
                            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 15px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 5px;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            ‚öõÔ∏è Monde C
                        </button>
                    </div>
                    <p style="text-align: center; color: #ccc; font-size: 0.9em;">
                        üé¨ The Dude Film Vivant - Navigation A ‚Üí B ‚Üí C ‚Üí A (infinie) !
                    </p>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', navHTML);
            
            // Styles pour les boutons navigation
            const style = document.createElement('style');
            style.textContent = `
                .world-btn {
                    background: rgba(0,0,0,0.7);
                    border: 2px solid #4a90e2;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-family: 'Courier New', monospace;
                    text-align: center;
                }
                .world-btn:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
                }
                .world-btn.active {
                    border-color: #ff6b6b;
                    background: rgba(255, 107, 107, 0.2);
                    box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
                }
            `;
            document.head.appendChild(style);
            
            // Message de bienvenue
            addLog('üé¨ Film Vivant activ√© ! Navigation A‚ÜíB‚ÜíC op√©rationnelle', 'success');
            setStatus('üåç Monde A actif - Jean-Grofignon sur son canap√© cosmique');

            // üí¨ DIALOGUE FLOTTANT
            const dialogueDiv = document.getElementById('character-dialogue');
            if (dialogueDiv) {
                dialogueDiv.textContent = "Dialogue ici..."; // Initial text
                dialogueDiv.style.display = 'block';
                dialogueDiv.style.opacity = '1';
            }
        };

        // üßô‚Äç‚ôÇÔ∏è WALTER INTELLIGENT HERO ANALYZER - SYST√àME R√âALISTE DISCRET
        const heroFormulas = {
            'arthur': {
                formulas: ['HEAL_HERO(self, 25)', 'DIVINE_INTERVENTION', 'EXCALIBUR_SLASH'],
                class: 'paladin',
                runicSignature: '·ö®·ö±·ö¶·ö¢·ö±',
                element: 'holy'
            },
            'vince': {
                formulas: ['REALITY_SHOT', 'FOURTH_WALL_BREAK', 'DIMENSIONAL_SHOT'],
                class: 'gunslinger', 
                runicSignature: '·ö¢·õÅ·öæ·õã·õñ',
                element: 'chaos'
            },
            'merlin': {
                formulas: ['METEOR_SHOWER', 'CHAIN_LIGHTNING', 'TELEPORT_HERO'],
                class: 'archimage',
                runicSignature: '·õó·õñ·ö±·õö·õÅ·öæ',
                element: 'arcane'
            }
        };

        // üéØ ANALYSE INTELLIGENTE DES H√âROS - BACKEND TRANSLATION
        async function analyzeHeroIntelligently(heroName) {
            const heroData = heroFormulas[heroName];
            if (!heroData) return null;

            try {
                // Envoyer formules au backend pour traduction
                const translations = [];
                for (const formula of heroData.formulas) {
                    const response = await fetch('http://localhost:8080/api/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: formula,
                            context: { 
                                hero: heroName, 
                                class: heroData.class,
                                element: heroData.element
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        translations.push(result);
                    }
                }

                return {
                    hero: heroName,
                    data: heroData,
                    translations: translations,
                    analyzed: true
                };
            } catch (error) {
                console.log('üîÆ Backend translation offline - using local analysis');
                return {
                    hero: heroName,
                    data: heroData,
                    translations: heroData.formulas.map(f => ({
                        original: f,
                        traduction: f.toLowerCase().replace(/_/g, ' '),
                        type: 'local'
                    })),
                    analyzed: false
                };
            }
        }

        // ‚ú® EFFETS DISCRETS MAIS COOL AUTOUR DES H√âROS
        function displayDiscreteHeroEffects(heroName, analysis) {
            const heroCell = document.querySelector(`[data-hero="${heroName}"]`);
            if (!heroCell) return;

            const heroData = analysis.data;
            
            // Enlever anciens effets
            heroCell.querySelectorAll('.hero-aura, .runic-symbol, .formula-indicator').forEach(el => el.remove());

            // üåü AURA DISCR√àTE selon √©l√©ment
            const aura = document.createElement('div');
            aura.className = 'hero-aura';
            aura.style.cssText = `
                position: absolute;
                top: -2px;
                left: -2px;
                right: -2px;
                bottom: -2px;
                border-radius: 8px;
                pointer-events: none;
                opacity: 0.3;
                animation: gentlePulse 3s ease-in-out infinite;
                ${getElementAuraStyle(heroData.element)}
            `;
            heroCell.appendChild(aura);

            // ·ö±·ö¢·öæ·õÅ·ö≤ SYMBOLE DISCRET
            const runicSymbol = document.createElement('div');
            runicSymbol.className = 'runic-symbol';
            runicSymbol.textContent = heroData.runicSignature;
            runicSymbol.style.cssText = `
                position: absolute;
                top: 1px;
                right: 1px;
                font-size: 8px;
                color: ${getElementColor(heroData.element)};
                text-shadow: 0 0 2px ${getElementColor(heroData.element)};
                opacity: 0.7;
                font-family: 'Courier New', monospace;
                pointer-events: none;
            `;
            heroCell.appendChild(runicSymbol);

            // üìä INDICATEUR DE FORMULES COOL
            const formulaCount = document.createElement('div');
            formulaCount.className = 'formula-indicator';
            formulaCount.textContent = analysis.translations.length;
            formulaCount.style.cssText = `
                position: absolute;
                bottom: 1px;
                left: 1px;
                width: 10px;
                height: 10px;
                background: ${getElementColor(heroData.element)};
                border-radius: 50%;
                font-size: 6px;
                color: white;
                text-align: center;
                line-height: 10px;
                opacity: 0.8;
                box-shadow: 0 0 3px ${getElementColor(heroData.element)};
            `;
            heroCell.appendChild(formulaCount);

            // üéØ HOVER POUR D√âTAILS PAYLOAD
            heroCell.addEventListener('mouseenter', () => showHeroPayloadDetails(heroName, analysis));
            heroCell.addEventListener('mouseleave', () => hideHeroPayloadDetails());
        }

        // üé® STYLES √âL√âMENTAIRES R√âALISTES
        function getElementAuraStyle(element) {
            switch (element) {
                case 'holy': return 'background: linear-gradient(45deg, rgba(255,215,0,0.2), rgba(255,255,255,0.1)); border: 1px solid rgba(255,215,0,0.3);';
                case 'chaos': return 'background: linear-gradient(45deg, rgba(128,0,128,0.2), rgba(255,0,255,0.1)); border: 1px solid rgba(255,0,255,0.3);';
                case 'arcane': return 'background: linear-gradient(45deg, rgba(0,100,255,0.2), rgba(100,200,255,0.1)); border: 1px solid rgba(100,200,255,0.3);';
                default: return 'background: rgba(128,128,128,0.1); border: 1px solid rgba(128,128,128,0.2);';
            }
        }

        function getElementColor(element) {
            switch (element) {
                case 'holy': return '#FFD700';
                case 'chaos': return '#FF00FF'; 
                case 'arcane': return '#64C8FF';
                default: return '#808080';
            }
        }

        // üí´ PAYLOAD DETAILS AU HOVER
        function showHeroPayloadDetails(heroName, analysis) {
            hideHeroPayloadDetails(); // Clear existing

            const details = document.createElement('div');
            details.id = 'hero-payload-details';
            details.style.cssText = `
                position: fixed;
                top: 50%;
                right: 20px;
                transform: translateY(-50%);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 15px;
                border-radius: 10px;
                max-width: 250px;
                font-size: 11px;
                z-index: 1000;
                border: 1px solid ${getElementColor(analysis.data.element)};
                box-shadow: 0 0 10px ${getElementColor(analysis.data.element)};
            `;

            let content = `
                <div style="color: ${getElementColor(analysis.data.element)}; font-weight: bold;">
                    ${analysis.data.runicSignature} ${heroName.toUpperCase()}
                </div>
                <div style="font-size: 9px; opacity: 0.7; margin: 3px 0;">
                    Class: ${analysis.data.class} | Element: ${analysis.data.element}
                </div>
                <hr style="margin: 8px 0; border-color: ${getElementColor(analysis.data.element)};">
                <div style="font-weight: bold; margin-bottom: 5px;">üìú Formulas Analysis:</div>
            `;

            analysis.translations.forEach((trans, i) => {
                const status = analysis.analyzed ? 'üåê' : 'üíª';
                content += `
                    <div style="margin: 3px 0; padding: 3px; background: rgba(255,255,255,0.05); border-radius: 3px;">
                        <div style="color: ${getElementColor(analysis.data.element)};">
                            ${status} ${trans.original || analysis.data.formulas[i]}
                        </div>
                        <div style="font-size: 9px; opacity: 0.8;">
                            ‚Üí ${trans.traduction || 'Local translation'}
                        </div>
                    </div>
                `;
            });

            content += `
                <hr style="margin: 8px 0; border-color: ${getElementColor(analysis.data.element)};">
                <div style="font-size: 9px; opacity: 0.6;">
                    Backend: ${analysis.analyzed ? '‚úÖ Connected' : '‚ùå Offline'}
                </div>
            `;

            details.innerHTML = content;
            document.body.appendChild(details);
        }

        function hideHeroPayloadDetails() {
            const existing = document.getElementById('hero-payload-details');
            if (existing) existing.remove();
        }

        // üöÄ AUTO-ANALYSE DE TOUS LES H√âROS SUR LA MAP
        async function intelligentMapAnalysis() {
            if (window.analysisInProgress) return;
            window.analysisInProgress = true;
            
            const heroNames = ['arthur', 'vince'];
            
            // Mode silencieux pour auto-analyse, verbose pour bouton manuel
            const isManual = event && event.target;
            if (isManual) {
                addLog('üßô‚Äç‚ôÇÔ∏è Walter: Analyse intelligente des h√©ros...', 'info');
            }
            
            for (const heroName of heroNames) {
                const analysis = await analyzeHeroIntelligently(heroName);
                if (analysis) {
                    displayDiscreteHeroEffects(heroName, analysis);
                    if (isManual) {
                        addLog(`‚ú® ${heroName}: ${analysis.translations.length} formules analys√©es`, 'success');
                    }
                }
            }
            
            // üß™ QUANTUM LAB SPECIAL ANALYSIS
            if (currentWorld === 'D') {
                quantumLabObservationEffects();
            }
            
            if (isManual) {
                addLog('üéØ Analyse termin√©e - Effets discrets activ√©s !', 'success');
            }
            
            window.analysisInProgress = false;
        }

        // üß™ LABORATOIRE QUANTIQUE - EFFETS D'OBSERVATION
        function quantumLabObservationEffects() {
            // Artefacts quantiques sp√©ciaux dans le laboratoire
            const quantumArtifacts = [
                { x: 3, y: 3, name: 'eye_of_wigner', symbol: 'üëÅÔ∏è', effect: 'collapse' },
                { x: 7, y: 6, name: 'grofi_flower_seed', symbol: 'üå±', effect: 'growth' },
                { x: 4, y: 8, name: 'codex_infini', symbol: 'üìö', effect: 'superposition' },
                { x: 9, y: 2, name: 'mask_anonymity', symbol: 'üé≠', effect: 'stealth' },
                { x: 1, y: 5, name: 'lensvega_scope', symbol: 'üîç', effect: 'vision' }
            ];

            quantumArtifacts.forEach(artifact => {
                const cell = document.getElementById(`cell-${artifact.x}-${artifact.y}`);
                if (cell && currentWorld === 'D') {
                    // Nettoyer anciens effets
                    cell.querySelectorAll('.quantum-artifact').forEach(el => el.remove());
                    
                    // Ajouter artefact quantique
                    const artifactElement = document.createElement('div');
                    artifactElement.className = 'quantum-artifact';
                    artifactElement.textContent = artifact.symbol;
                    artifactElement.style.cssText = `
                        position: absolute;
                        top: 2px;
                        left: 2px;
                        font-size: 12px;
                        z-index: 5;
                        animation: gentlePulse 2s infinite;
                        cursor: pointer;
                        opacity: 0.8;
                    `;
                    
                    // Observer Effect - click pour interaction
                    artifactElement.addEventListener('click', () => {
                        observeQuantumArtifact(artifact);
                    });
                    
                    // Hover effect pour d√©tails
                    artifactElement.addEventListener('mouseenter', () => {
                        showQuantumArtifactInfo(artifact);
                    });
                    
                    artifactElement.addEventListener('mouseleave', () => {
                        hideQuantumArtifactInfo();
                    });
                    
                    cell.appendChild(artifactElement);
                }
            });

            if (currentWorld === 'D') {
                addLog('üß™ Artefacts quantiques d√©tect√©s dans le laboratoire', 'info');
                addLog('üëÅÔ∏è WALTER: "L\'observation va modifier leur √©tat !"', 'warning');
            }
        }

        // üî¨ OBSERVATION D'ARTEFACT QUANTIQUE
        function observeQuantumArtifact(artifact) {
            addLog(`üîç Observation de ${artifact.name}...`, 'info');
            
            // Effets d'observation selon le type
            switch (artifact.effect) {
                case 'collapse':
                    addLog('üëÅÔ∏è COLLAPSE œà ‚Üí ‚Ä†: L\'artefact s\'effondre en r√©alit√© unique !', 'warning');
                    setStatus('üßô‚Äç‚ôÇÔ∏è WALTER: "L\'≈íil de Wigner a provoqu√© un collapse quantique !"');
                    break;
                case 'growth':
                    addLog('üå± GROWTH: La graine r√©agit √† votre intention et grandit !', 'success');
                    setStatus('üå∏ GROFI-Pens√©e: "Votre regard nourrit ma croissance !"');
                    break;
                case 'superposition':
                    addLog('üìö SUPERPOSITION ‚äô: Le Codex r√©v√®le plusieurs r√©alit√©s simultan√©es !', 'info');
                    setStatus('üìñ Codex: "Lecture = Modification de la superposition active"');
                    break;
                case 'stealth':
                    addLog('üé≠ STEALTH: Le masque vous rend invisible aux regards non-l√©gitimes !', 'success');
                    setStatus('üé≠ Masque: "Invisibilit√© quantique activ√©e"');
                    break;
                case 'vision':
                    addLog('üîç VISION: La lentille Vega manipule votre ligne de vision !', 'warning');
                    setStatus('üîç LensVega: "Collapse local d√©tect√© dans votre champ visuel"');
                    break;
            }

            // Effet visuel d'observation
            const cell = document.getElementById(`cell-${artifact.x}-${artifact.y}`);
            if (cell) {
                cell.style.background = 'radial-gradient(circle, rgba(0,255,136,0.8), transparent)';
                cell.style.animation = 'quantumCollapse 1s ease-out';
                
                setTimeout(() => {
                    cell.style.background = '';
                    cell.style.animation = '';
                }, 1000);
            }
        }

        // üìä INFO ARTEFACT QUANTIQUE AU HOVER
        function showQuantumArtifactInfo(artifact) {
            hideQuantumArtifactInfo();
            
            const info = document.createElement('div');
            info.id = 'quantum-artifact-info';
            info.style.cssText = `
                position: fixed;
                top: 20%;
                right: 20px;
                background: rgba(0,0,0,0.9);
                color: #00ff88;
                padding: 15px;
                border-radius: 10px;
                max-width: 200px;
                font-size: 11px;
                z-index: 1000;
                border: 1px solid #00ff88;
                box-shadow: 0 0 15px #00ff88;
            `;
            
            const descriptions = {
                'eye_of_wigner': 'Provoque collapse par regard conscient. Attention aux paradoxes !',
                'grofi_flower_seed': 'Croissance v√©g√©tale selon intention observateur. Symbiose active.',
                'codex_infini': 'Modifie superposition par lecture. R√©alit√©s multiples accessibles.',
                'mask_anonymity': 'Invisibilit√© aux regards l√©gitimes. Protection quantique.',
                'lensvega_scope': 'Manipule ligne vision et collapses locaux. Usage expert.'
            };
            
            info.innerHTML = `
                <div style="color: #00ff88; font-weight: bold; margin-bottom: 8px;">
                    ${artifact.symbol} ${artifact.name.toUpperCase()}
                </div>
                <div style="font-size: 9px; opacity: 0.8; margin-bottom: 8px;">
                    Type: ${artifact.effect} | Status: Stable
                </div>
                <hr style="border-color: #00ff88; margin: 8px 0;">
                <div style="font-size: 10px;">
                    ${descriptions[artifact.name]}
                </div>
                <div style="font-size: 8px; opacity: 0.6; margin-top: 8px;">
                    üßô‚Äç‚ôÇÔ∏è Click pour observer
                </div>
            `;
            
            document.body.appendChild(info);
        }

        function hideQuantumArtifactInfo() {
            const existing = document.getElementById('quantum-artifact-info');
            if (existing) existing.remove();
        }
    </script>
</body>
</html> 