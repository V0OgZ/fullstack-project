#!/bin/bash

echo "üè∞ HEROES OF TIME - TEST COMPLET HEROES OF MIGHT & MAGIC 3"
echo "==========================================================="

# V√©rification du backend
echo "üì° V√©rification du backend..."
BACKEND_CHECK=$(curl -s "http://localhost:8080/api/temporal/health" | grep -o '"status":"healthy"')
if [ "$BACKEND_CHECK" != '"status":"healthy"' ]; then
    echo "‚ùå Backend non disponible"
    exit 1
fi
echo "‚úÖ Backend op√©rationnel"

# Cr√©ation d'un jeu
echo ""
echo "üé≤ Cr√©ation d'un nouveau jeu Heroes of Might & Magic..."
GAME_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games" \
    -H "Content-Type: application/json" \
    -d '{"gameName": "HMM3 Complete Test", "playerId": "player1"}')

GAME_ID=$(echo "$GAME_RESPONSE" | grep -o '"gameId":[0-9]*' | cut -d':' -f2)
if [ -z "$GAME_ID" ]; then
    echo "‚ùå Impossible de cr√©er le jeu"
    exit 1
fi
echo "‚úÖ Jeu cr√©√© avec l'ID: $GAME_ID"

# D√©marrage du jeu
echo ""
echo "üöÄ D√©marrage du jeu..."
START_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/start" \
    -H "Content-Type: application/json")
echo "‚úÖ Jeu d√©marr√©"

echo ""
echo "üè∞ PARTIE I: SYST√àME DE VILLES ET CH√ÇTEAUX"
echo "=========================================="

# Construction de ch√¢teau
echo "üè∞ Construction d'un ch√¢teau"
CASTLE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "BUILD(CASTLE, @20,20, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$CASTLE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Construction de tour de guet
echo "üóº Construction d'une tour de guet"
TOWER_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "BUILD(WATCHTOWER, @22,22, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$TOWER_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Construction de mine d'or
echo "‚ö±Ô∏è Construction d'une mine d'or"
MINE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "BUILD(GOLD_MINE, @18,18, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$MINE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Construction de temple
echo "‚õ™ Construction d'un temple"
TEMPLE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "BUILD(TEMPLE, @16,16, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$TEMPLE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "üí∞ PARTIE II: SYST√àME DE RESSOURCES"
echo "===================================="

# Collecter de l'or
echo "ü™ô Collecte d'or"
GOLD_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "COLLECT(RESOURCE, GOLD, 1000, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$GOLD_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Collecter du bois
echo "ü™µ Collecte de bois"
WOOD_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "COLLECT(RESOURCE, WOOD, 500, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$WOOD_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Collecter de la pierre
echo "ü™® Collecte de pierre"
STONE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "COLLECT(RESOURCE, STONE, 300, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$STONE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Collecter des gemmes
echo "üíé Collecte de gemmes"
GEMS_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "COLLECT(RESOURCE, GEMS, 100, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$GEMS_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "ü¶∏ PARTIE III: H√âROS ET COMP√âTENCES"
echo "==================================="

# Cr√©ation de h√©ros avec classes
echo "ü¶∏ Cr√©ation d'Arthur (Chevalier)"
ARTHUR_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "HERO(Arthur, CLASS:KNIGHT, LEVEL:1)"}')
echo "   R√©sultat: $(echo "$ARTHUR_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Cr√©ation de mage
echo "üßô Cr√©ation de Morgana (Sorci√®re)"
MORGANA_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "HERO(Morgana, CLASS:SORCERESS, LEVEL:1)"}')
echo "   R√©sultat: $(echo "$MORGANA_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Mont√©e de niveau
echo "‚¨ÜÔ∏è Mont√©e de niveau d'Arthur"
LEVELUP_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "LEVELUP(Arthur, SKILL:LEADERSHIP)"}')
echo "   R√©sultat: $(echo "$LEVELUP_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Apprentissage de sorts
echo "üìú Apprentissage de sort de feu"
SPELL_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "LEARN(SPELL, FIREBALL, HERO:Morgana)"}')
echo "   R√©sultat: $(echo "$SPELL_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "‚öîÔ∏è PARTIE IV: ARM√âES ET CR√âATURES"
echo "================================="

# Recrutement d'unit√©s
echo "üõ°Ô∏è Recrutement d'√©p√©istes"
SWORDSMEN_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "RECRUIT(UNIT, SWORDSMEN, 20, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$SWORDSMEN_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Recrutement d'archers
echo "üèπ Recrutement d'archers"
ARCHERS_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "RECRUIT(UNIT, ARCHERS, 15, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$ARCHERS_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Recrutement de cavalerie
echo "üêé Recrutement de cavalerie"
CAVALRY_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "RECRUIT(UNIT, CAVALRY, 10, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$CAVALRY_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Recrutement de dragon
echo "üêâ Recrutement de dragon"
DRAGON_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "RECRUIT(UNIT, DRAGON, 1, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$DRAGON_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "‚ö° PARTIE V: MAGIE ET SORTS"
echo "=========================="

# Lancement de sort de d√©g√¢ts
echo "üî• Lancement de boule de feu"
FIREBALL_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "CAST(SPELL, FIREBALL, TARGET:@25,25, HERO:Morgana)"}')
echo "   R√©sultat: $(echo "$FIREBALL_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Sort de gu√©rison
echo "üíö Sort de gu√©rison"
HEAL_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "CAST(SPELL, HEAL, TARGET:HERO:Arthur, HERO:Morgana)"}')
echo "   R√©sultat: $(echo "$HEAL_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Sort d'augmentation
echo "‚ö° Sort d'augmentation (B√©n√©diction)"
BLESS_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "CAST(SPELL, BLESS, TARGET:UNIT:SWORDSMEN, HERO:Morgana)"}')
echo "   R√©sultat: $(echo "$BLESS_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "üó∫Ô∏è PARTIE VI: EXPLORATION ET AVENTURE"
echo "======================================"

# Exploration de terrain
echo "üîç Exploration de terrain"
EXPLORE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "EXPLORE(TERRAIN, @30,30, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$EXPLORE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# D√©couverte de tr√©sor
echo "üí∞ D√©couverte de tr√©sor"
TREASURE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "DISCOVER(TREASURE, @32,32, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$TREASURE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Visite de lieu mystique
echo "üîÆ Visite de lieu mystique"
MYSTICAL_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "VISIT(MYSTICAL_PLACE, @35,35, HERO:Morgana)"}')
echo "   R√©sultat: $(echo "$MYSTICAL_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "üõ°Ô∏è PARTIE VII: √âQUIPEMENT ET ARTEFACTS"
echo "======================================="

# √âquipement d'artefact
echo "‚öîÔ∏è √âquipement d'√©p√©e magique"
SWORD_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "EQUIP(ARTIFACT, MAGIC_SWORD, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$SWORD_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# √âquipement d'armure
echo "üõ°Ô∏è √âquipement d'armure de plates"
ARMOR_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "EQUIP(ARTIFACT, PLATE_ARMOR, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$ARMOR_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# √âquipement d'anneau magique
echo "üíç √âquipement d'anneau de pouvoir"
RING_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "EQUIP(ARTIFACT, POWER_RING, HERO:Morgana)"}')
echo "   R√©sultat: $(echo "$RING_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "üåÄ PARTIE VIII: √âL√âMENTS TEMPORELS H√âROS OF TIME"
echo "==============================================="

# Cr√©ation d'√©tats temporels avec arm√©e
echo "üåÄ Superposition temporelle avec arm√©e"
PSI_ARMY_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "œà001: ‚äô(Œît+3 @40,40 ‚ü∂ BATTLE(ARMY:Arthur, ARMY:Enemy))"}')
echo "   R√©sultat: $(echo "$PSI_ARMY_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Superposition de construction
echo "üèóÔ∏è Superposition de construction"
PSI_BUILD_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "œà002: ‚äô(Œît+2 @38,38 ‚ü∂ BUILD(FORTRESS, @38,38, PLAYER:player1))"}')
echo "   R√©sultat: $(echo "$PSI_BUILD_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Trigger d'observation √©conomique
echo "üéØ Trigger d'observation √©conomique"
TRIGGER_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "Œ†(GOLD > 5000) ‚áí ‚Ä†œà001"}')
echo "   R√©sultat: $(echo "$TRIGGER_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "‚öîÔ∏è PARTIE IX: COMBAT ET TACTIQUE"
echo "==============================="

# Combat d'arm√©e
echo "‚öîÔ∏è Combat d'arm√©e compl√®te"
ARMY_BATTLE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "BATTLE(ARMY:Arthur, ARMY:NeutralGuards, LOCATION:@45,45)"}')
echo "   R√©sultat: $(echo "$ARMY_BATTLE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# Si√®ge de ch√¢teau
echo "üè∞ Si√®ge de ch√¢teau"
SIEGE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "SIEGE(CASTLE, @50,50, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$SIEGE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "üèÜ PARTIE X: VICTOIRE ET OBJECTIFS"
echo "================================="

# Capture d'objectif
echo "üéØ Capture d'objectif"
CAPTURE_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "CAPTURE(OBJECTIVE, MAIN_CASTLE, HERO:Arthur)"}')
echo "   R√©sultat: $(echo "$CAPTURE_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

# V√©rification de victoire
echo "üëë V√©rification des conditions de victoire"
VICTORY_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/temporal/games/$GAME_ID/script" \
    -H "Content-Type: application/json" \
    -d '{"script": "CHECK(VICTORY, PLAYER:player1)"}')
echo "   R√©sultat: $(echo "$VICTORY_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)"

echo ""
echo "üéâ TEST COMPLET TERMIN√â !"
echo "========================"

echo ""
echo "üèÜ R√âSUM√â DES FONCTIONNALIT√âS HEROES OF MIGHT & MAGIC 3 TEST√âES:"
echo "================================================================="
echo "‚îú‚îÄ üè∞ Syst√®me de villes: Ch√¢teaux, tours, mines, temples"
echo "‚îú‚îÄ üí∞ Ressources: Or, bois, pierre, gemmes"
echo "‚îú‚îÄ ü¶∏ H√©ros: Classes, niveaux, comp√©tences"
echo "‚îú‚îÄ ‚öîÔ∏è Arm√©es: √âp√©istes, archers, cavalerie, dragons"
echo "‚îú‚îÄ ‚ö° Magie: Sorts d'attaque, gu√©rison, augmentation"
echo "‚îú‚îÄ üó∫Ô∏è Exploration: Terrain, tr√©sors, lieux mystiques"
echo "‚îú‚îÄ üõ°Ô∏è √âquipement: Artefacts, armes, armures"
echo "‚îú‚îÄ üåÄ √âl√©ments temporels: œà-states avec arm√©es"
echo "‚îú‚îÄ ‚öîÔ∏è Combat: Batailles, si√®ges"
echo "‚îî‚îÄ üèÜ Victoire: Objectifs, conditions de fin"

echo ""
echo "üéÆ Game ID utilis√©: $GAME_ID"
echo "üåê Backend API: http://localhost:8080/api/temporal/health"
echo "üöÄ Heroes of Time - Version compl√®te Heroes of Might & Magic 3 + Temporel!" 